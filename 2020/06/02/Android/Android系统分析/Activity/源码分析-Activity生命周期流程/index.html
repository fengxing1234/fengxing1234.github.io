<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Android,Android系统分析,Activity生命周期," />










<meta name="description" content="概述Activity 经典生命周期图：   不要在onCreate，onStart，onResume，onPause几个方法进行耗时操作，否则会造成页面切换卡顿。 Activity的四种状态Activity的生命周期中存在四种基本的状态：  活动状态(Active&#x2F;Runing) 暂停状态(Paused) 停止状态(Stopped) 销毁状态(Killed)。  活动状态一个新的Activity入">
<meta property="og:type" content="article">
<meta property="og:title" content="源码分析-Activity生命周期流程">
<meta property="og:url" content="http://yoursite.com/2020/06/02/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Activity/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-Activity%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%B5%81%E7%A8%8B/index.html">
<meta property="og:site_name" content="冯星的博客">
<meta property="og:description" content="概述Activity 经典生命周期图：   不要在onCreate，onStart，onResume，onPause几个方法进行耗时操作，否则会造成页面切换卡顿。 Activity的四种状态Activity的生命周期中存在四种基本的状态：  活动状态(Active&#x2F;Runing) 暂停状态(Paused) 停止状态(Stopped) 销毁状态(Killed)。  活动状态一个新的Activity入">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/4118241-9ceca5ca67e6e73f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/4118241-cc817b0ebc885e28.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="article:published_time" content="2020-06-02T12:41:53.000Z">
<meta property="article:modified_time" content="2020-06-02T16:19:30.036Z">
<meta property="article:author" content="冯星">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Android系统分析">
<meta property="article:tag" content="Activity生命周期">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/4118241-9ceca5ca67e6e73f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/06/02/Android/Android系统分析/Activity/源码分析-Activity生命周期流程/"/>





  <title>源码分析-Activity生命周期流程 | 冯星的博客</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">冯星的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Life is like a Markov chain, your future only depends on what you are doing now, and independent of your past.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/02/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Activity/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-Activity%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="冯星">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冯星的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">源码分析-Activity生命周期流程</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-02T20:41:53+08:00">
                2020-06-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/" itemprop="url" rel="index">
                    <span itemprop="name">Android系统分析</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Activity/" itemprop="url" rel="index">
                    <span itemprop="name">Activity</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/06/02/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Activity/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-Activity%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%B5%81%E7%A8%8B/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/06/02/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Activity/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-Activity%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%B5%81%E7%A8%8B/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>Activity 经典生命周期图：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/4118241-9ceca5ca67e6e73f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/4118241-cc817b0ebc885e28.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>不要在<code>onCreate，onStart，onResume，onPause</code>几个方法进行耗时操作，否则会造成页面切换卡顿。</p>
<h2 id="Activity的四种状态"><a href="#Activity的四种状态" class="headerlink" title="Activity的四种状态"></a>Activity的四种状态</h2><p>Activity的生命周期中存在四种基本的状态：</p>
<ul>
<li>活动状态(Active/Runing)</li>
<li>暂停状态(Paused)</li>
<li>停止状态(Stopped)</li>
<li>销毁状态(Killed)。</li>
</ul>
<h3 id="活动状态"><a href="#活动状态" class="headerlink" title="活动状态"></a>活动状态</h3><p>一个新的Activity入栈后，当处于Activity栈顶时，此事它处于可见并且能与用户进行交互。</p>
<ul>
<li>期间触发的生命周期：<code>onCreate()-&gt; onStart()-&gt; onResume()</code></li>
</ul>
<h3 id="暂停状态"><a href="#暂停状态" class="headerlink" title="暂停状态"></a>暂停状态</h3><p>当Activity失去焦点，一个新的非全屏Activity或者透明的Activity被放置栈顶，此时处于暂停状态。一个处于暂定状态的Activity只有在系统极度匮乏的时候才会被回收掉。</p>
<p>在Activity之上显示dialog对话框或者<code>PopupWindow</code>该Activity并不会变成暂停状态。<br>当下拉通知栏时，Activity会走什么生命周期?以及弹出Dialog时会走什么生命周期?关于这两知识点，今天特意写了一下，发现啥都没走，也就说任何生命周期都不会走，也简单查了一下原因，下拉通知栏因为是系统窗口，所以不影响activity的生命周期，Dialog或者Toast源码中也能看windowmanager.addView()，也就说都是和系统管理者有关系，不会影响到本应用。</p>
<ul>
<li>运行状态到暂停状态触发的生命周期：<code>onResume() --&gt; onPause()</code>。</li>
<li>从暂停状态恢复到运行状态触发的生命周期：<code>onPause() -&gt; onResume()</code>。</li>
</ul>
<h3 id="停止状态"><a href="#停止状态" class="headerlink" title="停止状态"></a>停止状态</h3><p>一个Activity完全被另一个Activity完全覆盖或者，用户不可见或者退到后台，叫做停止状态。它仍保存着所有状态和成员信息，不能和用户交互，当系统内存需要的时候Stopped状态的Activity会被强制回收掉。</p>
<ul>
<li>从暂停状态到停止状态经过的生命周期：<code>onPause()--&gt;onStop()</code></li>
<li>从停止状态到运行状态经过的生命周期：<code>onStop() --&gt; onRestart() --&gt; onStart() --&gt; onResume()</code>。不会走onCreate()方法。</li>
</ul>
<h3 id="销毁状态"><a href="#销毁状态" class="headerlink" title="销毁状态"></a>销毁状态</h3><p>如果一个Activity再Paused或者Stopped状态，系统可以将Activity从内存中删除，删除的方式有两种：一种是要求Activity结束，一种直接结束掉它的进程。当有需要的时候就得重新创建Activity了。</p>
<p>触发的生命周期：onDestroy()，直接结束进程的话是不会走onDestroy()的。</p>
<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><p>在开启Activity流程分析时说过，开启Activity会经过<code>ActivityStackSupervisor#realStartActivityLocked()</code>方法，然后经过一些列流程最终调用<code>onCreate</code>方法，其实其它生命周期也是类似的。</p>
<h2 id="ActivityStackSupervisor"><a href="#ActivityStackSupervisor" class="headerlink" title="ActivityStackSupervisor"></a><code>ActivityStackSupervisor</code></h2><h3 id="realStartActivityLocked"><a href="#realStartActivityLocked" class="headerlink" title="realStartActivityLocked()"></a><code>realStartActivityLocked()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">final boolean realStartActivityLocked(ActivityRecord r, ProcessRecord app,</span><br><span class="line">            boolean andResume, boolean checkConfig) throws RemoteException &#123;</span><br><span class="line">            ...</span><br><span class="line">            &#x2F;&#x2F; Create activity launch transaction.</span><br><span class="line">                final ClientTransaction clientTransaction &#x3D; ClientTransaction.obtain(app.thread,</span><br><span class="line">                        r.appToken);</span><br><span class="line">                 &#x2F;&#x2F; 添加 LaunchActivityItem</span><br><span class="line">                clientTransaction.addCallback(LaunchActivityItem.obtain(new Intent(r.intent),</span><br><span class="line">                        System.identityHashCode(r), r.info,</span><br><span class="line">                        &#x2F;&#x2F; TODO: Have this take the merged configuration instead of separate global</span><br><span class="line">                        &#x2F;&#x2F; and override configs.</span><br><span class="line">                        mergedConfiguration.getGlobalConfiguration(),</span><br><span class="line">                        mergedConfiguration.getOverrideConfiguration(), r.compat,</span><br><span class="line">                        r.launchedFromPackage, task.voiceInteractor, app.repProcState, r.icicle,</span><br><span class="line">                        r.persistentState, results, newIntents, mService.isNextTransitionForward(),</span><br><span class="line">                        profilerInfo));</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; Set desired final state.</span><br><span class="line">                final ActivityLifecycleItem lifecycleItem;</span><br><span class="line">                if (andResume) &#123;</span><br><span class="line">                    lifecycleItem &#x3D; ResumeActivityItem.obtain(mService.isNextTransitionForward());</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    lifecycleItem &#x3D; PauseActivityItem.obtain();</span><br><span class="line">                &#125;</span><br><span class="line">                &#x2F;&#x2F; 2. 设置生命周期状态 这里是开启resume的关键，类型：ResumeActivityItem</span><br><span class="line">                clientTransaction.setLifecycleStateRequest(lifecycleItem);</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; Schedule transaction.</span><br><span class="line">                &#x2F;&#x2F;执行生命周期</span><br><span class="line">                mService.getLifecycleManager().scheduleTransaction(clientTransaction);</span><br><span class="line">                ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先还是看<code>mService.getLifecycleManager()</code></p>
<h2 id="AMS中"><a href="#AMS中" class="headerlink" title="AMS中"></a>AMS中</h2><h3 id="getLifecycleManager"><a href="#getLifecycleManager" class="headerlink" title="getLifecycleManager()"></a><code>getLifecycleManager()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ClientLifecycleManager getLifecycleManager() &#123;</span><br><span class="line">        return mLifecycleManager;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>返回ClientLifecycleManager对象，然后调用<code>scheduleTransaction()</code></p>
<h2 id="ClientLifecycleManager"><a href="#ClientLifecycleManager" class="headerlink" title="ClientLifecycleManager"></a><code>ClientLifecycleManager</code></h2><h3 id="scheduleTransaction"><a href="#scheduleTransaction" class="headerlink" title="scheduleTransaction()"></a><code>scheduleTransaction()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">void scheduleTransaction(ClientTransaction transaction) throws RemoteException &#123;</span><br><span class="line">        final IApplicationThread client &#x3D; transaction.getClient();</span><br><span class="line">        transaction.schedule();</span><br><span class="line">        if (!(client instanceof Binder)) &#123;</span><br><span class="line">            &#x2F;&#x2F; If client is not an instance of Binder - it&#39;s a remote call and at this point it is</span><br><span class="line">            &#x2F;&#x2F; safe to recycle the object. All objects used for local calls will be recycled after</span><br><span class="line">            &#x2F;&#x2F; the transaction is executed on client in ActivityThread.</span><br><span class="line">            transaction.recycle();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="ClientTransaction"><a href="#ClientTransaction" class="headerlink" title="ClientTransaction"></a><code>ClientTransaction</code></h2><h3 id="schedule"><a href="#schedule" class="headerlink" title="schedule()"></a><code>schedule()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void schedule() throws RemoteException &#123;</span><br><span class="line">        mClient.scheduleTransaction(this);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>调用<code>mClient</code>中<code>scheduleTransaction</code>方法，<code>mClient</code>是<code>IApplicationThread</code>,是<code>ActivityThread</code>内部类.</p>
<h2 id="ActivityThread-IApplicationThread"><a href="#ActivityThread-IApplicationThread" class="headerlink" title="ActivityThread#IApplicationThread"></a><code>ActivityThread#IApplicationThread</code></h2><p><code>IApplicationThread</code> 是极其重要的一个 Binder 接口，它维护了应用进程和 AMS 的之间的通讯。这个 <code>mClient</code> 就是应用进程在 AMS 进程中的代理对象，AMS 通过 <code>mClient</code> 来指挥应用进程。</p>
<h3 id="scheduleTransaction-1"><a href="#scheduleTransaction-1" class="headerlink" title="scheduleTransaction()"></a><code>scheduleTransaction()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">        public void scheduleTransaction(ClientTransaction transaction) throws RemoteException &#123;</span><br><span class="line">            ActivityThread.this.scheduleTransaction(transaction);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>调用<code>ActivityThread</code>中<code>scheduleTransaction</code>方法</p>
<h2 id="ActivityThread"><a href="#ActivityThread" class="headerlink" title="ActivityThread"></a><code>ActivityThread</code></h2><h3 id="scheduleTransaction-2"><a href="#scheduleTransaction-2" class="headerlink" title="scheduleTransaction()"></a><code>scheduleTransaction()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void scheduleTransaction(ClientTransaction transaction) &#123;</span><br><span class="line">        transaction.preExecute(this);</span><br><span class="line">        sendMessage(ActivityThread.H.EXECUTE_TRANSACTION, transaction);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>线程间通讯，我们找到EXECUTE_TRANSACTION对应的实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">case EXECUTE_TRANSACTION:</span><br><span class="line">                    final ClientTransaction transaction &#x3D; (ClientTransaction) msg.obj;</span><br><span class="line">                    mTransactionExecutor.execute(transaction);</span><br><span class="line">                    if (isSystem()) &#123;</span><br><span class="line">                        &#x2F;&#x2F; Client transactions inside system process are recycled on the client side</span><br><span class="line">                        &#x2F;&#x2F; instead of ClientLifecycleManager to avoid being cleared before this</span><br><span class="line">                        &#x2F;&#x2F; message is handled.</span><br><span class="line">                        transaction.recycle();</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#x2F;&#x2F; TODO(lifecycler): Recycle locally scheduled transactions.</span><br></pre></td></tr></table></figure>

<h2 id="TransactionExecutor"><a href="#TransactionExecutor" class="headerlink" title="TransactionExecutor"></a><code>TransactionExecutor</code></h2><h3 id="execute"><a href="#execute" class="headerlink" title="execute()"></a><code>execute()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public void execute(ClientTransaction transaction) &#123;</span><br><span class="line">        final IBinder token &#x3D; transaction.getActivityToken();</span><br><span class="line">        log(&quot;Start resolving transaction for client: &quot; + mTransactionHandler + &quot;, token: &quot; + token);</span><br><span class="line">				&#x2F;&#x2F;在这里执行onCreate()</span><br><span class="line">        executeCallbacks(transaction);</span><br><span class="line">				&#x2F;&#x2F;在这里执行onResume onStart()</span><br><span class="line">        executeLifecycleState(transaction);</span><br><span class="line">        mPendingActions.clear();</span><br><span class="line">        log(&quot;End resolving transaction&quot;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>其实在之前的文章已经讲过onCreate是如何执行的了，这里就当预习了,<code>executeCallbacks</code>就不说了,最后执行<code>onCreate</code>,其实流程是差不多的</p>
<h3 id="executeLifecycleState"><a href="#executeLifecycleState" class="headerlink" title="executeLifecycleState()"></a><code>executeLifecycleState()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private void executeLifecycleState(ClientTransaction transaction) &#123;</span><br><span class="line">        final ActivityLifecycleItem lifecycleItem &#x3D; transaction.getLifecycleStateRequest();</span><br><span class="line">        ...</span><br><span class="line">        &#x2F;&#x2F;执行的是onStart</span><br><span class="line">        cycleToPath(r, lifecycleItem.getTargetState(), true &#x2F;* excludeLastState *&#x2F;);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Execute the final transition with proper parameters.</span><br><span class="line">        &#x2F;&#x2F;onResume</span><br><span class="line">        lifecycleItem.execute(mTransactionHandler, token, mPendingActions);</span><br><span class="line">        lifecycleItem.postExecute(mTransactionHandler, token, mPendingActions);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>transaction.getLifecycleStateRequest()</code>是在前头传入的<code>ResumeActivityItem</code>，我们直接看<code>execute</code>方法，<code>cycleToPath</code>稍后在说</p>
<h2 id="ResumeActivityItem"><a href="#ResumeActivityItem" class="headerlink" title="ResumeActivityItem"></a><code>ResumeActivityItem</code></h2><h3 id="execute-1"><a href="#execute-1" class="headerlink" title="execute()"></a><code>execute()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public void execute(ClientTransactionHandler client, IBinder token,</span><br><span class="line">            PendingTransactionActions pendingActions) &#123;</span><br><span class="line">        Trace.traceBegin(TRACE_TAG_ACTIVITY_MANAGER, &quot;activityResume&quot;);</span><br><span class="line">        client.handleResumeActivity(token, true &#x2F;* finalStateRequest *&#x2F;, mIsForward,</span><br><span class="line">                &quot;RESUME_ACTIVITY&quot;);</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>ClientTransactionHandler</code>是一个抽象类，具体实现是<code>ActivityThread</code></p>
<h2 id="ActivityThread-1"><a href="#ActivityThread-1" class="headerlink" title="ActivityThread"></a><code>ActivityThread</code></h2><p><code>handleResumeActivity</code>类似于这种方法还有很多，例如：<code>handlePauseActivity</code>,<code>handleStopActivity</code>等等。对应的Activity的生命周期.</p>
<h3 id="handleResumeActivity"><a href="#handleResumeActivity" class="headerlink" title="handleResumeActivity()"></a><code>handleResumeActivity()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public void handleResumeActivity(IBinder token, boolean finalStateRequest, boolean isForward,</span><br><span class="line">            String reason) &#123;</span><br><span class="line">        ...</span><br><span class="line">        final ActivityClientRecord r &#x3D; performResumeActivity(token, finalStateRequest, reason);</span><br><span class="line">        ...</span><br><span class="line">       Looper.myQueue().addIdleHandler(new Idler());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="performResumeActivity"><a href="#performResumeActivity" class="headerlink" title="performResumeActivity()"></a><code>performResumeActivity()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public ActivityClientRecord performResumeActivity(IBinder token, boolean finalStateRequest,</span><br><span class="line">            String reason) &#123;</span><br><span class="line">        final ActivityClientRecord r &#x3D; mActivities.get(token);</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">        r.activity.performResume(r.startsNotResumed, reason);</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后调用的Activity中的<code>performResume</code></p>
<h2 id="Activity"><a href="#Activity" class="headerlink" title="Activity"></a><code>Activity</code></h2><h3 id="performResume"><a href="#performResume" class="headerlink" title="performResume()"></a><code>performResume()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">final void performResume(boolean followedByPause, String reason) &#123;</span><br><span class="line">				&#x2F;&#x2F;执行onRestart生命周期</span><br><span class="line">        performRestart(true &#x2F;* start *&#x2F;, reason);</span><br><span class="line">        mFragments.execPendingActions();</span><br><span class="line">				&#x2F;&#x2F;执行onResume</span><br><span class="line">        mInstrumentation.callActivityOnResume(this);        </span><br><span class="line">        ...</span><br><span class="line">        mFragments.dispatchResume();</span><br><span class="line">        mFragments.execPendingActions();</span><br><span class="line"></span><br><span class="line">        onPostResume();</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="onRestart"><a href="#onRestart" class="headerlink" title="onRestart"></a><code>onRestart</code></h1><h3 id="performRestart"><a href="#performRestart" class="headerlink" title="performRestart()"></a><code>performRestart()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">final void performRestart(boolean start, String reason) &#123;</span><br><span class="line">			...</span><br><span class="line">			mInstrumentation.callActivityOnRestart(this);</span><br><span class="line">			...</span><br><span class="line">			if (start) &#123;</span><br><span class="line">			&#x2F;&#x2F;最后执行onStart</span><br><span class="line">                performStart(reason);</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里会通过<code>Instrumentation</code>执行<code>onRestart</code></p>
<p><code>performStart</code>执行<code>onStart</code>后面说</p>
<h2 id="Instrumentation"><a href="#Instrumentation" class="headerlink" title="Instrumentation"></a><code>Instrumentation</code></h2><h3 id="callActivityOnRestart"><a href="#callActivityOnRestart" class="headerlink" title="callActivityOnRestart()"></a><code>callActivityOnRestart()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">activity.onRestart();</span><br></pre></td></tr></table></figure>

<p>就这一行代码但是已经足够了</p>
<h2 id="Activity-1"><a href="#Activity-1" class="headerlink" title="Activity"></a><code>Activity</code></h2><h3 id="onRestart-1"><a href="#onRestart-1" class="headerlink" title="onRestart"></a><code>onRestart</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protected void onRestart() &#123;</span><br><span class="line">        mCalled &#x3D; true;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>到此onRestart便完成了。</p>
<h1 id="onResume"><a href="#onResume" class="headerlink" title="onResume"></a><code>onResume</code></h1><p>回到<code>performResume()</code>方法执行<code>mInstrumentation.callActivityOnResume(this);</code></p>
<p>道理是一样的使用<code>Instrumentation</code>执行<code>onResume</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public void callActivityOnResume(Activity activity) &#123;</span><br><span class="line">        activity.mResumed &#x3D; true;</span><br><span class="line">        activity.onResume();</span><br><span class="line">        </span><br><span class="line">        if (mActivityMonitors !&#x3D; null) &#123;</span><br><span class="line">            synchronized (mSync) &#123;</span><br><span class="line">                final int N &#x3D; mActivityMonitors.size();</span><br><span class="line">                for (int i&#x3D;0; i&lt;N; i++) &#123;</span><br><span class="line">                    final ActivityMonitor am &#x3D; mActivityMonitors.get(i);</span><br><span class="line">                    am.match(activity, activity, activity.getIntent());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">protected void onResume() &#123;</span><br><span class="line">        if (DEBUG_LIFECYCLE) Slog.v(TAG, &quot;onResume &quot; + this);</span><br><span class="line">        getApplication().dispatchActivityResumed(this);</span><br><span class="line">        mActivityTransitionState.onResume(this, isTopOfTask());</span><br><span class="line">        if (mAutoFillResetNeeded) &#123;</span><br><span class="line">            if (!mAutoFillIgnoreFirstResumePause) &#123;</span><br><span class="line">                View focus &#x3D; getCurrentFocus();</span><br><span class="line">                if (focus !&#x3D; null &amp;&amp; focus.canNotifyAutofillEnterExitEvent()) &#123;</span><br><span class="line">                    &#x2F;&#x2F; TODO: in Activity killed&#x2F;recreated case, i.e. SessionLifecycleTest#</span><br><span class="line">                    &#x2F;&#x2F; testDatasetVisibleWhileAutofilledAppIsLifecycled: the View&#39;s initial</span><br><span class="line">                    &#x2F;&#x2F; window visibility after recreation is INVISIBLE in onResume() and next frame</span><br><span class="line">                    &#x2F;&#x2F; ViewRootImpl.performTraversals() changes window visibility to VISIBLE.</span><br><span class="line">                    &#x2F;&#x2F; So we cannot call View.notifyEnterOrExited() which will do nothing</span><br><span class="line">                    &#x2F;&#x2F; when View.isVisibleToUser() is false.</span><br><span class="line">                    getAutofillManager().notifyViewEntered(focus);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mCalled &#x3D; true;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>最后我们在看看如何执行onStart方法的,我们在前面分析时说到<code>cycleToPath</code>最终执行onStart，来看看如何实现</p>
<h2 id="TransactionExecutor-1"><a href="#TransactionExecutor-1" class="headerlink" title="TransactionExecutor"></a><code>TransactionExecutor</code></h2><h3 id="cycleToPath"><a href="#cycleToPath" class="headerlink" title="cycleToPath()"></a><code>cycleToPath()</code></h3><p>这个方法是根据state计算生命周期的路径，简单说就是，当前处于 <code>onCreate()</code> 状态，<code>setLifecycleState()</code> 设置的 <strong>final state</strong> 是 <strong>onResume()</strong> ，就需要执行 onCreate 到 onResume 之间的状态，即 <code>onStart()</code> 。下面简单看下源码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private void cycleToPath(ActivityClientRecord r, int finish,</span><br><span class="line">            boolean excludeLastState) &#123;</span><br><span class="line">        final int start &#x3D; r.getLifecycleState();</span><br><span class="line">        log(&quot;Cycle from: &quot; + start + &quot; to: &quot; + finish + &quot; excludeLastState:&quot; + excludeLastState);</span><br><span class="line">        final IntArray path &#x3D; mHelper.getLifecyclePath(start, finish, excludeLastState);</span><br><span class="line">        performLifecycleSequence(r, path);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="performLifecycleSequence"><a href="#performLifecycleSequence" class="headerlink" title="performLifecycleSequence()"></a><code>performLifecycleSequence()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">private void performLifecycleSequence(ActivityClientRecord r, IntArray path) &#123;</span><br><span class="line">       final int size &#x3D; path.size();</span><br><span class="line">       for (int i &#x3D; 0, state; i &lt; size; i++) &#123;</span><br><span class="line">           state &#x3D; path.get(i);</span><br><span class="line">           log(&quot;Transitioning to state: &quot; + state);</span><br><span class="line">           switch (state) &#123;</span><br><span class="line">               case ON_CREATE:</span><br><span class="line">                   mTransactionHandler.handleLaunchActivity(r, mPendingActions,</span><br><span class="line">                           null &#x2F;* customIntent *&#x2F;);</span><br><span class="line">                   break;</span><br><span class="line">               case ON_START:</span><br><span class="line">                   mTransactionHandler.handleStartActivity(r, mPendingActions);</span><br><span class="line">                   break;</span><br><span class="line">               case ON_RESUME:</span><br><span class="line">                   mTransactionHandler.handleResumeActivity(r.token, false &#x2F;* finalStateRequest *&#x2F;,</span><br><span class="line">                           r.isForward, &quot;LIFECYCLER_RESUME_ACTIVITY&quot;);</span><br><span class="line">                   break;</span><br><span class="line">               case ON_PAUSE:</span><br><span class="line">                   mTransactionHandler.handlePauseActivity(r.token, false &#x2F;* finished *&#x2F;,</span><br><span class="line">                           false &#x2F;* userLeaving *&#x2F;, 0 &#x2F;* configChanges *&#x2F;, mPendingActions,</span><br><span class="line">                           &quot;LIFECYCLER_PAUSE_ACTIVITY&quot;);</span><br><span class="line">                   break;</span><br><span class="line">               case ON_STOP:</span><br><span class="line">                   mTransactionHandler.handleStopActivity(r.token, false &#x2F;* show *&#x2F;,</span><br><span class="line">                           0 &#x2F;* configChanges *&#x2F;, mPendingActions, false &#x2F;* finalStateRequest *&#x2F;,</span><br><span class="line">                           &quot;LIFECYCLER_STOP_ACTIVITY&quot;);</span><br><span class="line">                   break;</span><br><span class="line">               case ON_DESTROY:</span><br><span class="line">                   mTransactionHandler.handleDestroyActivity(r.token, false &#x2F;* finishing *&#x2F;,</span><br><span class="line">                           0 &#x2F;* configChanges *&#x2F;, false &#x2F;* getNonConfigInstance *&#x2F;,</span><br><span class="line">                           &quot;performLifecycleSequence. cycling to:&quot; + path.get(size - 1));</span><br><span class="line">                   break;</span><br><span class="line">               case ON_RESTART:</span><br><span class="line">                   mTransactionHandler.performRestartActivity(r.token, false &#x2F;* start *&#x2F;);</span><br><span class="line">                   break;</span><br><span class="line">               default:</span><br><span class="line">                   throw new IllegalArgumentException(&quot;Unexpected lifecycle state: &quot; + state);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><code>getLifecyclePath()</code> 方法就是根据 <code>start</code> 和 <code>finish</code> 计算出中间的生命周期路径。这里计算出来就是 <code>ON_START</code> 。</p>
<p>找到 <code>ON_START</code> 分支，调用了 <code>ActivityThread.handleStartActivity()</code> 方法，又是一样的套路了，这里就不再赘述了。</p>
<p>依次类推，<code>ActivityThread</code> 中应该有如下方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">handleLaunchActivity()</span><br><span class="line">handleStartActivity()</span><br><span class="line">handleResumeActivity()</span><br><span class="line">handlePauseActivity()</span><br><span class="line">handleStopActivity()</span><br><span class="line">handleDestroyActivity()</span><br></pre></td></tr></table></figure>

<h1 id="onPause延续startActivity流程"><a href="#onPause延续startActivity流程" class="headerlink" title="onPause延续startActivity流程"></a>onPause延续startActivity流程</h1><p>在<code>startActivity</code>启动流程中会调用<code>ActivityStarter#startActivity()</code>然后调用<code>startActivityUnchecked</code></p>
<h2 id="ActivityStarter"><a href="#ActivityStarter" class="headerlink" title="ActivityStarter"></a><code>ActivityStarter</code></h2><h3 id="startActivityUnchecked"><a href="#startActivityUnchecked" class="headerlink" title="startActivityUnchecked()"></a><code>startActivityUnchecked()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">private int startActivityUnchecked(final ActivityRecord r, ActivityRecord sourceRecord,</span><br><span class="line">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span><br><span class="line">            int startFlags, boolean doResume, ActivityOptions options, TaskRecord inTask,</span><br><span class="line">            ActivityRecord[] outActivity) &#123;</span><br><span class="line"></span><br><span class="line">        setInitialState(r, options, inTask, doResume, startFlags, sourceRecord, voiceSession,</span><br><span class="line">                voiceInteractor);</span><br><span class="line">				&#x2F;&#x2F; 处理activity的启动模式.绑定activity的启动模式</span><br><span class="line">        computeLaunchingTaskFlags();</span><br><span class="line">        computeSourceStack();</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F;给相应activity的intent设置flag</span><br><span class="line">        mIntent.setFlags(mLaunchFlags);</span><br><span class="line"></span><br><span class="line">        .......</span><br><span class="line">            &#x2F;&#x2F;根据activity的启动模式设置相应的栈</span><br><span class="line">            if (mStartActivity.getTask() &#x3D;&#x3D; null &amp;&amp; !clearTopAndResetStandardLaunchMode) &#123;</span><br><span class="line">                mStartActivity.setTask(reusedActivity.getTask());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (reusedActivity.getTask().intent &#x3D;&#x3D; null) &#123;</span><br><span class="line">                &#x2F;&#x2F; This task was started because of movement of the activity based on affinity...</span><br><span class="line">                &#x2F;&#x2F; Now that we are actually launching it, we can assign the base intent.</span><br><span class="line">                &#x2F;&#x2F;设置ActivityRecord,之后会传入到app_service进行activity的周期控制</span><br><span class="line">                reusedActivity.getTask().setIntent(mStartActivity);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">       </span><br><span class="line">            &#x2F;&#x2F;当activity设置为FLAG_ACTIVITY_CLEAR_TOP是的逻辑,即判断栈顶是否有目标activty,没有就重新创建,并且加入栈顶</span><br><span class="line">            if ((mLaunchFlags &amp; FLAG_ACTIVITY_CLEAR_TOP) !&#x3D; 0</span><br><span class="line">                    || isDocumentLaunchesIntoExisting(mLaunchFlags)</span><br><span class="line">                    || isLaunchModeOneOf(LAUNCH_SINGLE_INSTANCE, LAUNCH_SINGLE_TASK)) &#123;</span><br><span class="line">                final TaskRecord task &#x3D; reusedActivity.getTask();</span><br><span class="line"></span><br><span class="line">               </span><br><span class="line">                final ActivityRecord top &#x3D; task.performClearTaskForReuseLocked(mStartActivity,</span><br><span class="line">                        mLaunchFlags);</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; The above code can remove &#123;@code reusedActivity&#125; from the task, leading to the</span><br><span class="line">             </span><br><span class="line">              ......</span><br><span class="line">            &#x2F;&#x2F;设置目标栈与现有的activity匹配.根据需要清除栈</span><br><span class="line">            reusedActivity &#x3D; setTargetStackAndMoveToFrontIfNeeded(reusedActivity);</span><br><span class="line"></span><br><span class="line">            .......</span><br><span class="line">        &#x2F;&#x2F;根据activity的启动模式来判断是直接插入已存在栈顶还是重新开始插入;</span><br><span class="line">        mTargetStack.startActivityLocked(mStartActivity, topFocused, newTask, mKeepCurTransition,</span><br><span class="line">                mOptions);</span><br><span class="line">        if (mDoResume) &#123;   &#x2F;&#x2F; mDoResume &#x3D; true</span><br><span class="line">            final ActivityRecord topTaskActivity &#x3D;</span><br><span class="line">                    mStartActivity.getTask().topRunningActivityLocked();</span><br><span class="line">            if (!mTargetStack.isFocusable()</span><br><span class="line">                    || (topTaskActivity !&#x3D; null &amp;&amp; topTaskActivity.mTaskOverlay</span><br><span class="line">                    &amp;&amp; mStartActivity !&#x3D; topTaskActivity)) &#123;</span><br><span class="line">                </span><br><span class="line">                mTargetStack.ensureActivitiesVisibleLocked(null, 0, !PRESERVE_WINDOWS);</span><br><span class="line">              </span><br><span class="line">                mService.mWindowManager.executeAppTransition();</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">             </span><br><span class="line">                if (mTargetStack.isFocusable() &amp;&amp; !mSupervisor.isFocusedStack(mTargetStack)) &#123;</span><br><span class="line">                    mTargetStack.moveToFront(&quot;startActivityUnchecked&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                &#x2F;&#x2F;注释8</span><br><span class="line">                mSupervisor.resumeFocusedStackTopActivityLocked(mTargetStack, mStartActivity,</span><br><span class="line">                        mOptions);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (mStartActivity !&#x3D; null) &#123;</span><br><span class="line">            mSupervisor.mRecentTasks.add(mStartActivity.getTask());</span><br><span class="line">        &#125;</span><br><span class="line">        .......</span><br><span class="line"></span><br><span class="line">        return START_SUCCESS;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="ActivityStackSupervisor-1"><a href="#ActivityStackSupervisor-1" class="headerlink" title="ActivityStackSupervisor"></a><code>ActivityStackSupervisor</code></h2><h3 id="resumeFocusedStackTopActivityLocked"><a href="#resumeFocusedStackTopActivityLocked" class="headerlink" title="resumeFocusedStackTopActivityLocked()"></a><code>resumeFocusedStackTopActivityLocked()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">boolean resumeFocusedStackTopActivityLocked(</span><br><span class="line">            ActivityStack targetStack, ActivityRecord target, ActivityOptions targetOptions) &#123;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        if (targetStack !&#x3D; null &amp;&amp; isFocusedStack(targetStack)) &#123;</span><br><span class="line">            return targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);</span><br><span class="line">        &#125;</span><br><span class="line">				...</span><br><span class="line"></span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>判断targetStack不为空 且isFocusedStack(targetStack) == true targetStack 就是activity的任务栈 用于管理即将启动的activity的任务栈,进而调用:<code>targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);</code></p>
<h2 id="ActivityStack"><a href="#ActivityStack" class="headerlink" title="ActivityStack"></a><code>ActivityStack</code></h2><h3 id="targetStack-resumeTopActivityUncheckedLocked"><a href="#targetStack-resumeTopActivityUncheckedLocked" class="headerlink" title="targetStack.resumeTopActivityUncheckedLocked()"></a><code>targetStack.resumeTopActivityUncheckedLocked()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">boolean resumeTopActivityUncheckedLocked(ActivityRecord prev, ActivityOptions options) &#123;</span><br><span class="line">       	...</span><br><span class="line">           result &#x3D; resumeTopActivityInnerLocked(prev, options);</span><br><span class="line">				...</span><br><span class="line">       return result;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="resumeTopActivityInnerLocked"><a href="#resumeTopActivityInnerLocked" class="headerlink" title="resumeTopActivityInnerLocked()"></a><code>resumeTopActivityInnerLocked()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">private boolean resumeTopActivityInnerLocked(ActivityRecord prev, ActivityOptions options) &#123;</span><br><span class="line">        &#x2F;&#x2F; 处理下一个 activity?</span><br><span class="line">        final ActivityRecord next &#x3D; topRunningActivityLocked(true &#x2F;* focusableOnly *&#x2F;);</span><br><span class="line"></span><br><span class="line">       ......</span><br><span class="line">        boolean pausing &#x3D; mStackSupervisor.pauseBackStacks(userLeaving, next, false);</span><br><span class="line">        &#x2F;&#x2F; 注释1</span><br><span class="line">        if (mResumedActivity !&#x3D; null) &#123;</span><br><span class="line">            if (DEBUG_STATES) Slog.d(TAG_STATES,</span><br><span class="line">                    &quot;resumeTopActivityLocked: Pausing &quot; + mResumedActivity);</span><br><span class="line">            pausing |&#x3D; startPausingLocked(userLeaving, false, next, false);</span><br><span class="line">        &#125;</span><br><span class="line">        if (pausing &amp;&amp; !resumeWhilePausing) &#123;</span><br><span class="line">            if (DEBUG_SWITCH || DEBUG_STATES) Slog.v(TAG_STATES,</span><br><span class="line">                    &quot;resumeTopActivityLocked: Skip resume: need to start pausing&quot;);</span><br><span class="line">            </span><br><span class="line">            if (next.app !&#x3D; null &amp;&amp; next.app.thread !&#x3D; null) &#123;</span><br><span class="line">                mService.updateLruProcessLocked(next.app, true, null);</span><br><span class="line">            &#125;</span><br><span class="line">            if (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked();</span><br><span class="line">            if (lastResumed !&#x3D; null) &#123;</span><br><span class="line">                lastResumed.setWillCloseOrEnterPip(true);</span><br><span class="line">            &#125;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else if (mResumedActivity &#x3D;&#x3D; next &amp;&amp; next.isState(RESUMED)</span><br><span class="line">                &amp;&amp; mStackSupervisor.allResumedActivitiesComplete()) &#123;</span><br><span class="line">            executeAppTransition(options);</span><br><span class="line">            if (DEBUG_STATES) Slog.d(TAG_STATES,</span><br><span class="line">                    &quot;resumeTopActivityLocked: Top activity resumed (dontWaitForPause) &quot; + next);</span><br><span class="line">            if (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked();</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">                    .......</span><br><span class="line">                    &#x2F;&#x2F;注释2</span><br><span class="line">                    mStackSupervisor.startSpecificActivityLocked(next, true, false);</span><br><span class="line">                    if (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked();</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">       ......</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>注释1:从这里的源码可以看到当启动新的activity的时候,上一个activity走完onPause,之后才可以走新activity:onCreate —&gt;onStart—&gt;onResume…</li>
<li>注释2:回调过程重新交给ActivityStackSupervisor的startSpecificActivityLocked;继续走startActivity的流程，也可以说是onCreate()流程。</li>
</ul>
<h1 id="开始onPause"><a href="#开始onPause" class="headerlink" title="开始onPause"></a>开始onPause</h1><h3 id="startPausingLocked"><a href="#startPausingLocked" class="headerlink" title="startPausingLocked()"></a><code>startPausingLocked()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">final boolean startPausingLocked(boolean userLeaving, boolean uiSleeping,</span><br><span class="line">            ActivityRecord resuming, boolean pauseImmediately) &#123;</span><br><span class="line">        if (mPausingActivity !&#x3D; null) &#123;</span><br><span class="line">        ...</span><br><span class="line">        mStackSupervisor.resumeFocusedStackTopActivityLocked();</span><br><span class="line">        ...</span><br><span class="line">        if (prev.app !&#x3D; null &amp;&amp; prev.app.thread !&#x3D; null) &#123;</span><br><span class="line">            if (DEBUG_PAUSE) Slog.v(TAG_PAUSE, &quot;Enqueueing pending pause: &quot; + prev);</span><br><span class="line">            try &#123;</span><br><span class="line">                EventLogTags.writeAmPauseActivity(prev.userId, System.identityHashCode(prev),</span><br><span class="line">                        prev.shortComponentName, &quot;userLeaving&#x3D;&quot; + userLeaving);</span><br><span class="line">                mService.updateUsageStats(prev, false);</span><br><span class="line">								&#x2F;&#x2F;还是原来的配方，还是原来的味道</span><br><span class="line">                mService.getLifecycleManager().scheduleTransaction(prev.app.thread, prev.appToken,</span><br><span class="line">                        PauseActivityItem.obtain(prev.finishing, userLeaving,</span><br><span class="line">                                prev.configChangeFlags, pauseImmediately));</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                &#x2F;&#x2F; Ignore exception, if process died other code will cleanup.</span><br><span class="line">                Slog.w(TAG, &quot;Exception thrown during pause&quot;, e);</span><br><span class="line">                mPausingActivity &#x3D; null;</span><br><span class="line">                mLastPausedActivity &#x3D; null;</span><br><span class="line">                mLastNoHistoryActivity &#x3D; null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            mPausingActivity &#x3D; null;</span><br><span class="line">            mLastPausedActivity &#x3D; null;</span><br><span class="line">            mLastNoHistoryActivity &#x3D; null;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>mService.getLifecycleManager().scheduleTransaction(prev.app.thread, prev.appToken,
                        PauseActivityItem.obtain(prev.finishing, userLeaving,
                                prev.configChangeFlags, pauseImmediately));</code></p>
<p>多么的相似直接<code>scheduleTransaction</code>,就是复制上面的流程,最终执行：</p>
<h2 id="ActivityThread-2"><a href="#ActivityThread-2" class="headerlink" title="ActivityThread"></a><code>ActivityThread</code></h2><h3 id="handleStopActivity"><a href="#handleStopActivity" class="headerlink" title="handleStopActivity()"></a><code>handleStopActivity()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Override</span><br><span class="line">    public void handlePauseActivity(IBinder token, boolean finished, boolean userLeaving,</span><br><span class="line">            int configChanges, PendingTransactionActions pendingActions, String reason) &#123;</span><br><span class="line">        ActivityClientRecord r &#x3D; mActivities.get(token);</span><br><span class="line">        if (r !&#x3D; null) &#123;</span><br><span class="line">            if (userLeaving) &#123;</span><br><span class="line">                performUserLeavingActivity(r);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            r.activity.mConfigChangeFlags |&#x3D; configChanges;</span><br><span class="line">            performPauseActivity(r, finished, reason, pendingActions);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; Make sure any pending writes are now committed.</span><br><span class="line">            if (r.isPreHoneycomb()) &#123;</span><br><span class="line">                QueuedWork.waitToFinish();</span><br><span class="line">            &#125;</span><br><span class="line">            mSomeActivitiesChanged &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="onStop"><a href="#onStop" class="headerlink" title="onStop"></a><code>onStop</code></h1><p>onStop执行是在<code>onResume</code>执行方法中，具体在<code>ActivityThread</code>的<code>handleResumeActivity</code></p>
<h2 id="ActivityThread-3"><a href="#ActivityThread-3" class="headerlink" title="ActivityThread"></a><code>ActivityThread</code></h2><h3 id="handleResumeActivity-1"><a href="#handleResumeActivity-1" class="headerlink" title="handleResumeActivity()"></a><code>handleResumeActivity()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public void handleResumeActivity(IBinder token, boolean finalStateRequest, boolean isForward,</span><br><span class="line">            String reason) &#123;</span><br><span class="line">        ...</span><br><span class="line">        final ActivityClientRecord r &#x3D; performResumeActivity(token, finalStateRequest, reason);</span><br><span class="line">        ...</span><br><span class="line">       Looper.myQueue().addIdleHandler(new Idler());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来看一下Idler都做了什么。当MessageQueue空闲的时候就会回调Idler.queueIdle方法，经过层层调用跳转到ActivityStack.stopActivityLocked方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Idler</span> <span class="keyword">implements</span> <span class="title">MessageQueue</span>.<span class="title">IdleHandler</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">queueIdle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           		...</span><br><span class="line">              am.activityIdle(a.token, a.createdConfig, stopProfiling);</span><br><span class="line">              ...</span><br><span class="line">                        </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>am最终执行的是AMS中同名方法</p>
<h2 id="AMS"><a href="#AMS" class="headerlink" title="AMS"></a><code>AMS</code></h2><h3 id="activityIdle"><a href="#activityIdle" class="headerlink" title="activityIdle()"></a><code>activityIdle()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public final void activityIdle(IBinder token, Configuration config, boolean stopProfiling) &#123;</span><br><span class="line">        final long origId &#x3D; Binder.clearCallingIdentity();</span><br><span class="line">        synchronized (this) &#123;</span><br><span class="line">            ActivityStack stack &#x3D; ActivityRecord.getStackLocked(token);</span><br><span class="line">            if (stack !&#x3D; null) &#123;</span><br><span class="line">                ActivityRecord r &#x3D;</span><br><span class="line">                        mStackSupervisor.activityIdleInternalLocked(token, false &#x2F;* fromTimeout *&#x2F;,</span><br><span class="line">                                false &#x2F;* processPausingActivities *&#x2F;, config);</span><br><span class="line">                if (stopProfiling) &#123;</span><br><span class="line">                    if ((mProfileProc &#x3D;&#x3D; r.app) &amp;&amp; mProfilerInfo !&#x3D; null) &#123;</span><br><span class="line">                        clearProfilerLocked();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="ActivityStackSupervisor-2"><a href="#ActivityStackSupervisor-2" class="headerlink" title="ActivityStackSupervisor"></a><code>ActivityStackSupervisor</code></h2><h3 id="activityIdleInternalLocked"><a href="#activityIdleInternalLocked" class="headerlink" title="activityIdleInternalLocked()"></a><code>activityIdleInternalLocked()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">final ActivityRecord activityIdleInternalLocked(final IBinder token, boolean fromTimeout,</span><br><span class="line">            boolean processPausingActivities, Configuration config) &#123;</span><br><span class="line">            ...</span><br><span class="line">            for (int i &#x3D; 0; i &lt; NS; i++) &#123;</span><br><span class="line">            r &#x3D; stops.get(i);</span><br><span class="line">            final ActivityStack stack &#x3D; r.getStack();</span><br><span class="line">            if (stack !&#x3D; null) &#123;</span><br><span class="line">                if (r.finishing) &#123;</span><br><span class="line">                    stack.finishCurrentActivityLocked(r, ActivityStack.FINISH_IMMEDIATELY, false,</span><br><span class="line">                            &quot;activityIdleInternalLocked&quot;);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    stack.stopActivityLocked(r);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ActivityStack-1"><a href="#ActivityStack-1" class="headerlink" title="ActivityStack"></a><code>ActivityStack</code></h2><h3 id="stopActivityLocked"><a href="#stopActivityLocked" class="headerlink" title="stopActivityLocked()"></a><code>stopActivityLocked()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">final void stopActivityLocked(ActivityRecord r) &#123;</span><br><span class="line">				mService.getLifecycleManager().scheduleTransaction(r.app.thread, r.appToken,</span><br><span class="line">                        StopActivityItem.obtain(r.visible, r.configChangeFlags));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样的逻辑,最终执行</p>
<h2 id="ActivityThread-4"><a href="#ActivityThread-4" class="headerlink" title="ActivityThread"></a><code>ActivityThread</code></h2><h3 id="handleStopActivity-1"><a href="#handleStopActivity-1" class="headerlink" title="handleStopActivity()"></a><code>handleStopActivity()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   public void handleStopActivity(IBinder token, boolean show, int configChanges,</span><br><span class="line">           PendingTransactionActions pendingActions, boolean finalStateRequest, String reason) &#123;</span><br><span class="line">       final ActivityClientRecord r &#x3D; mActivities.get(token);</span><br><span class="line">       r.activity.mConfigChangeFlags |&#x3D; configChanges;</span><br><span class="line"></span><br><span class="line">       final StopInfo stopInfo &#x3D; new StopInfo();</span><br><span class="line">       performStopActivityInner(r, stopInfo, show, true &#x2F;* saveState *&#x2F;, finalStateRequest,</span><br><span class="line">               reason);</span><br><span class="line"></span><br><span class="line">       if (localLOGV) Slog.v(</span><br><span class="line">           TAG, &quot;Finishing stop of &quot; + r + &quot;: show&#x3D;&quot; + show</span><br><span class="line">           + &quot; win&#x3D;&quot; + r.window);</span><br><span class="line"></span><br><span class="line">       updateVisibility(r, show);</span><br><span class="line"></span><br><span class="line">       &#x2F;&#x2F; Make sure any pending writes are now committed.</span><br><span class="line">       if (!r.isPreHoneycomb()) &#123;</span><br><span class="line">           QueuedWork.waitToFinish();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       stopInfo.setActivity(r);</span><br><span class="line">       stopInfo.setState(r.state);</span><br><span class="line">       stopInfo.setPersistentState(r.persistentState);</span><br><span class="line">       pendingActions.setStopInfo(stopInfo);</span><br><span class="line">       mSomeActivitiesChanged &#x3D; true;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
            <a href="/tags/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/" rel="tag"># Android系统分析</a>
          
            <a href="/tags/Activity%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/" rel="tag"># Activity生命周期</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/06/02/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Android%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1/Android%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1-ActivityManagerService/" rel="next" title="Android系统服务-ActivityManagerService">
                <i class="fa fa-chevron-left"></i> Android系统服务-ActivityManagerService
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/06/03/git/git%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/" rel="prev" title="git常见问题">
                git常见问题 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="SOHUCS"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">冯星</p>
              <p class="site-description motion-element" itemprop="description">人生就像是一个马尔可夫链，你的未来取决于你当下正在做的事，而无关于过去做完的事</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7Carchive">
              
                  <span class="site-state-item-count">103</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">52</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#概述"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Activity的四种状态"><span class="nav-number">1.1.</span> <span class="nav-text">Activity的四种状态</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#活动状态"><span class="nav-number">1.1.1.</span> <span class="nav-text">活动状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#暂停状态"><span class="nav-number">1.1.2.</span> <span class="nav-text">暂停状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#停止状态"><span class="nav-number">1.1.3.</span> <span class="nav-text">停止状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#销毁状态"><span class="nav-number">1.1.4.</span> <span class="nav-text">销毁状态</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#源码分析"><span class="nav-number">2.</span> <span class="nav-text">源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ActivityStackSupervisor"><span class="nav-number">2.1.</span> <span class="nav-text">ActivityStackSupervisor</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#realStartActivityLocked"><span class="nav-number">2.1.1.</span> <span class="nav-text">realStartActivityLocked()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AMS中"><span class="nav-number">2.2.</span> <span class="nav-text">AMS中</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#getLifecycleManager"><span class="nav-number">2.2.1.</span> <span class="nav-text">getLifecycleManager()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ClientLifecycleManager"><span class="nav-number">2.3.</span> <span class="nav-text">ClientLifecycleManager</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#scheduleTransaction"><span class="nav-number">2.3.1.</span> <span class="nav-text">scheduleTransaction()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ClientTransaction"><span class="nav-number">2.4.</span> <span class="nav-text">ClientTransaction</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#schedule"><span class="nav-number">2.4.1.</span> <span class="nav-text">schedule()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ActivityThread-IApplicationThread"><span class="nav-number">2.5.</span> <span class="nav-text">ActivityThread#IApplicationThread</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#scheduleTransaction-1"><span class="nav-number">2.5.1.</span> <span class="nav-text">scheduleTransaction()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ActivityThread"><span class="nav-number">2.6.</span> <span class="nav-text">ActivityThread</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#scheduleTransaction-2"><span class="nav-number">2.6.1.</span> <span class="nav-text">scheduleTransaction()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TransactionExecutor"><span class="nav-number">2.7.</span> <span class="nav-text">TransactionExecutor</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#execute"><span class="nav-number">2.7.1.</span> <span class="nav-text">execute()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#executeLifecycleState"><span class="nav-number">2.7.2.</span> <span class="nav-text">executeLifecycleState()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ResumeActivityItem"><span class="nav-number">2.8.</span> <span class="nav-text">ResumeActivityItem</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#execute-1"><span class="nav-number">2.8.1.</span> <span class="nav-text">execute()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ActivityThread-1"><span class="nav-number">2.9.</span> <span class="nav-text">ActivityThread</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#handleResumeActivity"><span class="nav-number">2.9.1.</span> <span class="nav-text">handleResumeActivity()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#performResumeActivity"><span class="nav-number">2.9.2.</span> <span class="nav-text">performResumeActivity()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Activity"><span class="nav-number">2.10.</span> <span class="nav-text">Activity</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#performResume"><span class="nav-number">2.10.1.</span> <span class="nav-text">performResume()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#onRestart"><span class="nav-number">3.</span> <span class="nav-text">onRestart</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#performRestart"><span class="nav-number">3.0.1.</span> <span class="nav-text">performRestart()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Instrumentation"><span class="nav-number">3.1.</span> <span class="nav-text">Instrumentation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#callActivityOnRestart"><span class="nav-number">3.1.1.</span> <span class="nav-text">callActivityOnRestart()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Activity-1"><span class="nav-number">3.2.</span> <span class="nav-text">Activity</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#onRestart-1"><span class="nav-number">3.2.1.</span> <span class="nav-text">onRestart</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#onResume"><span class="nav-number">4.</span> <span class="nav-text">onResume</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#TransactionExecutor-1"><span class="nav-number">4.1.</span> <span class="nav-text">TransactionExecutor</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#cycleToPath"><span class="nav-number">4.1.1.</span> <span class="nav-text">cycleToPath()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#performLifecycleSequence"><span class="nav-number">4.1.2.</span> <span class="nav-text">performLifecycleSequence()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#onPause延续startActivity流程"><span class="nav-number">5.</span> <span class="nav-text">onPause延续startActivity流程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ActivityStarter"><span class="nav-number">5.1.</span> <span class="nav-text">ActivityStarter</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#startActivityUnchecked"><span class="nav-number">5.1.1.</span> <span class="nav-text">startActivityUnchecked()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ActivityStackSupervisor-1"><span class="nav-number">5.2.</span> <span class="nav-text">ActivityStackSupervisor</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#resumeFocusedStackTopActivityLocked"><span class="nav-number">5.2.1.</span> <span class="nav-text">resumeFocusedStackTopActivityLocked()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ActivityStack"><span class="nav-number">5.3.</span> <span class="nav-text">ActivityStack</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#targetStack-resumeTopActivityUncheckedLocked"><span class="nav-number">5.3.1.</span> <span class="nav-text">targetStack.resumeTopActivityUncheckedLocked()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#resumeTopActivityInnerLocked"><span class="nav-number">5.3.2.</span> <span class="nav-text">resumeTopActivityInnerLocked()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#开始onPause"><span class="nav-number">6.</span> <span class="nav-text">开始onPause</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#startPausingLocked"><span class="nav-number">6.0.1.</span> <span class="nav-text">startPausingLocked()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ActivityThread-2"><span class="nav-number">6.1.</span> <span class="nav-text">ActivityThread</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#handleStopActivity"><span class="nav-number">6.1.1.</span> <span class="nav-text">handleStopActivity()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#onStop"><span class="nav-number">7.</span> <span class="nav-text">onStop</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ActivityThread-3"><span class="nav-number">7.1.</span> <span class="nav-text">ActivityThread</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#handleResumeActivity-1"><span class="nav-number">7.1.1.</span> <span class="nav-text">handleResumeActivity()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AMS"><span class="nav-number">7.2.</span> <span class="nav-text">AMS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#activityIdle"><span class="nav-number">7.2.1.</span> <span class="nav-text">activityIdle()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ActivityStackSupervisor-2"><span class="nav-number">7.3.</span> <span class="nav-text">ActivityStackSupervisor</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#activityIdleInternalLocked"><span class="nav-number">7.3.1.</span> <span class="nav-text">activityIdleInternalLocked()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ActivityStack-1"><span class="nav-number">7.4.</span> <span class="nav-text">ActivityStack</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#stopActivityLocked"><span class="nav-number">7.4.1.</span> <span class="nav-text">stopActivityLocked()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ActivityThread-4"><span class="nav-number">7.5.</span> <span class="nav-text">ActivityThread</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#handleStopActivity-1"><span class="nav-number">7.5.1.</span> <span class="nav-text">handleStopActivity()</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">冯星</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'bbc85MrQ0qhACWJxhCKrJoAj-gzGzoHsz',
        appKey: 'fWH5REKFSsGT4TKe1lWt1ke4',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
