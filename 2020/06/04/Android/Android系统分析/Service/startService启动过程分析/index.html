<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Android系统分析,startService启动过程分析," />










<meta name="description" content="一、概述看过前面介绍Binder系列文章，相信对Binder架构有了较深地理解。在Android系统启动-开篇中讲述了Binder的地位是非常之重要，整个Java framework的提供ActivityManagerService、PackageManagerService等服务都是基于Binder架构来通信的，另外 handle消息机制在进程内的通信使用非常多。本文将开启对ActivityMa">
<meta property="og:type" content="article">
<meta property="og:title" content="startService启动过程分析">
<meta property="og:url" content="http://yoursite.com/2020/06/04/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Service/startService%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="冯星的博客">
<meta property="og:description" content="一、概述看过前面介绍Binder系列文章，相信对Binder架构有了较深地理解。在Android系统启动-开篇中讲述了Binder的地位是非常之重要，整个Java framework的提供ActivityManagerService、PackageManagerService等服务都是基于Binder架构来通信的，另外 handle消息机制在进程内的通信使用非常多。本文将开启对ActivityMa">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://gityuan.com/images/android-service/am/activity_manager_classes.png">
<meta property="og:image" content="http://gityuan.com/images/android-service/am/start_service.png">
<meta property="og:image" content="http://gityuan.com/images/android-service/am/Seq_start_service.png">
<meta property="og:image" content="http://gityuan.com/images/android-service/am/Activity_Manager_Service.png">
<meta property="og:image" content="http://gityuan.com/images/android-service/am/application_thread_classes.png">
<meta property="og:image" content="http://gityuan.com/images/android-service/start_service/start_service_processes.jpg">
<meta property="og:image" content="http://gityuan.com/images/ams/service_lifeline.jpg">
<meta property="og:image" content="http://gityuan.com/images/ams/start_service_process.jpg">
<meta property="article:published_time" content="2020-06-04T03:02:54.000Z">
<meta property="article:modified_time" content="2020-06-04T05:38:21.067Z">
<meta property="article:author" content="冯星">
<meta property="article:tag" content="Android系统分析">
<meta property="article:tag" content="startService启动过程分析">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://gityuan.com/images/android-service/am/activity_manager_classes.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/06/04/Android/Android系统分析/Service/startService启动过程分析/"/>





  <title>startService启动过程分析 | 冯星的博客</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">冯星的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Life is like a Markov chain, your future only depends on what you are doing now, and independent of your past.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/04/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Service/startService%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="冯星">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冯星的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">startService启动过程分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-04T11:02:54+08:00">
                2020-06-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/" itemprop="url" rel="index">
                    <span itemprop="name">Android系统分析</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Service/" itemprop="url" rel="index">
                    <span itemprop="name">Service</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/06/04/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Service/startService%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/06/04/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Service/startService%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p>看过前面介绍<a href="http://gityuan.com/2015/10/31/binder-prepare/" target="_blank" rel="noopener">Binder系列</a>文章，相信对Binder架构有了较深地理解。在<a href="http://gityuan.com/2016/01/03/android-boot/" target="_blank" rel="noopener">Android系统启动-开篇</a>中讲述了Binder的地位是非常之重要，整个Java framework的提供ActivityManagerService、PackageManagerService等服务都是基于Binder架构来通信的，另外 <a href="http://gityuan.com/2015/12/26/handler-message/" target="_blank" rel="noopener">handle消息机制</a>在进程内的通信使用非常多。本文将开启对ActivityManagerService的分析。</p>
<p>ActivityManagerService是Android的Java framework的服务框架最重要的服务之一。对于Andorid的Activity、Service、Broadcast、ContentProvider四剑客的管理，包含其生命周期都是通过ActivityManagerService来完成的。对于这四剑客的介绍，此处先略过，后续博主会针对这4剑客分别阐述。</p>
<h4 id="1-1-类图"><a href="#1-1-类图" class="headerlink" title="1.1 类图"></a>1.1 类图</h4><p>下面先看看ActivityManagerService相关的类图：</p>
<p><img src="http://gityuan.com/images/android-service/am/activity_manager_classes.png" alt="activity_manager_classes"></p>
<p>单单就一个ActivityManagerService.java文件就代码超过2万行，我们需要需要一个线，再结合binder的知识，来把我们想要了解的东西串起来，那么本文将从App启动的视角来分析ActivityManagerService。</p>
<h4 id="1-2-流程图"><a href="#1-2-流程图" class="headerlink" title="1.2 流程图"></a>1.2 流程图</h4><p>在app中启动一个service，就一行语句搞定，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startService()； &#x2F;&#x2F;或 binderService()</span><br></pre></td></tr></table></figure>

<p>该过程如下：</p>
<p><img src="http://gityuan.com/images/android-service/am/start_service.png" alt="start_service"></p>
<p>当App通过调用Android API方法startService()或binderService()来生成并启动服务的过程，主要是由ActivityManagerService来完成的。</p>
<ol>
<li>ActivityManagerService通过Socket通信方式向Zygote进程请求生成(fork)用于承载服务的进程ActivityThread。此处讲述启动远程服务的过程，即服务运行于单独的进程中，对于运行本地服务则不需要启动服务的过程。ActivityThread是应用程序的主线程；</li>
<li>Zygote通过fork的方法，将zygote进程复制生成新的进程，并将ActivityThread相关的资源加载到新进程；</li>
<li>ActivityManagerService向新生成的ActivityThread进程，通过Binder方式发送生成服务的请求；</li>
<li>ActivityThread启动运行服务，这便于服务启动的简易过程，真正流程远比这服务；</li>
</ol>
<p><strong>启动服务的流程图：</strong></p>
<p><img src="http://gityuan.com/images/android-service/am/Seq_start_service.png" alt="Seq_start_service"></p>
<p>图中涉及的首字母缩写：</p>
<ul>
<li>AMP:ActivityManagerProxy</li>
<li>AMN:ActivityManagerNative</li>
<li>AMS:ActivityManagerService</li>
<li>AT:ApplicationThread</li>
<li>ATP:ApplicationThreadProxy</li>
<li>ATN:ApplicationThreadNative</li>
</ul>
<p>接下来，我们正式从代码角度来分析服务启动的过程。首先在我们应用程序的Activity类的调用startService()方法，该方法调用【流程1】的方法。</p>
<h2 id="二-发起进程端"><a href="#二-发起进程端" class="headerlink" title="二. 发起进程端"></a>二. 发起进程端</h2><h3 id="1-CW-startService"><a href="#1-CW-startService" class="headerlink" title="1. CW.startService"></a>1. CW.startService</h3><p>[-&gt; ContextWrapper.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public class ContextWrapper extends Context &#123;</span><br><span class="line">    public ComponentName startService(Intent service) &#123;</span><br><span class="line">        return mBase.startService(service); &#x2F;&#x2F;其中mBase为ContextImpl对象 【见流程2】</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-CI-startService"><a href="#2-CI-startService" class="headerlink" title="2. CI.startService"></a>2. CI.startService</h3><p>[-&gt; ContextImpl.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class ContextImpl extends Context &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public ComponentName startService(Intent service) &#123;</span><br><span class="line">        &#x2F;&#x2F;当system进程调用此方法时输出warn信息，system进程建立调用startServiceAsUser方法</span><br><span class="line">        warnIfCallingFromSystemProcess();</span><br><span class="line">        return startServiceCommon(service, mUser); &#x2F;&#x2F;【见流程3】</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-CI-startServiceCommon"><a href="#3-CI-startServiceCommon" class="headerlink" title="3. CI.startServiceCommon"></a>3. CI.startServiceCommon</h3><p>[-&gt; ContextImpl.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private ComponentName startServiceCommon(Intent service, UserHandle user) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        &#x2F;&#x2F;检验service，当service为空则throw异常</span><br><span class="line">        validateServiceIntent(service);</span><br><span class="line">        service.prepareToLeaveProcess();</span><br><span class="line">        &#x2F;&#x2F; 调用ActivityManagerNative类 【见流程3.1以及流程4】</span><br><span class="line">        ComponentName cn &#x3D; ActivityManagerNative.getDefault().startService(</span><br><span class="line">            mMainThread.getApplicationThread(), service, service.resolveTypeIfNeeded(getContentResolver()), getOpPackageName(), user.getIdentifier());</span><br><span class="line">        if (cn !&#x3D; null) &#123;</span><br><span class="line">            if (cn.getPackageName().equals(&quot;!&quot;)) &#123;</span><br><span class="line">                throw new SecurityException(&quot;Not allowed to start service &quot; +</span><br><span class="line">                    service + &quot; without permission &quot; + cn.getClassName());</span><br><span class="line">            &#125; else if (cn.getPackageName().equals(&quot;!!&quot;)) &#123;</span><br><span class="line">                throw new SecurityException(&quot;Unable to start service &quot; +</span><br><span class="line">                    service  &quot;: &quot; + cn.getClassName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return cn;</span><br><span class="line">    &#125; catch (RemoteException e) &#123;</span><br><span class="line">        throw new RuntimeException(&quot;Failure from system&quot;, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-AMN-getDefault"><a href="#3-1-AMN-getDefault" class="headerlink" title="3.1 AMN.getDefault"></a>3.1 AMN.getDefault</h4><p>[-&gt; ActivityManagerNative.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gDefault.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>gDefault为Singleton类型对象，此次采用单例模式，mInstance为IActivityManager类的代理对象，即ActivityManagerProxy。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public abstract class Singleton&lt;T&gt; &#123;</span><br><span class="line">    public final T get() &#123;</span><br><span class="line">        synchronized (this) &#123;</span><br><span class="line">            if (mInstance &#x3D;&#x3D; null) &#123;</span><br><span class="line">                &#x2F;&#x2F;首次调用create()来获取AMP对象</span><br><span class="line">                mInstance &#x3D; create();</span><br><span class="line">            &#125;</span><br><span class="line">            return mInstance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再来看看create()的过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private static final Singleton&lt;IActivityManager&gt; gDefault &#x3D; new Singleton&lt;IActivityManager&gt;() &#123;</span><br><span class="line">    protected IActivityManager create() &#123;</span><br><span class="line">        &#x2F;&#x2F;获取名为&quot;activity&quot;的服务，服务都注册到ServiceManager来统一管理</span><br><span class="line">        IBinder b &#x3D; ServiceManager.getService(&quot;activity&quot;);</span><br><span class="line">        IActivityManager am &#x3D; asInterface(b);</span><br><span class="line">        return am;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>该方法返回的是ActivityManagerProxy对象，那么下一步调用ActivityManagerProxy.startService()方法。</p>
<p>通过Binder通信过程中，提供了一个IActivityManager服务接口，ActivityManagerProxy类与ActivityManagerService类都实现了IActivityManager接口。ActivityManagerProxy作为binder通信的客户端，ActivityManagerService作为binder通信的服务端，根据<a href="http://gityuan.com/2015/10/31/binder-prepare/" target="_blank" rel="noopener">Binder系列</a>文章，ActivityManagerProxy.startService()最终调用ActivityManagerService.startService()，整个流程图如下：</p>
<p><img src="http://gityuan.com/images/android-service/am/Activity_Manager_Service.png" alt="Activity_Manager_Service"></p>
<h3 id="4-AMP-startService"><a href="#4-AMP-startService" class="headerlink" title="4. AMP.startService"></a>4. AMP.startService</h3><p>该类位于文件ActivityManagerNative.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public ComponentName startService(IApplicationThread caller, Intent service, String resolvedType, String callingPackage, int userId) throws RemoteException &#123;</span><br><span class="line">    Parcel data &#x3D; Parcel.obtain();</span><br><span class="line">    Parcel reply &#x3D; Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    data.writeStrongBinder(caller !&#x3D; null ? caller.asBinder() : null);</span><br><span class="line">    service.writeToParcel(data, 0);</span><br><span class="line">    data.writeString(resolvedType);</span><br><span class="line">    data.writeString(callingPackage);</span><br><span class="line">    data.writeInt(userId);</span><br><span class="line">    &#x2F;&#x2F;通过Binder 传递数据　【见流程5】</span><br><span class="line">    mRemote.transact(START_SERVICE_TRANSACTION, data, reply, 0);</span><br><span class="line">    reply.readException();</span><br><span class="line">    ComponentName res &#x3D; ComponentName.readFromParcel(reply);</span><br><span class="line">    data.recycle();</span><br><span class="line">    reply.recycle();</span><br><span class="line">    return res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mRemote.transact()是binder通信的客户端发起方法，经过binder驱动，最后回到binder服务端ActivityManagerNative的onTransact()方法。</p>
<h2 id="三-system-server端"><a href="#三-system-server端" class="headerlink" title="三. system_server端"></a>三. system_server端</h2><p>借助于AMP/AMN这对Binder对象，便完成了从发起端所在进程到system_server的调用过程</p>
<h3 id="5-AMN-onTransact"><a href="#5-AMN-onTransact" class="headerlink" title="5. AMN.onTransact"></a>5. AMN.onTransact</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public boolean onTransact(int code, Parcel data, Parcel reply, int flags) throws RemoteException &#123;</span><br><span class="line">    switch (code) &#123;</span><br><span class="line">    ...</span><br><span class="line">     case START_SERVICE_TRANSACTION: &#123;</span><br><span class="line">        data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">        IBinder b &#x3D; data.readStrongBinder();</span><br><span class="line">        &#x2F;&#x2F;生成ApplicationThreadNative的代理对象，即ApplicationThreadProxy对象</span><br><span class="line">        IApplicationThread app &#x3D; ApplicationThreadNative.asInterface(b);</span><br><span class="line">        Intent service &#x3D; Intent.CREATOR.createFromParcel(data);</span><br><span class="line">        String resolvedType &#x3D; data.readString();</span><br><span class="line">        String callingPackage &#x3D; data.readString();</span><br><span class="line">        int userId &#x3D; data.readInt();</span><br><span class="line">        &#x2F;&#x2F;调用ActivityManagerService的startService()方法【见流程6】</span><br><span class="line">        ComponentName cn &#x3D; startService(app, service, resolvedType, callingPackage, userId);</span><br><span class="line">        reply.writeNoException();</span><br><span class="line">        ComponentName.writeToParcel(cn, reply);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在整个调用过程涉及两个进程，不妨令startService的发起进程记为进程A，ServiceManagerService记为进程B；那么进程A通过Binder机制（采用IActivityManager接口）向进程B发起请求服务，进程B则通过Binder机制(采用IApplicationThread接口)向进程A发起请求服务。也就是说进程A与进程B能相互间主动发起请求，进程通信。</p>
<p>这里涉及IApplicationThread，那么下面直接把其相关的类图展示如下：</p>
<p><img src="http://gityuan.com/images/android-service/am/application_thread_classes.png" alt="application_thread_classes"></p>
<p>与IActivityManager的binder通信原理一样，<code>ApplicationThreadProxy</code>作为binder通信的客户端，<code>ApplicationThreadNative</code>作为Binder通信的服务端，其中<code>ApplicationThread</code>继承ApplicationThreadNative类，覆写其中的部分方法。</p>
<h3 id="6-AMS-startService"><a href="#6-AMS-startService" class="headerlink" title="6. AMS.startService"></a>6. AMS.startService</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public ComponentName startService(IApplicationThread caller, Intent service, String resolvedType, String callingPackage, int userId) throws TransactionTooLargeException &#123;</span><br><span class="line">    &#x2F;&#x2F;当调用者是孤立进程，则抛出异常。</span><br><span class="line">    enforceNotIsolatedCaller(&quot;startService&quot;);</span><br><span class="line"></span><br><span class="line">    if (service !&#x3D; null &amp;&amp; service.hasFileDescriptors() &#x3D;&#x3D; true) &#123;</span><br><span class="line">        throw new IllegalArgumentException(&quot;File descriptors passed in Intent&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    if (callingPackage &#x3D;&#x3D; null) &#123;</span><br><span class="line">        throw new IllegalArgumentException(&quot;callingPackage cannot be null&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    if (DEBUG_SERVICE) Slog.v(TAG_SERVICE,</span><br><span class="line">            &quot;startService: &quot; + service + &quot; type&#x3D;&quot; + resolvedType);</span><br><span class="line"></span><br><span class="line">    synchronized(this) &#123;</span><br><span class="line">        final int callingPid &#x3D; Binder.getCallingPid(); &#x2F;&#x2F;调用者pid</span><br><span class="line">        final int callingUid &#x3D; Binder.getCallingUid(); &#x2F;&#x2F;调用者uid</span><br><span class="line">        final long origId &#x3D; Binder.clearCallingIdentity();</span><br><span class="line">        &#x2F;&#x2F;此次的mServices为ActiveServices对象 【见流程7】</span><br><span class="line">        ComponentName res &#x3D; mServices.startServiceLocked(caller, service,</span><br><span class="line">                resolvedType, callingPid, callingUid, callingPackage, userId);</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法参数说明：</p>
<ul>
<li>caller：IApplicationThread类型，复杂处理</li>
<li>service：Intent类型，包含需要运行的service信息</li>
<li>resolvedType：String类型</li>
<li>callingPackage: String类型，调用该方法的package</li>
<li>userId: int类型，用户的id</li>
</ul>
<h3 id="7-AS-startServiceLocked"><a href="#7-AS-startServiceLocked" class="headerlink" title="7. AS.startServiceLocked"></a>7. AS.startServiceLocked</h3><p>[-&gt; ActiveServices.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">ComponentName startServiceLocked(IApplicationThread caller, Intent service, String resolvedType, int callingPid, int callingUid, String callingPackage, int userId) throws TransactionTooLargeException &#123;</span><br><span class="line"></span><br><span class="line">    final boolean callerFg;</span><br><span class="line">    if (caller !&#x3D; null) &#123;</span><br><span class="line">        final ProcessRecord callerApp &#x3D; mAm.getRecordForAppLocked(caller);</span><br><span class="line">        if (callerApp &#x3D;&#x3D; null)</span><br><span class="line">            throw new SecurityException(&quot;&quot;); &#x2F;&#x2F;抛出异常，此处省略异常字符串</span><br><span class="line">        callerFg &#x3D; callerApp.setSchedGroup !&#x3D; Process.THREAD_GROUP_BG_NONINTERACTIVE;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        callerFg &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;检索服务信息</span><br><span class="line">    ServiceLookupResult res &#x3D;  retrieveServiceLocked(service, resolvedType, callingPackage,</span><br><span class="line">                callingPid, callingUid, userId, true, callerFg);</span><br><span class="line">    if (res &#x3D;&#x3D; null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    if (res.record &#x3D;&#x3D; null) &#123;</span><br><span class="line">        return new ComponentName(&quot;!&quot;, res.permission !&#x3D; null</span><br><span class="line">                ? res.permission : &quot;private to package&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    ServiceRecord r &#x3D; res.record;</span><br><span class="line">    if (!mAm.getUserManagerLocked().exists(r.userId)) &#123; &#x2F;&#x2F;检查是否存在启动服务的user</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    NeededUriGrants neededGrants &#x3D; mAm.checkGrantUriPermissionFromIntentLocked(</span><br><span class="line">            callingUid, r.packageName, service, service.getFlags(), null, r.userId);</span><br><span class="line"></span><br><span class="line">    r.lastActivity &#x3D; SystemClock.uptimeMillis();</span><br><span class="line">    r.startRequested &#x3D; true;</span><br><span class="line">    r.delayedStop &#x3D; false;</span><br><span class="line">    r.pendingStarts.add(new ServiceRecord.StartItem(r, false, r.makeNextStartId(),</span><br><span class="line">            service, neededGrants));</span><br><span class="line">    final ServiceMap smap &#x3D; getServiceMap(r.userId);</span><br><span class="line">    boolean addToStarting &#x3D; false;</span><br><span class="line">    &#x2F;&#x2F;对于非前台进程的调度</span><br><span class="line">    if (!callerFg &amp;&amp; r.app &#x3D;&#x3D; null &amp;&amp; mAm.mStartedUsers.get(r.userId) !&#x3D; null) &#123;</span><br><span class="line">        ProcessRecord proc &#x3D; mAm.getProcessRecordLocked(r.processName, r.appInfo.uid, false);</span><br><span class="line">        if (proc &#x3D;&#x3D; null || proc.curProcState &gt; ActivityManager.PROCESS_STATE_RECEIVER) &#123;</span><br><span class="line">            if (r.delayed) &#123;  &#x2F;&#x2F;已计划延迟启动</span><br><span class="line">                return r.name;</span><br><span class="line">            &#125;</span><br><span class="line">            if (smap.mStartingBackground.size() &gt;&#x3D; mMaxStartingBackground) &#123;</span><br><span class="line">                &#x2F;&#x2F;当超出 同一时间允许后续启动的最大服务数，则将该服务加入延迟启动的队列。</span><br><span class="line">                smap.mDelayedStartList.add(r);</span><br><span class="line">                r.delayed &#x3D; true;</span><br><span class="line">                return r.name;</span><br><span class="line">            &#125;</span><br><span class="line">            addToStarting &#x3D; true;</span><br><span class="line">        &#125; else if (proc.curProcState &gt;&#x3D; ActivityManager.PROCESS_STATE_SERVICE) &#123;</span><br><span class="line">            &#x2F;&#x2F;将新的服务加入到后台启动队列，该队列也包含当前正在运行其他services或者receivers的进程</span><br><span class="line">            addToStarting &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;【见流程8】</span><br><span class="line">    return startServiceInnerLocked(smap, service, r, callerFg, addToStarting);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有一种重要的标记符callerFg, 用于标记是前台还是后台:</p>
<ul>
<li>当发起方进程不等于Process.THREAD_GROUP_BG_NONINTERACTIVE,或者发起方为空, 则callerFg= true;</li>
<li>否则,callerFg= false;</li>
</ul>
<h3 id="8-AS-startServiceInnerLocked"><a href="#8-AS-startServiceInnerLocked" class="headerlink" title="8. AS.startServiceInnerLocked"></a>8. AS.startServiceInnerLocked</h3><p>[-&gt; ActiveServices.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ComponentName startServiceInnerLocked(ServiceMap smap, Intent service, ServiceRecord r, boolean callerFg, boolean addToStarting) throws TransactionTooLargeException &#123;</span><br><span class="line">    ProcessStats.ServiceState stracker &#x3D; r.getTracker();</span><br><span class="line">    if (stracker !&#x3D; null) &#123;</span><br><span class="line">        stracker.setStarted(true, mAm.mProcessStats.getMemFactorLocked(), r.lastActivity);</span><br><span class="line">    &#125;</span><br><span class="line">    r.callStart &#x3D; false;</span><br><span class="line">    synchronized (r.stats.getBatteryStats()) &#123;</span><br><span class="line">        r.stats.startRunningLocked(); &#x2F;&#x2F;用于耗电统计，开启运行的状态</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;【见流程9】</span><br><span class="line">    String error &#x3D; bringUpServiceLocked(r, service.getFlags(), callerFg, false);</span><br><span class="line">    if (error !&#x3D; null) &#123;</span><br><span class="line">        return new ComponentName(&quot;!!&quot;, error);</span><br><span class="line">    &#125;</span><br><span class="line">    if (r.startRequested &amp;&amp; addToStarting) &#123;</span><br><span class="line">        boolean first &#x3D; smap.mStartingBackground.size() &#x3D;&#x3D; 0;</span><br><span class="line">        smap.mStartingBackground.add(r);</span><br><span class="line">        r.startingBgTimeout &#x3D; SystemClock.uptimeMillis() + BG_START_TIMEOUT;</span><br><span class="line">        if (first) &#123;</span><br><span class="line">            smap.rescheduleDelayedStarts();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else if (callerFg) &#123;</span><br><span class="line">        smap.ensureNotStartingBackground(r);</span><br><span class="line">    &#125;</span><br><span class="line">    return r.name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-AS-bringUpServiceLocked"><a href="#9-AS-bringUpServiceLocked" class="headerlink" title="9. AS.bringUpServiceLocked"></a>9. AS.bringUpServiceLocked</h3><p>[-&gt; ActiveServices.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">private final String bringUpServiceLocked(ServiceRecord r, int intentFlags, boolean execInFg, boolean whileRestarting) throws TransactionTooLargeException &#123;</span><br><span class="line">    if (r.app !&#x3D; null &amp;&amp; r.app.thread !&#x3D; null) &#123;</span><br><span class="line">        &#x2F;&#x2F;调用service.onStartCommand()过程</span><br><span class="line">        sendServiceArgsLocked(r, execInFg, false);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!whileRestarting &amp;&amp; r.restartDelay &gt; 0) &#123;</span><br><span class="line">        return null; &#x2F;&#x2F;等待延迟重启的过程，则直接返回</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 启动service前，把service从重启服务队列中移除</span><br><span class="line">    if (mRestartingServices.remove(r)) &#123;</span><br><span class="line">        r.resetRestartCounter();</span><br><span class="line">        clearRestartingIfNeededLocked(r);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;service正在启动，将delayed设置为false</span><br><span class="line">    if (r.delayed) &#123;</span><br><span class="line">        getServiceMap(r.userId).mDelayedStartList.remove(r);</span><br><span class="line">        r.delayed &#x3D; false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;确保拥有该服务的user已经启动，否则停止；</span><br><span class="line">    if (mAm.mStartedUsers.get(r.userId) &#x3D;&#x3D; null) &#123;</span><br><span class="line">        String msg &#x3D; &quot;&quot;;</span><br><span class="line">        bringDownServiceLocked(r);</span><br><span class="line">        return msg;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;服务正在启动，设置package停止状态为false</span><br><span class="line">    AppGlobals.getPackageManager().setPackageStoppedState(</span><br><span class="line">            r.packageName, false, r.userId);</span><br><span class="line"></span><br><span class="line">    final boolean isolated &#x3D; (r.serviceInfo.flags&amp;ServiceInfo.FLAG_ISOLATED_PROCESS) !&#x3D; 0;</span><br><span class="line">    final String procName &#x3D; r.processName;</span><br><span class="line">    ProcessRecord app;</span><br><span class="line">    if (!isolated) &#123;</span><br><span class="line">        &#x2F;&#x2F;根据进程名和uid，查询ProcessRecord</span><br><span class="line">        app &#x3D; mAm.getProcessRecordLocked(procName, r.appInfo.uid, false);</span><br><span class="line">        if (app !&#x3D; null &amp;&amp; app.thread !&#x3D; null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                app.addPackage(r.appInfo.packageName, r.appInfo.versionCode, mAm.mProcessStats);</span><br><span class="line">                &#x2F;&#x2F; 启动服务 【见流程10】</span><br><span class="line">                realStartServiceLocked(r, app, execInFg);</span><br><span class="line">                return null;</span><br><span class="line">            &#125; catch (TransactionTooLargeException e) &#123;</span><br><span class="line">                throw e;</span><br><span class="line">            &#125; catch (RemoteException e) &#123;</span><br><span class="line">                Slog.w(TAG, &quot;Exception when starting service &quot; + r.shortName, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        app &#x3D; r.isolatedProc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;对于进程没有启动的情况</span><br><span class="line">    if (app &#x3D;&#x3D; null) &#123;</span><br><span class="line">        &#x2F;&#x2F;启动service所要运行的进程 【见流程9.1】</span><br><span class="line">        if ((app&#x3D;mAm.startProcessLocked(procName, r.appInfo, true, intentFlags,</span><br><span class="line">                &quot;service&quot;, r.name, false, isolated, false)) &#x3D;&#x3D; null) &#123;</span><br><span class="line">            String msg &#x3D; &quot;&quot;</span><br><span class="line">            bringDownServiceLocked(r); &#x2F;&#x2F; 进程启动失败</span><br><span class="line">            return msg;</span><br><span class="line">        &#125;</span><br><span class="line">        if (isolated) &#123;</span><br><span class="line">            r.isolatedProc &#x3D; app;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!mPendingServices.contains(r)) &#123;</span><br><span class="line">        mPendingServices.add(r);</span><br><span class="line">    &#125;</span><br><span class="line">    if (r.delayedStop) &#123;</span><br><span class="line">        r.delayedStop &#x3D; false;</span><br><span class="line">        if (r.startRequested) &#123;</span><br><span class="line">            stopServiceLocked(r); &#x2F;&#x2F;停止服务</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>当目标进程已存在，则直接执行realStartServiceLocked()；</li>
<li>当目标进程不存在，则先执行<a href="http://gityuan.com/2016/10/09/app-process-create-2/" target="_blank" rel="noopener">startProcessLocked</a>创建进程， 经过层层调用最后会调用到AMS.attachApplicationLocked, 然后再执行realStartServiceLocked()。</li>
</ul>
<p>对于非前台进程调用而需要启动的服务，如果已经有其他的后台服务正在启动中，那么我们可能希望延迟其启动。这是用来避免启动同时启动过多的进程(非必须的)。</p>
<h4 id="9-1-AMS-attachApplicationLocked"><a href="#9-1-AMS-attachApplicationLocked" class="headerlink" title="9.1 AMS.attachApplicationLocked"></a>9.1 AMS.attachApplicationLocked</h4><p>[-&gt; ActivityManagerService.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private final boolean attachApplicationLocked(IApplicationThread thread, int pid) &#123;</span><br><span class="line">    ...</span><br><span class="line">    thread.bindApplication(processName, appInfo, providers, app.instrumentationClass,</span><br><span class="line">            profilerInfo, app.instrumentationArguments, app.instrumentationWatcher,</span><br><span class="line">            app.instrumentationUiAutomationConnection, testMode, enableOpenGlTrace,</span><br><span class="line">            isRestrictedBackupMode || !normalMode, app.persistent,</span><br><span class="line">            new Configuration(mConfiguration), app.compat,</span><br><span class="line">            getCommonServicesLocked(app.isolated),</span><br><span class="line">            mCoreSettingsObserver.getCoreSettingsLocked());</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    if (!badApp) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            &#x2F;&#x2F;寻找所有需要在该进程中运行的服务 【见流程9.2】</span><br><span class="line">            didSomething |&#x3D; mServices.attachApplicationLocked(app, processName);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            badApp &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="9-2-AS-attachApplicationLocked"><a href="#9-2-AS-attachApplicationLocked" class="headerlink" title="9.2 AS.attachApplicationLocked"></a>9.2 AS.attachApplicationLocked</h4><p>[-&gt; ActiveServices.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">boolean attachApplicationLocked(ProcessRecord proc, String processName) throws RemoteException &#123;</span><br><span class="line">    boolean didSomething &#x3D; false;</span><br><span class="line">    &#x2F;&#x2F;启动mPendingServices队列中，等待在该进程启动的服务</span><br><span class="line">    if (mPendingServices.size() &gt; 0) &#123;</span><br><span class="line">        ServiceRecord sr &#x3D; null;</span><br><span class="line">        try &#123;</span><br><span class="line">            for (int i&#x3D;0; i&lt;mPendingServices.size(); i++) &#123;</span><br><span class="line">                sr &#x3D; mPendingServices.get(i);</span><br><span class="line">                if (proc !&#x3D; sr.isolatedProc &amp;&amp; (proc.uid !&#x3D; sr.appInfo.uid</span><br><span class="line">                        || !processName.equals(sr.processName))) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                mPendingServices.remove(i);</span><br><span class="line">                i--;</span><br><span class="line">                &#x2F;&#x2F; 将当前服务的包信息加入到proc</span><br><span class="line">                proc.addPackage(sr.appInfo.packageName, sr.appInfo.versionCode,</span><br><span class="line">                        mAm.mProcessStats);</span><br><span class="line">                &#x2F;&#x2F; 启动服务，即将进入服务的生命周期 【见流程10】</span><br><span class="line">                realStartServiceLocked(sr, proc, sr.createdFromFg);</span><br><span class="line">                didSomething &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (RemoteException e) &#123;</span><br><span class="line">            Slog.w(TAG, &quot;Exception in new application when starting service &quot;</span><br><span class="line">                    + sr.shortName, e);</span><br><span class="line">            throw e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 对于正在等待重启并需要运行在该进程的服务，现在是启动它们的大好时机</span><br><span class="line">    if (mRestartingServices.size() &gt; 0) &#123;</span><br><span class="line">        ServiceRecord sr &#x3D; null;</span><br><span class="line">        for (int i&#x3D;0; i&lt;mRestartingServices.size(); i++) &#123;</span><br><span class="line">            sr &#x3D; mRestartingServices.get(i);</span><br><span class="line">            if (proc !&#x3D; sr.isolatedProc &amp;&amp; (proc.uid !&#x3D; sr.appInfo.uid</span><br><span class="line">                    || !processName.equals(sr.processName))) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            mAm.mHandler.removeCallbacks(sr.restarter);</span><br><span class="line">            mAm.mHandler.post(sr.restarter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return didSomething;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>当需要创建新进程,则创建后经历过attachApplicationLocked,则会再调用realStartServiceLocked();</li>
<li>当不需要创建进程, 即在[流程9]中直接就进入了realStartServiceLocked();</li>
</ul>
<h3 id="10-AS-realStartServiceLocked"><a href="#10-AS-realStartServiceLocked" class="headerlink" title="10. AS.realStartServiceLocked"></a>10. AS.realStartServiceLocked</h3><p>[-&gt; ActiveServices.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">private final void realStartServiceLocked(ServiceRecord r, ProcessRecord app, boolean execInFg) throws RemoteException &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    r.app &#x3D; app;</span><br><span class="line">    r.restartTime &#x3D; r.lastActivity &#x3D; SystemClock.uptimeMillis();</span><br><span class="line">    final boolean newService &#x3D; app.services.add(r);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;发送delay消息【见流程10.1】</span><br><span class="line">    bumpServiceExecutingLocked(r, execInFg, &quot;create&quot;);</span><br><span class="line">    mAm.updateLruProcessLocked(app, false, null);</span><br><span class="line">    mAm.updateOomAdjLocked();</span><br><span class="line">    boolean created &#x3D; false;</span><br><span class="line">    try &#123;</span><br><span class="line">        synchronized (r.stats.getBatteryStats()) &#123;</span><br><span class="line">            r.stats.startLaunchedLocked();</span><br><span class="line">        &#125;</span><br><span class="line">        mAm.ensurePackageDexOpt(r.serviceInfo.packageName);</span><br><span class="line">        app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</span><br><span class="line">        &#x2F;&#x2F;服务进入 onCreate() 【见流程11】</span><br><span class="line">        app.thread.scheduleCreateService(r, r.serviceInfo,</span><br><span class="line">                mAm.compatibilityInfoForPackageLocked(r.serviceInfo.applicationInfo),</span><br><span class="line">                app.repProcState);</span><br><span class="line">        r.postNotification();</span><br><span class="line">        created &#x3D; true;</span><br><span class="line">    &#125; catch (DeadObjectException e) &#123;</span><br><span class="line">        mAm.appDiedLocked(app); &#x2F;&#x2F;应用死亡处理</span><br><span class="line">        throw e;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (!created) &#123;</span><br><span class="line">            final boolean inDestroying &#x3D; mDestroyingServices.contains(r);</span><br><span class="line">            serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line">            if (newService) &#123;</span><br><span class="line">                app.services.remove(r);</span><br><span class="line">                r.app &#x3D; null;</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F;尝试重新启动服务</span><br><span class="line">            if (!inDestroying) &#123;</span><br><span class="line">                scheduleServiceRestartLocked(r, false);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    requestServiceBindingsLocked(r, execInFg);</span><br><span class="line">    updateServiceClientActivitiesLocked(app, null, true);</span><br><span class="line"></span><br><span class="line">    if (r.startRequested &amp;&amp; r.callStart &amp;&amp; r.pendingStarts.size() &#x3D;&#x3D; 0) &#123;</span><br><span class="line">        r.pendingStarts.add(new ServiceRecord.StartItem(r, false, r.makeNextStartId(),</span><br><span class="line">                null, null));</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;服务 进入onStartCommand() 【见流程17】</span><br><span class="line">    sendServiceArgsLocked(r, execInFg, true);</span><br><span class="line">    if (r.delayed) &#123;</span><br><span class="line">        getServiceMap(r.userId).mDelayedStartList.remove(r);</span><br><span class="line">        r.delayed &#x3D; false;</span><br><span class="line">    &#125;</span><br><span class="line">    if (r.delayedStop) &#123;</span><br><span class="line">        r.delayedStop &#x3D; false;</span><br><span class="line">        if (r.startRequested) &#123;</span><br><span class="line">            stopServiceLocked(r); &#x2F;&#x2F;停止服务</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在bumpServiceExecutingLocked会发送一个延迟处理的消息SERVICE_TIMEOUT_MSG。在方法scheduleCreateService执行完成，也就是onCreate回调执行完成之后，便会remove掉该消息。但是如果没能在延时时间之内remove该消息，则会进入执行service timeout流程。</p>
<h4 id="10-1-AS-bumpServiceExecutingLocked"><a href="#10-1-AS-bumpServiceExecutingLocked" class="headerlink" title="10.1 AS.bumpServiceExecutingLocked"></a>10.1 AS.bumpServiceExecutingLocked</h4><p>[-&gt; ActiveServices.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private final void bumpServiceExecutingLocked(ServiceRecord r, boolean fg, String why) &#123;</span><br><span class="line">    long now &#x3D; SystemClock.uptimeMillis();</span><br><span class="line">    if (r.executeNesting &#x3D;&#x3D; 0) &#123;</span><br><span class="line">        r.executeFg &#x3D; fg;</span><br><span class="line">        ...</span><br><span class="line">        if (r.app !&#x3D; null) &#123;</span><br><span class="line">            r.app.executingServices.add(r);</span><br><span class="line">            r.app.execServicesFg |&#x3D; fg;</span><br><span class="line">            if (r.app.executingServices.size() &#x3D;&#x3D; 1) &#123;</span><br><span class="line">                scheduleServiceTimeoutLocked(r.app);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else if (r.app !&#x3D; null &amp;&amp; fg &amp;&amp; !r.app.execServicesFg) &#123;</span><br><span class="line">        r.app.execServicesFg &#x3D; true;</span><br><span class="line">        &#x2F;&#x2F;[见流程10.2]</span><br><span class="line">        scheduleServiceTimeoutLocked(r.app);</span><br><span class="line">    &#125;</span><br><span class="line">    r.executeFg |&#x3D; fg;</span><br><span class="line">    r.executeNesting++;</span><br><span class="line">    r.executingStart &#x3D; now;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="10-2-scheduleServiceTimeoutLocked"><a href="#10-2-scheduleServiceTimeoutLocked" class="headerlink" title="10.2 scheduleServiceTimeoutLocked"></a>10.2 scheduleServiceTimeoutLocked</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">void scheduleServiceTimeoutLocked(ProcessRecord proc) &#123;</span><br><span class="line">    if (proc.executingServices.size() &#x3D;&#x3D; 0 || proc.thread &#x3D;&#x3D; null) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    long now &#x3D; SystemClock.uptimeMillis();</span><br><span class="line">    Message msg &#x3D; mAm.mHandler.obtainMessage(</span><br><span class="line">            ActivityManagerService.SERVICE_TIMEOUT_MSG);</span><br><span class="line">    msg.obj &#x3D; proc;</span><br><span class="line">    &#x2F;&#x2F;当超时后仍没有remove该SERVICE_TIMEOUT_MSG消息，则执行service Timeout流程</span><br><span class="line">    mAm.mHandler.sendMessageAtTime(msg,</span><br><span class="line">            proc.execServicesFg ? (now+SERVICE_TIMEOUT) : (now+ SERVICE_BACKGROUND_TIMEOUT));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发送延时消息SERVICE_TIMEOUT_MSG,延时时长：</p>
<ul>
<li>对于前台服务，则超时为SERVICE_TIMEOUT，即timeout=20s；</li>
<li>对于后台服务，则超时为SERVICE_BACKGROUND_TIMEOUT，即timeout=200s；</li>
</ul>
<h3 id="11-ATP-scheduleCreateService"><a href="#11-ATP-scheduleCreateService" class="headerlink" title="11. ATP.scheduleCreateService"></a>11. ATP.scheduleCreateService</h3><p>[-&gt; ApplicationThreadProxy.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public final void scheduleCreateService(IBinder token, ServiceInfo info, CompatibilityInfo compatInfo, int processState) throws RemoteException &#123;</span><br><span class="line">    Parcel data &#x3D; Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IApplicationThread.descriptor);</span><br><span class="line">    data.writeStrongBinder(token);</span><br><span class="line">    info.writeToParcel(data, 0);</span><br><span class="line">    compatInfo.writeToParcel(data, 0);</span><br><span class="line">    data.writeInt(processState);</span><br><span class="line">    try &#123;</span><br><span class="line">        &#x2F;&#x2F;【见流程12】</span><br><span class="line">        mRemote.transact(SCHEDULE_CREATE_SERVICE_TRANSACTION, data, null, IBinder.FLAG_ONEWAY);</span><br><span class="line">    &#125; catch (TransactionTooLargeException e) &#123;</span><br><span class="line">        throw e;</span><br><span class="line">    &#125;</span><br><span class="line">    data.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="四-目标进程端"><a href="#四-目标进程端" class="headerlink" title="四. 目标进程端"></a>四. 目标进程端</h2><p>借助于ATP/ATN这对Binder对象，便完成了从system_server所在进程到Service所在进程调用过程</p>
<h3 id="12-ATN-onTransact"><a href="#12-ATN-onTransact" class="headerlink" title="12. ATN.onTransact"></a>12. ATN.onTransact</h3><p>[-&gt; ApplicationThreadNative.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public boolean onTransact(int code, Parcel data, Parcel reply, int flags) throws RemoteException &#123;</span><br><span class="line">    switch (code) &#123;</span><br><span class="line">    case SCHEDULE_CREATE_SERVICE_TRANSACTION: &#123;</span><br><span class="line">        data.enforceInterface(IApplicationThread.descriptor);</span><br><span class="line">        IBinder token &#x3D; data.readStrongBinder();</span><br><span class="line">        ServiceInfo info &#x3D; ServiceInfo.CREATOR.createFromParcel(data);</span><br><span class="line">        CompatibilityInfo compatInfo &#x3D; CompatibilityInfo.CREATOR.createFromParcel(data);</span><br><span class="line">        int processState &#x3D; data.readInt();</span><br><span class="line">        &#x2F;&#x2F; 【见流程13】</span><br><span class="line">        scheduleCreateService(token, info, compatInfo, processState);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="13-AT-scheduleCreateService"><a href="#13-AT-scheduleCreateService" class="headerlink" title="13. AT.scheduleCreateService"></a>13. AT.scheduleCreateService</h3><p>[-&gt; ApplicationThread.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public final void scheduleCreateService(IBinder token, ServiceInfo info, CompatibilityInfo compatInfo, int processState) &#123;</span><br><span class="line">    updateProcessState(processState, false);</span><br><span class="line">    CreateServiceData s &#x3D; new CreateServiceData(); &#x2F;&#x2F;准备服务创建所需的数据</span><br><span class="line">    s.token &#x3D; token;</span><br><span class="line">    s.info &#x3D; info;</span><br><span class="line">    s.compatInfo &#x3D; compatInfo;</span><br><span class="line">    &#x2F;&#x2F;发送消息 【见流程14】</span><br><span class="line">    sendMessage(H.CREATE_SERVICE, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法的执行在ActivityThread线程</p>
<h4 id="14-handleMessage"><a href="#14-handleMessage" class="headerlink" title="14. handleMessage"></a>14. handleMessage</h4><p>[-&gt; ActivityThread.java ::H]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public void handleMessage(Message msg) &#123;</span><br><span class="line">    switch (msg.what) &#123;</span><br><span class="line">        ...</span><br><span class="line">        case CREATE_SERVICE:</span><br><span class="line">            handleCreateService((CreateServiceData)msg.obj); &#x2F;&#x2F;【见流程15】</span><br><span class="line">            break;</span><br><span class="line">        case BIND_SERVICE:</span><br><span class="line">            handleBindService((BindServiceData)msg.obj);</span><br><span class="line">            break;</span><br><span class="line">        case UNBIND_SERVICE:</span><br><span class="line">            handleUnbindService((BindServiceData)msg.obj);</span><br><span class="line">            break;</span><br><span class="line">        case SERVICE_ARGS:</span><br><span class="line">            handleServiceArgs((ServiceArgsData)msg.obj);  &#x2F;&#x2F; serviceStart</span><br><span class="line">            break;</span><br><span class="line">        case STOP_SERVICE:</span><br><span class="line">            handleStopService((IBinder)msg.obj);</span><br><span class="line">            maybeSnapshot();</span><br><span class="line">            break;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="15-AT-handleCreateService"><a href="#15-AT-handleCreateService" class="headerlink" title="15. AT.handleCreateService"></a>15. AT.handleCreateService</h3><p>[-&gt; ActivityThread.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">private void handleCreateService(CreateServiceData data) &#123;</span><br><span class="line">    &#x2F;&#x2F;当应用处于后台即将进行GC，而此时被调回到活动状态，则跳过本次gc。</span><br><span class="line">    unscheduleGcIdler();</span><br><span class="line">    LoadedApk packageInfo &#x3D; getPackageInfoNoCheck(data.info.applicationInfo, data.compatInfo);</span><br><span class="line"></span><br><span class="line">    java.lang.ClassLoader cl &#x3D; packageInfo.getClassLoader();</span><br><span class="line">    &#x2F;&#x2F;通过反射创建目标服务对象</span><br><span class="line">    Service service &#x3D; (Service) cl.loadClass(data.info.name).newInstance();</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        &#x2F;&#x2F;创建ContextImpl对象</span><br><span class="line">        ContextImpl context &#x3D; ContextImpl.createAppContext(this, packageInfo);</span><br><span class="line">        context.setOuterContext(service);</span><br><span class="line">        &#x2F;&#x2F;创建Application对象</span><br><span class="line">        Application app &#x3D; packageInfo.makeApplication(false, mInstrumentation);</span><br><span class="line">        service.attach(context, this, data.info.name, data.token, app,</span><br><span class="line">                ActivityManagerNative.getDefault());</span><br><span class="line">        &#x2F;&#x2F;调用服务onCreate()方法 【见流程15.1】</span><br><span class="line">        service.onCreate();</span><br><span class="line">        mServices.put(data.token, service);</span><br><span class="line">        &#x2F;&#x2F;调用服务创建完成【见流程16】</span><br><span class="line">        ActivityManagerNative.getDefault().serviceDoneExecuting(</span><br><span class="line">                data.token, SERVICE_DONE_EXECUTING_ANON, 0, 0);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="15-1-Service-onCreate"><a href="#15-1-Service-onCreate" class="headerlink" title="15.1 Service.onCreate"></a>15.1 Service.onCreate</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public abstract class Service extends ContextWrapper implements ComponentCallbacks2 &#123;</span><br><span class="line">    public void onCreate()&#123;    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终调用Service.onCreate()方法，对于目标服务都是继承于Service，并覆写该方式，调用目标服务的onCreate()方法。拨云见日，到此总算是进入了Service的生命周期。</p>
<h3 id="16-AMS-serviceDoneExecuting"><a href="#16-AMS-serviceDoneExecuting" class="headerlink" title="16 AMS.serviceDoneExecuting"></a>16 AMS.serviceDoneExecuting</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public void serviceDoneExecuting(IBinder token, int type, int startId, int res) &#123;</span><br><span class="line">    synchronized(this) &#123;</span><br><span class="line">        ...</span><br><span class="line">        &#x2F;&#x2F; [见流程16.1]</span><br><span class="line">        mServices.serviceDoneExecutingLocked((ServiceRecord)token, type, startId, res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由[流程10.1]的bumpServiceExecutingLocked()发送一个延时消息SERVICE_TIMEOUT_MSG</p>
<h4 id="16-1-AS-serviceDoneExecutingLocked"><a href="#16-1-AS-serviceDoneExecutingLocked" class="headerlink" title="16.1 AS.serviceDoneExecutingLocked"></a>16.1 AS.serviceDoneExecutingLocked</h4><p>[-&gt; ActiveServices.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void serviceDoneExecutingLocked(ServiceRecord r, int type, int startId, int res) &#123;</span><br><span class="line">    boolean inDestroying &#x3D; mDestroyingServices.contains(r);</span><br><span class="line">    if (r !&#x3D; null) &#123;</span><br><span class="line">        ...</span><br><span class="line">        final long origId &#x3D; Binder.clearCallingIdentity();</span><br><span class="line">        &#x2F;&#x2F; [见流程16.2]</span><br><span class="line">        serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="16-2-serviceDoneExecutingLocked"><a href="#16-2-serviceDoneExecutingLocked" class="headerlink" title="16.2 serviceDoneExecutingLocked"></a>16.2 serviceDoneExecutingLocked</h4><p>[-&gt; ActiveServices.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">private void serviceDoneExecutingLocked(ServiceRecord r, boolean inDestroying, boolean finishing) &#123;</span><br><span class="line">    r.executeNesting--;</span><br><span class="line">    if (r.executeNesting &lt;&#x3D; 0) &#123;</span><br><span class="line">        if (r.app !&#x3D; null) &#123;</span><br><span class="line">            r.app.execServicesFg &#x3D; false;</span><br><span class="line">            r.app.executingServices.remove(r);</span><br><span class="line">            if (r.app.executingServices.size() &#x3D;&#x3D; 0) &#123;</span><br><span class="line">                &#x2F;&#x2F;移除服务启动超时的消息</span><br><span class="line">                mAm.mHandler.removeMessages(ActivityManagerService.SERVICE_TIMEOUT_MSG, r.app);</span><br><span class="line">            &#125; else if (r.executeFg) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">            if (inDestroying) &#123;</span><br><span class="line">                mDestroyingServices.remove(r);</span><br><span class="line">                r.bindings.clear();</span><br><span class="line">            &#125;</span><br><span class="line">            mAm.updateOomAdjLocked(r.app);</span><br><span class="line">        &#125;</span><br><span class="line">        r.executeFg &#x3D; false;</span><br><span class="line">        ...</span><br><span class="line">        if (finishing) &#123;</span><br><span class="line">            if (r.app !&#x3D; null &amp;&amp; !r.app.persistent) &#123;</span><br><span class="line">                r.app.services.remove(r);</span><br><span class="line">            &#125;</span><br><span class="line">            r.app &#x3D; null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>handleCreateService()执行后便会移除服务启动超时的消息SERVICE_TIMEOUT_MSG。 Service启动过程出现ANR，”executing service [发送超时serviceRecord信息]”， 这往往是service的onCreate()回调方法执行时间过长。</p>
<p>前面小节[10]realStartServiceLocked方法在完成onCreate操作,解析来便是进入onStartCommand方法. 见下文.</p>
<h3 id="17-AS-sendServiceArgsLocked"><a href="#17-AS-sendServiceArgsLocked" class="headerlink" title="17. AS.sendServiceArgsLocked"></a>17. AS.sendServiceArgsLocked</h3><p>[-&gt; ActiveServices.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">private final void sendServiceArgsLocked(ServiceRecord r, boolean execInFg, boolean oomAdjusted) throws TransactionTooLargeException &#123;</span><br><span class="line">    final int N &#x3D; r.pendingStarts.size();</span><br><span class="line">    if (N &#x3D;&#x3D; 0) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    while (r.pendingStarts.size() &gt; 0) &#123;</span><br><span class="line">        Exception caughtException &#x3D; null;</span><br><span class="line">        ServiceRecord.StartItem si;</span><br><span class="line">        try &#123;</span><br><span class="line">            si &#x3D; r.pendingStarts.remove(0);</span><br><span class="line">            if (si.intent &#x3D;&#x3D; null &amp;&amp; N &gt; 1) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            si.deliveredTime &#x3D; SystemClock.uptimeMillis();</span><br><span class="line">            r.deliveredStarts.add(si);</span><br><span class="line">            si.deliveryCount++;</span><br><span class="line">            if (si.neededGrants !&#x3D; null) &#123;</span><br><span class="line">                mAm.grantUriPermissionUncheckedFromIntentLocked(si.neededGrants,</span><br><span class="line">                        si.getUriPermissionsLocked());</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F;标记启动开始【见10.1】</span><br><span class="line">            bumpServiceExecutingLocked(r, execInFg, &quot;start&quot;);</span><br><span class="line">            if (!oomAdjusted) &#123;</span><br><span class="line">                oomAdjusted &#x3D; true;</span><br><span class="line">                mAm.updateOomAdjLocked(r.app);</span><br><span class="line">            &#125;</span><br><span class="line">            int flags &#x3D; 0;</span><br><span class="line">            if (si.deliveryCount &gt; 1) &#123;</span><br><span class="line">                flags |&#x3D; Service.START_FLAG_RETRY;</span><br><span class="line">            &#125;</span><br><span class="line">            if (si.doneExecutingCount &gt; 0) &#123;</span><br><span class="line">                flags |&#x3D; Service.START_FLAG_REDELIVERY;</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F;该过程类似[流程11~16]，最终会调用onStartCommand</span><br><span class="line">            r.app.thread.scheduleServiceArgs(r, si.taskRemoved, si.id, flags, si.intent);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            ...</span><br><span class="line">            caughtException &#x3D; e;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (caughtException !&#x3D; null) &#123;</span><br><span class="line">            final boolean inDestroying &#x3D; mDestroyingServices.contains(r);</span><br><span class="line">            serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line">            if (caughtException instanceof TransactionTooLargeException) &#123;</span><br><span class="line">                throw (TransactionTooLargeException)caughtException;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[流程10]中的AS.realStartServiceLocked的过程先后依次执行如下方法：</p>
<ul>
<li>执行scheduleCreateService()方法，层层调用最终回调Service.onCreate(); [见流程11~16]</li>
<li>执行scheduleServiceArgs()方法，层层调用最终回调Service.onStartCommand(); [见流程17]，这两个过程类似，此处省略。</li>
</ul>
<h2 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h2><h3 id="5-1-流程说明"><a href="#5-1-流程说明" class="headerlink" title="5.1 流程说明"></a>5.1 流程说明</h3><p>在整个startService过程，从进程角度看服务启动过程</p>
<ul>
<li><strong>Process A进程：</strong>是指调用startService命令所在的进程，也就是启动服务的发起端进程，比如点击桌面App图标，此处Process A便是Launcher所在进程。</li>
<li><strong>system_server进程：</strong>系统进程，是java framework框架的核心载体，里面运行了大量的系统服务，比如这里提供ApplicationThreadProxy（简称ATP），ActivityManagerService（简称AMS），这个两个服务都运行在system_server进程的不同线程中，由于ATP和AMS都是基于IBinder接口，都是binder线程，binder线程的创建与销毁都是由binder驱动来决定的，每个进程binder线程个数的上限为16。</li>
<li><strong>Zygote进程：</strong>是由<code>init</code>进程孵化而来的，用于创建Java层进程的母体，所有的Java层进程都是由Zygote进程孵化而来；</li>
<li><strong>Remote Service进程：</strong>远程服务所在进程，是由Zygote进程孵化而来的用于运行Remote服务的进程。主线程主要负责Activity/Service等组件的生命周期以及UI相关操作都运行在这个线程； 另外，每个App进程中至少会有两个binder线程 ApplicationThread(简称AT)和ActivityManagerProxy（简称AMP），当然还有其他线程，这里不是重点就不提了。</li>
</ul>
<p><img src="http://gityuan.com/images/android-service/start_service/start_service_processes.jpg" alt="start_service_process"></p>
<p>图中涉及3种IPC通信方式：<code>Binder</code>、<code>Socket</code>以及<code>Handler</code>，在图中分别用3种不同的颜色来代表这3种通信方式。一般来说，同一进程内的线程间通信采用的是 <a href="http://gityuan.com/2015/12/26/handler-message/" target="_blank" rel="noopener">Handler消息队列机制</a>，不同进程间的通信采用的是<a href="http://gityuan.com/2015/10/31/binder-prepare/" target="_blank" rel="noopener">binder机制</a>，另外与Zygote进程通信采用的<code>Socket</code>。</p>
<p>启动流程：</p>
<ol>
<li>Process A进程采用Binder IPC向system_server进程发起startService请求；</li>
<li>system_server进程接收到请求后，向zygote进程发送创建进程的请求；</li>
<li>zygote进程fork出新的子进程Remote Service进程；</li>
<li>Remote Service进程，通过Binder IPC向sytem_server进程发起attachApplication请求；</li>
<li>system_server进程在收到请求后，进行一系列准备工作后，再通过binder IPC向remote Service进程发送scheduleCreateService请求；</li>
<li>Remote Service进程的binder线程在收到请求后，通过handler向主线程发送CREATE_SERVICE消息；</li>
<li>主线程在收到Message后，通过发射机制创建目标Service，并回调Service.onCreate()方法。</li>
</ol>
<p>到此，服务便正式启动完成。当创建的是本地服务或者服务所属进程已创建时，则无需经过上述步骤2、3，直接创建服务即可。</p>
<h3 id="5-2-生命周期"><a href="#5-2-生命周期" class="headerlink" title="5.2 生命周期"></a>5.2 生命周期</h3><p>startService的生命周期为onCreate, onStartCommand, onDestroy,流程如下图: <a href="http://www.gityuan.com/images/ams/service_lifeline.jpg" target="_blank" rel="noopener">点击查看大图</a></p>
<p><img src="http://gityuan.com/images/ams/service_lifeline.jpg" alt="service_lifeline"></p>
<p>由上图可见,造成ANR可能的原因有Binder full{step 7, 12}, MessageQueue(step 10), AMS Lock (step 13).</p>
<p>当进程启动Service其所在进程还没有启动时, 需要先启动其目标进程,流程如下图: <a href="http://www.gityuan.com/images/ams/start_service_process.jpg" target="_blank" rel="noopener">点击查看大图</a></p>
<p><img src="http://gityuan.com/images/ams/start_service_process.jpg" alt="start_service_process"></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/" rel="tag"># Android系统分析</a>
          
            <a href="/tags/startService%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/" rel="tag"># startService启动过程分析</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/06/04/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E4%B8%8E%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%85%B3%E7%B3%BB/" rel="next" title="Android四大组件与进程启动的关系">
                <i class="fa fa-chevron-left"></i> Android四大组件与进程启动的关系
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/06/04/Android/Binder/%E5%BD%BB%E5%BA%95%E7%90%86%E8%A7%A3Android%20Binder%E9%80%9A%E4%BF%A1%E6%9E%B6%E6%9E%84/" rel="prev" title="彻底理解Android Binder通信架构">
                彻底理解Android Binder通信架构 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="SOHUCS"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">冯星</p>
              <p class="site-description motion-element" itemprop="description">人生就像是一个马尔可夫链，你的未来取决于你当下正在做的事，而无关于过去做完的事</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7Carchive">
              
                  <span class="site-state-item-count">134</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">36</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">60</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、概述"><span class="nav-number">1.</span> <span class="nav-text">一、概述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-类图"><span class="nav-number">1.0.1.</span> <span class="nav-text">1.1 类图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-流程图"><span class="nav-number">1.0.2.</span> <span class="nav-text">1.2 流程图</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二-发起进程端"><span class="nav-number">2.</span> <span class="nav-text">二. 发起进程端</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-CW-startService"><span class="nav-number">2.1.</span> <span class="nav-text">1. CW.startService</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-CI-startService"><span class="nav-number">2.2.</span> <span class="nav-text">2. CI.startService</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-CI-startServiceCommon"><span class="nav-number">2.3.</span> <span class="nav-text">3. CI.startServiceCommon</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-AMN-getDefault"><span class="nav-number">2.3.1.</span> <span class="nav-text">3.1 AMN.getDefault</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-AMP-startService"><span class="nav-number">2.4.</span> <span class="nav-text">4. AMP.startService</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三-system-server端"><span class="nav-number">3.</span> <span class="nav-text">三. system_server端</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-AMN-onTransact"><span class="nav-number">3.1.</span> <span class="nav-text">5. AMN.onTransact</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-AMS-startService"><span class="nav-number">3.2.</span> <span class="nav-text">6. AMS.startService</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-AS-startServiceLocked"><span class="nav-number">3.3.</span> <span class="nav-text">7. AS.startServiceLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-AS-startServiceInnerLocked"><span class="nav-number">3.4.</span> <span class="nav-text">8. AS.startServiceInnerLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-AS-bringUpServiceLocked"><span class="nav-number">3.5.</span> <span class="nav-text">9. AS.bringUpServiceLocked</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#9-1-AMS-attachApplicationLocked"><span class="nav-number">3.5.1.</span> <span class="nav-text">9.1 AMS.attachApplicationLocked</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-2-AS-attachApplicationLocked"><span class="nav-number">3.5.2.</span> <span class="nav-text">9.2 AS.attachApplicationLocked</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-AS-realStartServiceLocked"><span class="nav-number">3.6.</span> <span class="nav-text">10. AS.realStartServiceLocked</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#10-1-AS-bumpServiceExecutingLocked"><span class="nav-number">3.6.1.</span> <span class="nav-text">10.1 AS.bumpServiceExecutingLocked</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-2-scheduleServiceTimeoutLocked"><span class="nav-number">3.6.2.</span> <span class="nav-text">10.2 scheduleServiceTimeoutLocked</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-ATP-scheduleCreateService"><span class="nav-number">3.7.</span> <span class="nav-text">11. ATP.scheduleCreateService</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四-目标进程端"><span class="nav-number">4.</span> <span class="nav-text">四. 目标进程端</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#12-ATN-onTransact"><span class="nav-number">4.1.</span> <span class="nav-text">12. ATN.onTransact</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-AT-scheduleCreateService"><span class="nav-number">4.2.</span> <span class="nav-text">13. AT.scheduleCreateService</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#14-handleMessage"><span class="nav-number">4.2.1.</span> <span class="nav-text">14. handleMessage</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15-AT-handleCreateService"><span class="nav-number">4.3.</span> <span class="nav-text">15. AT.handleCreateService</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#15-1-Service-onCreate"><span class="nav-number">4.3.1.</span> <span class="nav-text">15.1 Service.onCreate</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-AMS-serviceDoneExecuting"><span class="nav-number">4.4.</span> <span class="nav-text">16 AMS.serviceDoneExecuting</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#16-1-AS-serviceDoneExecutingLocked"><span class="nav-number">4.4.1.</span> <span class="nav-text">16.1 AS.serviceDoneExecutingLocked</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#16-2-serviceDoneExecutingLocked"><span class="nav-number">4.4.2.</span> <span class="nav-text">16.2 serviceDoneExecutingLocked</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-AS-sendServiceArgsLocked"><span class="nav-number">4.5.</span> <span class="nav-text">17. AS.sendServiceArgsLocked</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五、总结"><span class="nav-number">5.</span> <span class="nav-text">五、总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-流程说明"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 流程说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-生命周期"><span class="nav-number">5.2.</span> <span class="nav-text">5.2 生命周期</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">冯星</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'bbc85MrQ0qhACWJxhCKrJoAj-gzGzoHsz',
        appKey: 'fWH5REKFSsGT4TKe1lWt1ke4',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
