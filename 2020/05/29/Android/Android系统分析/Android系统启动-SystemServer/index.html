<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Android系统启动-SystemServer," />










<meta name="description" content="12345678910111213&#x2F;frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;com&#x2F;android&#x2F;internal&#x2F;os&#x2F;  - ZygoteInit.java  - RuntimeInit.java  - Zygote.java&#x2F;frameworks&#x2F;base&#x2F;c">
<meta property="og:type" content="article">
<meta property="og:title" content="Android系统启动-SystemServer">
<meta property="og:url" content="http://yoursite.com/2020/05/29/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8-SystemServer/index.html">
<meta property="og:site_name" content="冯星的博客">
<meta property="og:description" content="12345678910111213&#x2F;frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;com&#x2F;android&#x2F;internal&#x2F;os&#x2F;  - ZygoteInit.java  - RuntimeInit.java  - Zygote.java&#x2F;frameworks&#x2F;base&#x2F;c">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://gityuan.com/images/boot/systemServer/system_server.jpg">
<meta property="og:image" content="http://gityuan.com/images/boot/systemServer/system_server_boot_process.jpg">
<meta property="article:published_time" content="2020-05-29T03:05:49.000Z">
<meta property="article:modified_time" content="2020-05-31T18:06:53.183Z">
<meta property="article:author" content="冯星">
<meta property="article:tag" content="Android系统启动-SystemServer">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://gityuan.com/images/boot/systemServer/system_server.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/05/29/Android/Android系统分析/Android系统启动-SystemServer/"/>





  <title>Android系统启动-SystemServer | 冯星的博客</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">冯星的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Life is like a Markov chain, your future only depends on what you are doing now, and independent of your past.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/29/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8-SystemServer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="冯星">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冯星的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android系统启动-SystemServer</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-29T11:05:49+08:00">
                2020-05-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/" itemprop="url" rel="index">
                    <span itemprop="name">Android系统分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/05/29/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8-SystemServer/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/05/29/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8-SystemServer/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;com&#x2F;android&#x2F;internal&#x2F;os&#x2F;</span><br><span class="line">  - ZygoteInit.java</span><br><span class="line">  - RuntimeInit.java</span><br><span class="line">  - Zygote.java</span><br><span class="line"></span><br><span class="line">&#x2F;frameworks&#x2F;base&#x2F;core&#x2F;services&#x2F;java&#x2F;com&#x2F;android&#x2F;server&#x2F;</span><br><span class="line">  - SystemServer.java</span><br><span class="line"></span><br><span class="line">&#x2F;frameworks&#x2F;base&#x2F;core&#x2F;jni&#x2F;</span><br><span class="line">  - com_android_internal_os_Zygote.cpp</span><br><span class="line">  - AndroidRuntime.cpp</span><br><span class="line"></span><br><span class="line">&#x2F;frameworks&#x2F;base&#x2F;cmds&#x2F;app_process&#x2F;App_main.cpp</span><br></pre></td></tr></table></figure>

<h1 id="启动流程"><a href="#启动流程" class="headerlink" title="启动流程"></a>启动流程</h1><p>SystemServer的在Android体系中所处的地位，SystemServer由Zygote fork生成的，进程名为<code>system_server</code>，该进程承载着framework的核心服务。 <a href="http://gityuan.com/2016/02/13/android-zygote/" target="_blank" rel="noopener">Android系统启动-zygote篇</a>中讲到Zygote启动过程中会调用startSystemServer()，可知<code>startSystemServer()</code>函数是system_server启动流程的起点， 启动流程图如下：<img src="http://gityuan.com/images/boot/systemServer/system_server.jpg" alt="system_server_boot_process"></p>
<p>上图前4步骤（即颜色为紫色的流程）运行在是<code>Zygote</code>进程，从第5步（即颜色为蓝色的流程）ZygoteInit.handleSystemServerProcess开始是运行在新创建的<code>system_server</code>，这是fork机制实现的（fork会返回2次）。下面从startSystemServer()开始讲解详细启动流程。</p>
<h2 id="ZygoteInit"><a href="#ZygoteInit" class="headerlink" title="ZygoteInit"></a><code>ZygoteInit</code></h2><p>在Android9.0版本是在main方法中直接调用,开启system_server后直接运行。</p>
<h3 id="main"><a href="#main" class="headerlink" title="main()"></a><code>main()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String argv[]) &#123;</span><br><span class="line">		...</span><br><span class="line">	if (startSystemServer) &#123;</span><br><span class="line">                Runnable r &#x3D; forkSystemServer(abiList, socketName, zygoteServer);</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; &#123;@code r &#x3D;&#x3D; null&#125; in the parent (zygote) process, and &#123;@code r !&#x3D; null&#125; in the</span><br><span class="line">                &#x2F;&#x2F; child (system_server) process.</span><br><span class="line">                if (r !&#x3D; null) &#123;</span><br><span class="line">                    r.run();</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="forkSystemServer"><a href="#forkSystemServer" class="headerlink" title="forkSystemServer()"></a><code>forkSystemServer()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">private static Runnable forkSystemServer(String abiList, String socketName,</span><br><span class="line">            ZygoteServer zygoteServer) &#123;</span><br><span class="line">        &#x2F;* Hardcoded command line to start the system server *&#x2F;</span><br><span class="line">            &#x2F;&#x2F;参数准备</span><br><span class="line">        String args[] &#x3D; &#123;</span><br><span class="line">            &quot;--setuid&#x3D;1000&quot;,</span><br><span class="line">            &quot;--setgid&#x3D;1000&quot;,</span><br><span class="line">            &quot;--setgroups&#x3D;1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,1024,1032,1065,3001,3002,3003,3006,3007,3009,3010&quot;,</span><br><span class="line">            &quot;--capabilities&#x3D;&quot; + capabilities + &quot;,&quot; + capabilities,</span><br><span class="line">            &quot;--nice-name&#x3D;system_server&quot;,</span><br><span class="line">            &quot;--runtime-args&quot;,</span><br><span class="line">            &quot;--target-sdk-version&#x3D;&quot; + VMRuntime.SDK_VERSION_CUR_DEVELOPMENT,</span><br><span class="line">            &quot;com.android.server.SystemServer&quot;,</span><br><span class="line">        &#125;;</span><br><span class="line">        ZygoteConnection.Arguments parsedArgs &#x3D; null;</span><br><span class="line"></span><br><span class="line">        int pid;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line"> 		        &#x2F;&#x2F;用于解析参数，生成目标格式</span><br><span class="line">            parsedArgs &#x3D; new ZygoteConnection.Arguments(args);</span><br><span class="line">            ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);</span><br><span class="line">            ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);</span><br><span class="line"></span><br><span class="line">            boolean profileSystemServer &#x3D; SystemProperties.getBoolean(</span><br><span class="line">                    &quot;dalvik.vm.profilesystemserver&quot;, false);</span><br><span class="line">            if (profileSystemServer) &#123;</span><br><span class="line">                parsedArgs.runtimeFlags |&#x3D; Zygote.PROFILE_SYSTEM_SERVER;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;* Request to fork the system server process *&#x2F;</span><br><span class="line">            &#x2F;&#x2F;&#x2F;&#x2F; fork子进程，该进程是system_server进程</span><br><span class="line">            pid &#x3D; Zygote.forkSystemServer(</span><br><span class="line">                    parsedArgs.uid, parsedArgs.gid,</span><br><span class="line">                    parsedArgs.gids,</span><br><span class="line">                    parsedArgs.runtimeFlags,</span><br><span class="line">                    null,</span><br><span class="line">                    parsedArgs.permittedCapabilities,</span><br><span class="line">                    parsedArgs.effectiveCapabilities);</span><br><span class="line">        &#125; catch (IllegalArgumentException ex) &#123;</span><br><span class="line">            throw new RuntimeException(ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;* For child process *&#x2F;</span><br><span class="line">        &#x2F;&#x2F; 完成system_server进程剩余的工作</span><br><span class="line">        if (pid &#x3D;&#x3D; 0) &#123;				    </span><br><span class="line">            if (hasSecondZygote(abiList)) &#123;</span><br><span class="line">                waitForSecondaryZygote(socketName);</span><br><span class="line">            &#125;</span><br><span class="line">						&#x2F;&#x2F;关闭父进程zygote复制而来的Socket</span><br><span class="line">            zygoteServer.closeServerSocket();</span><br><span class="line">            &#x2F;&#x2F; 完成system_server进程剩余的工作</span><br><span class="line">            return handleSystemServerProcess(parsedArgs);</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>调用<code>Zygote.forkSystemServer()</code>来创建<code>system_server</code>进程，返回进程pid，最后执行<code>handleSystemServerProcess</code>方法做后续处理。</p>
<h1 id="如何创建system-server进程"><a href="#如何创建system-server进程" class="headerlink" title="如何创建system_server进程"></a>如何创建<code>system_server</code>进程</h1><h2 id="Zygote"><a href="#Zygote" class="headerlink" title="Zygote"></a><code>Zygote</code></h2><h3 id="forkSystemServer-1"><a href="#forkSystemServer-1" class="headerlink" title="forkSystemServer()"></a><code>forkSystemServer()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public static int forkSystemServer(int uid, int gid, int[] gids, int runtimeFlags,</span><br><span class="line">            int[][] rlimits, long permittedCapabilities, long effectiveCapabilities) &#123;</span><br><span class="line">        VM_HOOKS.preFork();</span><br><span class="line">        &#x2F;&#x2F; Resets nice priority for zygote process.</span><br><span class="line">        resetNicePriority();</span><br><span class="line">        int pid &#x3D; nativeForkSystemServer(</span><br><span class="line">                uid, gid, gids, runtimeFlags, rlimits, permittedCapabilities, effectiveCapabilities);</span><br><span class="line">        &#x2F;&#x2F; Enable tracing as soon as we enter the system_server.</span><br><span class="line">        if (pid &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            Trace.setTracingEnabled(true, runtimeFlags);</span><br><span class="line">        &#125;</span><br><span class="line">        VM_HOOKS.postForkCommon();</span><br><span class="line">        return pid;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>nativeForkSystemServer()方法在AndroidRuntime.cpp中注册的，调用com_android_internal_os_Zygote.cpp中的register_com_android_internal_os_Zygote()方法建立native方法的映射关系，所以接下来进入如下方法。</p>
<h3 id="nativeForkSystemServer"><a href="#nativeForkSystemServer" class="headerlink" title="nativeForkSystemServer()"></a><code>nativeForkSystemServer()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">native private static int nativeForkSystemServer(int uid, int gid, int[] gids, int runtimeFlags,</span><br><span class="line">            int[][] rlimits, long permittedCapabilities, long effectiveCapabilities);</span><br></pre></td></tr></table></figure>

<h2 id="com-android-internal-os-Zygote"><a href="#com-android-internal-os-Zygote" class="headerlink" title="com_android_internal_os_Zygote"></a><code>com_android_internal_os_Zygote</code></h2><h3 id="com-android-internal-os-Zygote-nativeForkSystemServer"><a href="#com-android-internal-os-Zygote-nativeForkSystemServer" class="headerlink" title="com_android_internal_os_Zygote_nativeForkSystemServer()"></a><code>com_android_internal_os_Zygote_nativeForkSystemServer()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">static jint com_android_internal_os_Zygote_nativeForkSystemServer(</span><br><span class="line">        JNIEnv* env, jclass, uid_t uid, gid_t gid, jintArray gids,</span><br><span class="line">        jint debug_flags, jobjectArray rlimits, jlong permittedCapabilities,</span><br><span class="line">        jlong effectiveCapabilities) &#123;</span><br><span class="line">  &#x2F;&#x2F;fork子进程，见【见小节4】</span><br><span class="line">  pid_t pid &#x3D; ForkAndSpecializeCommon(env, uid, gid, gids,</span><br><span class="line">                                      debug_flags, rlimits,</span><br><span class="line">                                      permittedCapabilities, effectiveCapabilities,</span><br><span class="line">                                      MOUNT_EXTERNAL_DEFAULT, NULL, NULL, true, NULL,</span><br><span class="line">                                      NULL, NULL);</span><br><span class="line">  if (pid &gt; 0) &#123;</span><br><span class="line">      &#x2F;&#x2F; zygote进程，检测system_server进程是否创建</span><br><span class="line">      gSystemServerPid &#x3D; pid;</span><br><span class="line">      int status;</span><br><span class="line">      if (waitpid(pid, &amp;status, WNOHANG) &#x3D;&#x3D; pid) &#123;</span><br><span class="line">          &#x2F;&#x2F;当system_server进程死亡后，重启zygote进程</span><br><span class="line">          RuntimeAbort(env);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return pid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当system_server进程创建失败时，将会重启zygote进程。这里需要注意，对于Android 5.0以上系统，有两个zygote进程，分别是zygote、zygote64两个进程，system_server的父进程，一般来说64位系统其父进程是zygote64进程</p>
<ul>
<li>当kill system_server进程后，只重启zygote64和system_server，不重启zygote;</li>
<li>当kill zygote64进程后，只重启zygote64和system_server，也不重启zygote；</li>
<li>当kill zygote进程，则重启zygote、zygote64以及system_server。</li>
</ul>
<h3 id="ForkAndSpecializeCommon"><a href="#ForkAndSpecializeCommon" class="headerlink" title="ForkAndSpecializeCommon()"></a><code>ForkAndSpecializeCommon()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">static pid_t ForkAndSpecializeCommon(JNIEnv* env, uid_t uid, gid_t gid, jintArray javaGids, jint debug_flags, jobjectArray javaRlimits, jlong permittedCapabilities, jlong effectiveCapabilities, jint mount_external, jstring java_se_info, jstring java_se_name, bool is_system_server, jintArray fdsToClose, jstring instructionSet, jstring dataDir) &#123;</span><br><span class="line">  SetSigChldHandler(); &#x2F;&#x2F;设置子进程的signal信号处理函数</span><br><span class="line">  pid_t pid &#x3D; fork(); &#x2F;&#x2F;fork子进程</span><br><span class="line">  if (pid &#x3D;&#x3D; 0) &#123;</span><br><span class="line">    &#x2F;&#x2F;进入子进程</span><br><span class="line">    DetachDescriptors(env, fdsToClose); &#x2F;&#x2F;关闭并清除文件描述符</span><br><span class="line"></span><br><span class="line">    if (!is_system_server) &#123;</span><br><span class="line">        &#x2F;&#x2F;对于非system_server子进程，则创建进程组</span><br><span class="line">        int rc &#x3D; createProcessGroup(uid, getpid());</span><br><span class="line">    &#125;</span><br><span class="line">    SetGids(env, javaGids); &#x2F;&#x2F;设置设置group</span><br><span class="line">    SetRLimits(env, javaRlimits); &#x2F;&#x2F;设置资源limit</span><br><span class="line"></span><br><span class="line">    int rc &#x3D; setresgid(gid, gid, gid);</span><br><span class="line">    rc &#x3D; setresuid(uid, uid, uid);</span><br><span class="line"></span><br><span class="line">    SetCapabilities(env, permittedCapabilities, effectiveCapabilities);</span><br><span class="line">    SetSchedulerPolicy(env); &#x2F;&#x2F;设置调度策略</span><br><span class="line"></span><br><span class="line">     &#x2F;&#x2F;selinux上下文</span><br><span class="line">    rc &#x3D; selinux_android_setcontext(uid, is_system_server, se_info_c_str, se_name_c_str);</span><br><span class="line"></span><br><span class="line">    if (se_info_c_str &#x3D;&#x3D; NULL &amp;&amp; is_system_server) &#123;</span><br><span class="line">      se_name_c_str &#x3D; &quot;system_server&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    if (se_info_c_str !&#x3D; NULL) &#123;</span><br><span class="line">      SetThreadName(se_name_c_str); &#x2F;&#x2F;设置线程名为system_server，方便调试</span><br><span class="line">    &#125;</span><br><span class="line">    UnsetSigChldHandler(); &#x2F;&#x2F;设置子进程的signal信号处理函数为默认函数</span><br><span class="line">    &#x2F;&#x2F;等价于调用zygote.callPostForkChildHooks()</span><br><span class="line">    env-&gt;CallStaticVoidMethod(gZygoteClass, gCallPostForkChildHooks, debug_flags,</span><br><span class="line">                              is_system_server ? NULL : instructionSet);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">  &#125; else if (pid &gt; 0) &#123;</span><br><span class="line">    &#x2F;&#x2F;进入父进程，即zygote进程</span><br><span class="line">  &#125;</span><br><span class="line">  return pid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>fork()创建新进程，采用copy on write方式，这是linux创建进程的标准方法，会有两次return,对于pid==0为子进程的返回，对于pid&gt;0为父进程的返回。 到此system_server进程已完成了创建的所有工作，接下来开始了system_server进程的真正工作。在前面startSystemServer()方法中，zygote进程执行完forkSystemServer()后，新创建出来的system_server进程便进入handleSystemServerProcess()方法。关于fork()，可查看另一个文章<a href="http://gityuan.com/2016/03/26/app-process-create/#nativeforkandspecialize" target="_blank" rel="noopener">理解Android进程创建流程</a>。</p>
<h1 id="system-server进程已创建看看如何做后续处理"><a href="#system-server进程已创建看看如何做后续处理" class="headerlink" title="system_server进程已创建看看如何做后续处理"></a>system_server进程已创建看看如何做后续处理</h1><h2 id="ZygoteInit-1"><a href="#ZygoteInit-1" class="headerlink" title="ZygoteInit"></a><code>ZygoteInit</code></h2><h3 id="handleSystemServerProcess"><a href="#handleSystemServerProcess" class="headerlink" title="handleSystemServerProcess()"></a><code>handleSystemServerProcess()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">private static Runnable handleSystemServerProcess(ZygoteConnection.Arguments parsedArgs) &#123;</span><br><span class="line">        &#x2F;&#x2F; set umask to 0077 so new files and directories will default to owner-only permissions.</span><br><span class="line">        Os.umask(S_IRWXG | S_IRWXO);</span><br><span class="line">				&#x2F;&#x2F;设置当前进程名为&quot;system_server&quot;</span><br><span class="line">        if (parsedArgs.niceName !&#x3D; null) &#123;</span><br><span class="line">            Process.setArgV0(parsedArgs.niceName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        final String systemServerClasspath &#x3D; Os.getenv(&quot;SYSTEMSERVERCLASSPATH&quot;);</span><br><span class="line">        if (systemServerClasspath !&#x3D; null) &#123;</span><br><span class="line">        &#x2F;&#x2F;执行dex优化操作</span><br><span class="line">            performSystemServerDexOpt(systemServerClasspath);</span><br><span class="line">            &#x2F;&#x2F; Capturing profiles is only supported for debug or eng builds since selinux normally</span><br><span class="line">            &#x2F;&#x2F; prevents it.</span><br><span class="line">            boolean profileSystemServer &#x3D; SystemProperties.getBoolean(</span><br><span class="line">                    &quot;dalvik.vm.profilesystemserver&quot;, false);</span><br><span class="line">            if (profileSystemServer &amp;&amp; (Build.IS_USERDEBUG || Build.IS_ENG)) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    prepareSystemServerProfile(systemServerClasspath);</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    Log.wtf(TAG, &quot;Failed to set up system server profile&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">						&#x2F;&#x2F;启动应用进程</span><br><span class="line">            WrapperInit.execApplication(parsedArgs.invokeWith,</span><br><span class="line">                    parsedArgs.niceName, parsedArgs.targetSdkVersion,</span><br><span class="line">                    VMRuntime.getCurrentInstructionSet(), null, args);</span><br><span class="line"></span><br><span class="line">            throw new IllegalStateException(&quot;Unexpected return from WrapperInit.execApplication&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">        &#x2F;&#x2F; 创建类加载器，并赋予当前线程</span><br><span class="line">            ClassLoader cl &#x3D; null;</span><br><span class="line">            if (systemServerClasspath !&#x3D; null) &#123;</span><br><span class="line">                cl &#x3D; createPathClassLoader(systemServerClasspath, parsedArgs.targetSdkVersion);</span><br><span class="line"></span><br><span class="line">                Thread.currentThread().setContextClassLoader(cl);</span><br><span class="line">            &#125;</span><br><span class="line">					  &#x2F;&#x2F;system_server故进入此分支</span><br><span class="line">            return ZygoteInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, cl);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="zygoteInit"><a href="#zygoteInit" class="headerlink" title="zygoteInit()"></a><code>zygoteInit()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public static final Runnable zygoteInit(int targetSdkVersion, String[] argv, ClassLoader classLoader) &#123;</span><br><span class="line">        if (RuntimeInit.DEBUG) &#123;</span><br><span class="line">            Slog.d(RuntimeInit.TAG, &quot;RuntimeInit: Starting application from zygote&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;ZygoteInit&quot;);</span><br><span class="line">        &#x2F;&#x2F;重定向log输出</span><br><span class="line">        RuntimeInit.redirectLogStreams();</span><br><span class="line">				&#x2F;&#x2F; 通用的一些初始化</span><br><span class="line">        RuntimeInit.commonInit();</span><br><span class="line">        &#x2F;&#x2F; zygote初始化</span><br><span class="line">        ZygoteInit.nativeZygoteInit();</span><br><span class="line">        &#x2F;&#x2F; 应用初始化</span><br><span class="line">        return RuntimeInit.applicationInit(targetSdkVersion, argv, classLoader);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="nativeZygoteInit"><a href="#nativeZygoteInit" class="headerlink" title="nativeZygoteInit()"></a><code>nativeZygoteInit()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private static final native void nativeZygoteInit();</span><br></pre></td></tr></table></figure>

<h2 id="AndroidRuntime-cpp"><a href="#AndroidRuntime-cpp" class="headerlink" title="AndroidRuntime.cpp"></a><code>AndroidRuntime.cpp</code></h2><h3 id="com-android-internal-os-RuntimeInit-nativeZygoteInit"><a href="#com-android-internal-os-RuntimeInit-nativeZygoteInit" class="headerlink" title="com_android_internal_os_RuntimeInit_nativeZygoteInit()"></a><code>com_android_internal_os_RuntimeInit_nativeZygoteInit()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">static void com_android_internal_os_RuntimeInit_nativeZygoteInit(JNIEnv* env, jobject clazz) &#123;</span><br><span class="line">    &#x2F;&#x2F;此处的gCurRuntime为AppRuntime，是在AndroidRuntime.cpp中定义的</span><br><span class="line">    gCurRuntime-&gt;onZygoteInit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ProcessState::self()是单例模式，主要工作是调用open()打开/dev/binder驱动设备，再利用mmap()映射内核的地址空间，将Binder驱动的fd赋值ProcessState对象中的变量mDriverFD，用于交互操作。startThreadPool()是创建一个新的binder线程，不断进行talkWithDriver()，在binder系列文章中的<a href="http://gityuan.com/2015/11/14/binder-add-service/" target="_blank" rel="noopener">注册服务(addService)</a>详细这两个方法的执行原理。</p>
<h2 id="RuntimeInit"><a href="#RuntimeInit" class="headerlink" title="RuntimeInit"></a><code>RuntimeInit</code></h2><h3 id="applicationInit"><a href="#applicationInit" class="headerlink" title="applicationInit()"></a><code>applicationInit()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">protected static Runnable applicationInit(int targetSdkVersion, String[] argv,</span><br><span class="line">            ClassLoader classLoader) &#123;</span><br><span class="line">        &#x2F;&#x2F;true代表应用程序退出时不调用AppRuntime.onExit()，否则会在退出前调用</span><br><span class="line">        nativeSetExitWithoutCleanup(true);</span><br><span class="line"></span><br><span class="line">       &#x2F;&#x2F;设置虚拟机的内存利用率参数值为0.75</span><br><span class="line">        VMRuntime.getRuntime().setTargetHeapUtilization(0.75f);</span><br><span class="line">        VMRuntime.getRuntime().setTargetSdkVersion(targetSdkVersion);</span><br><span class="line">				&#x2F;&#x2F;解析参数</span><br><span class="line">        final Arguments args &#x3D; new Arguments(argv);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; The end of of the RuntimeInit event (see #zygoteInit).</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;调用startClass的static方法 main() </span><br><span class="line">        return findStaticMain(args.startClass, args.startArgs, classLoader);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在startSystemServer()方法中通过硬编码初始化参数，可知此处args.startClass为”com.android.server.SystemServer”。</p>
<h3 id="findStaticMain"><a href="#findStaticMain" class="headerlink" title="findStaticMain()"></a><code>findStaticMain()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">protected static Runnable findStaticMain(String className, String[] argv,</span><br><span class="line">           ClassLoader classLoader) &#123;</span><br><span class="line">       Class&lt;?&gt; cl;</span><br><span class="line"></span><br><span class="line">       try &#123;</span><br><span class="line">           cl &#x3D; Class.forName(className, true, classLoader);</span><br><span class="line">       &#125; catch (ClassNotFoundException ex) &#123;</span><br><span class="line">           throw new RuntimeException(</span><br><span class="line">                   &quot;Missing class when invoking static main &quot; + className,</span><br><span class="line">                   ex);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       Method m;</span><br><span class="line">       try &#123;</span><br><span class="line">           m &#x3D; cl.getMethod(&quot;main&quot;, new Class[] &#123; String[].class &#125;);</span><br><span class="line">       &#125; catch (NoSuchMethodException ex) &#123;</span><br><span class="line">           throw new RuntimeException(</span><br><span class="line">                   &quot;Missing static main on &quot; + className, ex);</span><br><span class="line">       &#125; catch (SecurityException ex) &#123;</span><br><span class="line">           throw new RuntimeException(</span><br><span class="line">                   &quot;Problem getting static main on &quot; + className, ex);</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       int modifiers &#x3D; m.getModifiers();</span><br><span class="line">       if (! (Modifier.isStatic(modifiers) &amp;&amp; Modifier.isPublic(modifiers))) &#123;</span><br><span class="line">           throw new RuntimeException(</span><br><span class="line">                   &quot;Main method is not public and static on &quot; + className);</span><br><span class="line">       &#125;</span><br><span class="line">       return new MethodAndArgsCaller(m, argv);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h2 id="MethodAndArgsCaller"><a href="#MethodAndArgsCaller" class="headerlink" title="MethodAndArgsCaller"></a><code>MethodAndArgsCaller</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">static class MethodAndArgsCaller implements Runnable &#123;</span><br><span class="line">        &#x2F;** method to call *&#x2F;</span><br><span class="line">        private final Method mMethod;</span><br><span class="line"></span><br><span class="line">        &#x2F;** argument array *&#x2F;</span><br><span class="line">        private final String[] mArgs;</span><br><span class="line"></span><br><span class="line">        public MethodAndArgsCaller(Method method, String[] args) &#123;</span><br><span class="line">            mMethod &#x3D; method;</span><br><span class="line">            mArgs &#x3D; args;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void run() &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                mMethod.invoke(null, new Object[] &#123; mArgs &#125;);</span><br><span class="line">            &#125; catch (IllegalAccessException ex) &#123;</span><br><span class="line">                throw new RuntimeException(ex);</span><br><span class="line">            &#125; catch (InvocationTargetException ex) &#123;</span><br><span class="line">                Throwable cause &#x3D; ex.getCause();</span><br><span class="line">                if (cause instanceof RuntimeException) &#123;</span><br><span class="line">                    throw (RuntimeException) cause;</span><br><span class="line">                &#125; else if (cause instanceof Error) &#123;</span><br><span class="line">                    throw (Error) cause;</span><br><span class="line">                &#125;</span><br><span class="line">                throw new RuntimeException(ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现Runnable接口，通过反射执行SystemServer中manin方法。</p>
<h1 id="进入SystemServer中"><a href="#进入SystemServer中" class="headerlink" title="进入SystemServer中"></a>进入<code>SystemServer</code>中</h1><p>至此已经进入SystemServer中的main方法中，</p>
<h2 id="SystemServer"><a href="#SystemServer" class="headerlink" title="SystemServer"></a><code>SystemServer</code></h2><h3 id="main-1"><a href="#main-1" class="headerlink" title="main()"></a><code>main()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">        new SystemServer().run();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>先初始化，在调用run方法</p>
<h3 id="run"><a href="#run" class="headerlink" title="run()"></a><code>run()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">private void run() &#123;</span><br><span class="line">		&#x2F;&#x2F;当系统时间比1970年更早，就设置当前系统时间为1970年</span><br><span class="line">    if (System.currentTimeMillis() &lt; EARLIEST_SUPPORTED_TIME) &#123;</span><br><span class="line">        SystemClock.setCurrentTimeMillis(EARLIEST_SUPPORTED_TIME);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     &#x2F;&#x2F;变更虚拟机的库文件，对于Android 6.0默认采用的是libart.so</span><br><span class="line">    SystemProperties.set(&quot;persist.sys.dalvik.vm.lib.2&quot;, VMRuntime.getRuntime().vmLibrary());</span><br><span class="line"></span><br><span class="line">    if (SamplingProfilerIntegration.isEnabled()) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;清除vm内存增长上限，由于启动过程需要较多的虚拟机内存空间</span><br><span class="line">    VMRuntime.getRuntime().clearGrowthLimit();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;设置内存的可能有效使用率为0.8</span><br><span class="line">    VMRuntime.getRuntime().setTargetHeapUtilization(0.8f);</span><br><span class="line">    &#x2F;&#x2F; 针对部分设备依赖于运行时就产生指纹信息，因此需要在开机完成前已经定义</span><br><span class="line">    Build.ensureFingerprintProperty();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;访问环境变量前，需要明确地指定用户</span><br><span class="line">    Environment.setUserRequired(true);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;确保当前系统进程的binder调用，总是运行在前台优先级(foreground priority)</span><br><span class="line">    BinderInternal.disableBackgroundScheduling(true);</span><br><span class="line">    android.os.Process.setThreadPriority(android.os.Process.THREAD_PRIORITY_FOREGROUND);</span><br><span class="line">    android.os.Process.setCanSelfBackground(false);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 主线程looper就在当前线程运行</span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;加载android_servers.so库，该库包含的源码在frameworks&#x2F;base&#x2F;services&#x2F;目录下</span><br><span class="line">    System.loadLibrary(&quot;android_servers&quot;);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;检测上次关机过程是否失败，该方法可能不会返回[见小节1.2.1]</span><br><span class="line">    performPendingShutdown();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;初始化系统上下文 【见小节1.3】</span><br><span class="line">    createSystemContext();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;创建系统服务管理</span><br><span class="line">    mSystemServiceManager &#x3D; new SystemServiceManager(mSystemContext);</span><br><span class="line">    &#x2F;&#x2F;将mSystemServiceManager添加到本地服务的成员sLocalServiceObjects</span><br><span class="line">    LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;启动各种系统服务</span><br><span class="line">    try &#123;</span><br><span class="line">        startBootstrapServices(); &#x2F;&#x2F; 启动引导服务【见小节1.4】</span><br><span class="line">        startCoreServices();      &#x2F;&#x2F; 启动核心服务【见小节1.5】</span><br><span class="line">        startOtherServices();     &#x2F;&#x2F; 启动其他服务【见小节1.6】</span><br><span class="line">    &#125; catch (Throwable ex) &#123;</span><br><span class="line">        Slog.e(&quot;System&quot;, &quot;************ Failure starting system services&quot;, ex);</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;用于debug版本，将log事件不断循环地输出到dropbox（用于分析）</span><br><span class="line">    if (StrictMode.conditionallyEnableDebugLogging()) &#123;</span><br><span class="line">        Slog.i(TAG, &quot;Enabled StrictMode for system server main thread.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;一直循环执行</span><br><span class="line">    Looper.loop();</span><br><span class="line">    throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LocalServices通过用静态Map变量sLocalServiceObjects，来保存以服务类名为key，以具体服务对象为value的Map结构。</p>
<h3 id="performPendingShutdown"><a href="#performPendingShutdown" class="headerlink" title="performPendingShutdown()"></a><code>performPendingShutdown()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private void performPendingShutdown() &#123;</span><br><span class="line">    final String shutdownAction &#x3D; SystemProperties.get(</span><br><span class="line">            ShutdownThread.SHUTDOWN_ACTION_PROPERTY, &quot;&quot;);</span><br><span class="line">    if (shutdownAction !&#x3D; null &amp;&amp; shutdownAction.length() &gt; 0) &#123;</span><br><span class="line">        boolean reboot &#x3D; (shutdownAction.charAt(0) &#x3D;&#x3D; &#39;1&#39;);</span><br><span class="line"></span><br><span class="line">        final String reason;</span><br><span class="line">        if (shutdownAction.length() &gt; 1) &#123;</span><br><span class="line">            reason &#x3D; shutdownAction.substring(1, shutdownAction.length());</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            reason &#x3D; null;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 当&quot;sys.shutdown.requested&quot;值不为空,则会重启或者关机</span><br><span class="line">        ShutdownThread.rebootOrShutdown(null, reboot, reason);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="createSystemContext"><a href="#createSystemContext" class="headerlink" title="createSystemContext()"></a><code>createSystemContext()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private void createSystemContext() &#123;</span><br><span class="line">    &#x2F;&#x2F;创建system_server进程的上下文信息</span><br><span class="line">    ActivityThread activityThread &#x3D; ActivityThread.systemMain();</span><br><span class="line">    mSystemContext &#x3D; activityThread.getSystemContext();</span><br><span class="line">    &#x2F;&#x2F;设置主题</span><br><span class="line">    mSystemContext.setTheme(android.R.style.Theme_DeviceDefault_Light_DarkActionBar);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="http://gityuan.com/2017/04/02/android-application/" target="_blank" rel="noopener">理解Application创建过程</a>已介绍过createSystemContext()过程， 该过程会创建对象有ActivityThread，Instrumentation, ContextImpl，LoadedApk，Application。</p>
<h3 id="startBootstrapServices"><a href="#startBootstrapServices" class="headerlink" title="startBootstrapServices()"></a><code>startBootstrapServices()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">private void startBootstrapServices() &#123;</span><br><span class="line">    &#x2F;&#x2F;阻塞等待与installd建立socket通道 Installer的onStart()</span><br><span class="line">    Installer installer &#x3D; mSystemServiceManager.startService(Installer.class);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;启动服务ActivityManagerService</span><br><span class="line">    mActivityManagerService &#x3D; mSystemServiceManager.startService(</span><br><span class="line">            ActivityManagerService.Lifecycle.class).getService();</span><br><span class="line">    mActivityManagerService.setSystemServiceManager(mSystemServiceManager);</span><br><span class="line">    mActivityManagerService.setInstaller(installer);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;启动服务PowerManagerService</span><br><span class="line">    mPowerManagerService &#x3D; mSystemServiceManager.startService(PowerManagerService.class);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;初始化power management</span><br><span class="line">    mActivityManagerService.initPowerManagement();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;启动服务LightsService</span><br><span class="line">    mSystemServiceManager.startService(LightsService.class);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;启动服务DisplayManagerService</span><br><span class="line">    mDisplayManagerService &#x3D; mSystemServiceManager.startService(DisplayManagerService.class);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;Phase100: 在初始化package manager之前，需要默认的显示.</span><br><span class="line">    mSystemServiceManager.startBootPhase(SystemService.PHASE_WAIT_FOR_DEFAULT_DISPLAY);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;当设备正在加密时，仅运行核心</span><br><span class="line">    String cryptState &#x3D; SystemProperties.get(&quot;vold.decrypt&quot;);</span><br><span class="line">    if (ENCRYPTING_STATE.equals(cryptState)) &#123;</span><br><span class="line">        mOnlyCore &#x3D; true;</span><br><span class="line">    &#125; else if (ENCRYPTED_STATE.equals(cryptState)) &#123;</span><br><span class="line">        mOnlyCore &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;启动服务PackageManagerService</span><br><span class="line">    mPackageManagerService &#x3D; PackageManagerService.main(mSystemContext, installer,</span><br><span class="line">            mFactoryTestMode !&#x3D; FactoryTest.FACTORY_TEST_OFF, mOnlyCore);</span><br><span class="line">    mFirstBoot &#x3D; mPackageManagerService.isFirstBoot();</span><br><span class="line">    mPackageManager &#x3D; mSystemContext.getPackageManager();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;启动服务UserManagerService，新建目录&#x2F;data&#x2F;user&#x2F;</span><br><span class="line">    ServiceManager.addService(Context.USER_SERVICE, UserManagerService.getInstance());</span><br><span class="line"></span><br><span class="line">    AttributeCache.init(mSystemContext);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;设置AMS</span><br><span class="line">    mActivityManagerService.setSystemProcess();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;启动传感器服务</span><br><span class="line">    startSensorService();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法所创建的服务：ActivityManagerService, PowerManagerService, LightsService, DisplayManagerService， PackageManagerService， UserManagerService， sensor服务.</p>
<h3 id="startCoreServices"><a href="#startCoreServices" class="headerlink" title="startCoreServices()"></a><code>startCoreServices()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">private void startCoreServices() &#123;</span><br><span class="line">		    &#x2F;&#x2F;启动服务BatteryService，用于统计电池电量，需要LightService.</span><br><span class="line">        mSystemServiceManager.startService(BatteryService.class);</span><br><span class="line">		    &#x2F;&#x2F;启动服务UsageStatsService，用于统计应用使用情况</span><br><span class="line">        mSystemServiceManager.startService(UsageStatsService.class);</span><br><span class="line">        mActivityManagerService.setUsageStatsManager(</span><br><span class="line">                LocalServices.getService(UsageStatsManagerInternal.class));</span><br><span class="line"></span><br><span class="line">        if (mPackageManager.hasSystemFeature(PackageManager.FEATURE_WEBVIEW)) &#123;</span><br><span class="line">            traceBeginAndSlog(&quot;StartWebViewUpdateService&quot;);</span><br><span class="line">            &#x2F;&#x2F;启动服务WebViewUpdateService</span><br><span class="line">            mWebViewUpdateService &#x3D; mSystemServiceManager.startService(WebViewUpdateService.class);</span><br><span class="line">        &#125;</span><br><span class="line">        BinderCallsStatsService.start();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>启动服务BatteryService，UsageStatsService，WebViewUpdateService。</p>
<h3 id="startOtherServices"><a href="#startOtherServices" class="headerlink" title="startOtherServices()"></a><code>startOtherServices()</code></h3><p>该方法比较长，有近千行代码，逻辑很简单，主要是启动一系列的服务，这里就不具体列举源码了，在第四节直接对其中的服务进行一个简单分类。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">private void startOtherServices() &#123;</span><br><span class="line">       ...</span><br><span class="line">       SystemConfig.getInstance();</span><br><span class="line">       mContentResolver &#x3D; context.getContentResolver(); &#x2F;&#x2F; resolver</span><br><span class="line">       ...</span><br><span class="line">       mActivityManagerService.installSystemProviders(); &#x2F;&#x2F;provider</span><br><span class="line">       mSystemServiceManager.startService(AlarmManagerService.class); &#x2F;&#x2F; alarm</span><br><span class="line">       &#x2F;&#x2F; watchdog</span><br><span class="line">       watchdog.init(context, mActivityManagerService); </span><br><span class="line">       inputManager &#x3D; new InputManagerService(context); &#x2F;&#x2F; input</span><br><span class="line">       wm &#x3D; WindowManagerService.main(...); &#x2F;&#x2F; window</span><br><span class="line">       inputManager.start();  &#x2F;&#x2F;启动input</span><br><span class="line">       mDisplayManagerService.windowManagerAndInputReady();</span><br><span class="line">       ...</span><br><span class="line">       mSystemServiceManager.startService(MOUNT_SERVICE_CLASS); &#x2F;&#x2F; mount</span><br><span class="line">       mPackageManagerService.performBootDexOpt();  &#x2F;&#x2F; dexopt操作</span><br><span class="line">       ActivityManagerNative.getDefault().showBootMessage(...); &#x2F;&#x2F;显示启动界面</span><br><span class="line">       ...</span><br><span class="line">       statusBar &#x3D; new StatusBarManagerService(context, wm); &#x2F;&#x2F;statusBar</span><br><span class="line">       &#x2F;&#x2F;dropbox</span><br><span class="line">       ServiceManager.addService(Context.DROPBOX_SERVICE,</span><br><span class="line">                   new DropBoxManagerService(context, new File(&quot;&#x2F;data&#x2F;system&#x2F;dropbox&quot;)));</span><br><span class="line">        mSystemServiceManager.startService(JobSchedulerService.class); &#x2F;&#x2F;JobScheduler</span><br><span class="line">        lockSettings.systemReady(); &#x2F;&#x2F;lockSettings</span><br><span class="line"></span><br><span class="line">       &#x2F;&#x2F;phase480 和phase500</span><br><span class="line">       mSystemServiceManager.startBootPhase(SystemService.PHASE_LOCK_SETTINGS_READY);</span><br><span class="line">       mSystemServiceManager.startBootPhase(SystemService.PHASE_SYSTEM_SERVICES_READY);</span><br><span class="line">       ...</span><br><span class="line">       &#x2F;&#x2F; 准备好window, power, package, display服务</span><br><span class="line">       wm.systemReady();</span><br><span class="line">       mPowerManagerService.systemReady(...);</span><br><span class="line">       mPackageManagerService.systemReady();</span><br><span class="line">       mDisplayManagerService.systemReady(...);</span><br><span class="line">       </span><br><span class="line">       &#x2F;&#x2F;重头戏[见小节2.1]</span><br><span class="line">       mActivityManagerService.systemReady(new Runnable() &#123;</span><br><span class="line">           public void run() &#123;</span><br><span class="line">             ...</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>SystemServer启动各种服务中最后的一个环节便是AMS.systemReady()，详见<a href="http://gityuan.com/2016/02/21/activity-manager-service/" target="_blank" rel="noopener">ActivityManagerService启动过程</a>.</p>
<p>到此, System_server主线程的启动工作总算完成, 进入Looper.loop()状态,等待其他线程通过handler发送消息到主线再处理.</p>
<h1 id="至此System-Server启动完成"><a href="#至此System-Server启动完成" class="headerlink" title="至此System_Server启动完成"></a>至此System_Server启动完成</h1><h1 id="服务启动阶段"><a href="#服务启动阶段" class="headerlink" title="服务启动阶段"></a>服务启动阶段</h1><p>SystemServiceManager的startBootPhase()贯穿system_server进程的整个启动过程：</p>
<p><img src="http://gityuan.com/images/boot/systemServer/system_server_boot_process.jpg" alt="system_server服务启动流程"></p>
<p><strong>各个启动阶段所在源码的大致位置：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public final class SystemServer &#123;</span><br><span class="line"></span><br><span class="line">    private void startBootstrapServices() &#123;</span><br><span class="line">      ...</span><br><span class="line">      &#x2F;&#x2F;phase100</span><br><span class="line">      mSystemServiceManager.startBootPhase(SystemService.PHASE_WAIT_FOR_DEFAULT_DISPLAY);</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void startCoreServices() &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void startOtherServices() &#123;</span><br><span class="line">      ...</span><br><span class="line">      &#x2F;&#x2F;phase480 &amp;&amp; 500</span><br><span class="line">      mSystemServiceManager.startBootPhase(SystemService.PHASE_LOCK_SETTINGS_READY);</span><br><span class="line">      mSystemServiceManager.startBootPhase(SystemService.PHASE_SYSTEM_SERVICES_READY);</span><br><span class="line">      </span><br><span class="line">      ...</span><br><span class="line">      mActivityManagerService.systemReady(new Runnable() &#123;</span><br><span class="line">         public void run() &#123;</span><br><span class="line">             &#x2F;&#x2F;phase550</span><br><span class="line">             mSystemServiceManager.startBootPhase(</span><br><span class="line">                     SystemService.PHASE_ACTIVITY_MANAGER_READY);</span><br><span class="line">             ...</span><br><span class="line">             &#x2F;&#x2F;phase600</span><br><span class="line">             mSystemServiceManager.startBootPhase(</span><br><span class="line">                     SystemService.PHASE_THIRD_PARTY_APPS_CAN_START);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来再说说简单每个阶段的大概完成的工作：</p>
<h2 id="Phase0"><a href="#Phase0" class="headerlink" title="Phase0"></a>Phase0</h2><p>创建四大引导服务:</p>
<ul>
<li>ActivityManagerService</li>
<li>PowerManagerService</li>
<li>LightsService</li>
<li>DisplayManagerService</li>
</ul>
<h2 id="Phase100"><a href="#Phase100" class="headerlink" title="Phase100"></a>Phase100</h2><p>进入阶段<code>PHASE_WAIT_FOR_DEFAULT_DISPLAY</code>=100回调服务</p>
<p>onBootPhase(100)</p>
<ul>
<li>DisplayManagerService</li>
</ul>
<p>然后创建大量服务下面列举部分:</p>
<ul>
<li>PackageManagerService</li>
<li>WindowManagerService</li>
<li>InputManagerService</li>
<li>NetworkManagerService</li>
<li>DropBoxManagerService</li>
<li>FingerprintService</li>
<li>LauncherAppsService</li>
<li>…</li>
</ul>
<h2 id="Phase480"><a href="#Phase480" class="headerlink" title="Phase480"></a>Phase480</h2><p>进入阶段<code>PHASE_LOCK_SETTINGS_READY</code>=480回调服务</p>
<p>onBootPhase(480)</p>
<ul>
<li>DevicePolicyManagerService</li>
</ul>
<p>阶段480后马上就进入阶段500.</p>
<h2 id="Phase500"><a href="#Phase500" class="headerlink" title="Phase500"></a>Phase500</h2><p><code>PHASE_SYSTEM_SERVICES_READY</code>=500，进入该阶段服务能安全地调用核心系统服务.</p>
<p>onBootPhase(500)</p>
<ul>
<li>AlarmManagerService</li>
<li>JobSchedulerService</li>
<li>NotificationManagerService</li>
<li>BackupManagerService</li>
<li>UsageStatsService</li>
<li>DeviceIdleController</li>
<li>TrustManagerService</li>
<li>UiModeManagerService</li>
<li>BluetoothService</li>
<li>BluetoothManagerService</li>
<li>EthernetService</li>
<li>WifiP2pService</li>
<li>WifiScanningService</li>
<li>WifiService</li>
<li>RttService</li>
</ul>
<p>各大服务执行systemReady():</p>
<ul>
<li>WindowManagerService.systemReady():</li>
<li>PowerManagerService.systemReady():</li>
<li>PackageManagerService.systemReady():</li>
<li>DisplayManagerService.systemReady():</li>
</ul>
<p>接下来就绪AMS.systemReady方法.</p>
<h2 id="Phase550"><a href="#Phase550" class="headerlink" title="Phase550"></a>Phase550</h2><p><code>PHASE_ACTIVITY_MANAGER_READY</code>=550， AMS.mSystemReady=true, 已准备就绪,进入该阶段服务能广播Intent;但是system_server主线程并没有就绪.</p>
<p>onBootPhase(550)</p>
<ul>
<li>MountService</li>
<li>TelecomLoaderService</li>
<li>UsbService</li>
<li>WebViewUpdateService</li>
<li>DockObserver</li>
<li>BatteryService</li>
</ul>
<p>接下来执行: (AMS启动native crash监控, 加载WebView，启动SystemUi等),如下</p>
<ul>
<li>mActivityManagerService.startObservingNativeCrashes();</li>
<li>WebViewFactory.prepareWebViewInSystemServer();</li>
<li>startSystemUi(context);</li>
<li>networkScoreF.systemReady();</li>
<li>networkManagementF.systemReady();</li>
<li>networkStatsF.systemReady();</li>
<li>networkPolicyF.systemReady();</li>
<li>connectivityF.systemReady();</li>
<li>audioServiceF.systemReady();</li>
<li>Watchdog.getInstance().start();</li>
</ul>
<h2 id="Phase600"><a href="#Phase600" class="headerlink" title="Phase600"></a>Phase600</h2><p><code>PHASE_THIRD_PARTY_APPS_CAN_START</code>=600</p>
<p>onBootPhase(600)</p>
<ul>
<li>JobSchedulerService</li>
<li>NotificationManagerService</li>
<li>BackupManagerService</li>
<li>AppWidgetService</li>
<li>GestureLauncherService</li>
<li>DreamManagerService</li>
<li>TrustManagerService</li>
<li>VoiceInteractionManagerService</li>
</ul>
<p>接下来,各种服务的systemRunning过程:</p>
<p>WallpaperManagerService、InputMethodManagerService、LocationManagerService、CountryDetectorService、NetworkTimeUpdateService、CommonTimeManagementService、TextServicesManagerService、AssetAtlasService、InputManagerService、TelephonyRegistry、MediaRouterService、MmsServiceBroker这些服务依次执行其<code>systemRunning()</code>方法。</p>
<h2 id="Phase1000"><a href="#Phase1000" class="headerlink" title="Phase1000"></a>Phase1000</h2><p>在经过一系列流程，再调用<code>AMS.finishBooting()</code>时，则进入阶段<code>Phase1000</code>。</p>
<p>到此，系统服务启动阶段完成就绪，system_server进程启动完成则进入<code>Looper.loop()</code>状态，随时待命，等待消息队列MessageQueue中的消息到来，则马上进入执行状态。</p>
<h1 id="服务类别"><a href="#服务类别" class="headerlink" title="服务类别"></a>服务类别</h1><p>system_server进程，从源码角度划分为引导服务、核心服务、其他服务3类。 以下这些系统服务的注册过程, 见<a href="http://gityuan.com/2016/10/01/system_service_common/" target="_blank" rel="noopener">Android系统服务的注册方式</a></p>
<ul>
<li>引导服务(7个)：ActivityManagerService、PowerManagerService、LightsService、DisplayManagerService、PackageManagerService、UserManagerService、SensorService；</li>
<li>核心服务(3个)：BatteryService、UsageStatsService、WebViewUpdateService；</li>
<li>其他服务(70个+)：AlarmManagerService、VibratorService等。</li>
</ul>
<p>合计总大约80个系统服务：</p>
<table>
<thead>
<tr>
<th><code>ActivityManagerService</code></th>
<th><code>PackageManagerService</code></th>
<th><code>WindowManagerService</code></th>
</tr>
</thead>
<tbody><tr>
<td><code>PowerManagerService</code></td>
<td><code>BatteryService</code></td>
<td><code>BatteryStatsService</code></td>
</tr>
<tr>
<td><code>DreamManagerService</code></td>
<td><code>DropBoxManagerService</code></td>
<td><code>SamplingProfilerService</code></td>
</tr>
<tr>
<td><code>UsageStatsService</code></td>
<td><code>DiskStatsService</code></td>
<td><code>DeviceStorageMonitorService</code></td>
</tr>
<tr>
<td>SchedulingPolicyService</td>
<td><code>AlarmManagerService</code></td>
<td>DeviceIdleController</td>
</tr>
<tr>
<td>ThermalObserver</td>
<td>JobSchedulerService</td>
<td><code>AccessibilityManagerService</code></td>
</tr>
<tr>
<td>DisplayManagerService</td>
<td>LightsService</td>
<td><code>GraphicsStatsService</code></td>
</tr>
<tr>
<td>StatusBarManagerService</td>
<td>NotificationManagerService</td>
<td>WallpaperManagerService</td>
</tr>
<tr>
<td>UiModeManagerService</td>
<td>AppWidgetService</td>
<td>LauncherAppsService</td>
</tr>
<tr>
<td>TextServicesManagerService</td>
<td>ContentService</td>
<td>LockSettingsService</td>
</tr>
<tr>
<td>InputMethodManagerService</td>
<td>InputManagerService</td>
<td><code>MountService</code></td>
</tr>
<tr>
<td>FingerprintService</td>
<td>TvInputManagerService</td>
<td>DockObserver</td>
</tr>
<tr>
<td>NetworkManagementService</td>
<td>NetworkScoreService</td>
<td><code>NetworkStatsService</code></td>
</tr>
<tr>
<td>NetworkPolicyManagerService</td>
<td>ConnectivityService</td>
<td>BluetoothService</td>
</tr>
<tr>
<td>WifiP2pService</td>
<td>WifiService</td>
<td>WifiScanningService</td>
</tr>
<tr>
<td>AudioService</td>
<td>MediaRouterService</td>
<td>VoiceInteractionManagerService</td>
</tr>
<tr>
<td>MediaProjectionManagerService</td>
<td>MediaSessionService</td>
<td></td>
</tr>
<tr>
<td>DevicePolicyManagerService</td>
<td>PrintManagerService</td>
<td><code>BackupManagerService</code></td>
</tr>
<tr>
<td><code>UserManagerService</code></td>
<td>AccountManagerService</td>
<td><code>TrustManagerService</code></td>
</tr>
<tr>
<td><code>SensorService</code></td>
<td>LocationManagerService</td>
<td>VibratorService</td>
</tr>
<tr>
<td>CountryDetectorService</td>
<td>GestureLauncherService</td>
<td>PersistentDataBlockService</td>
</tr>
<tr>
<td>EthernetService</td>
<td>WebViewUpdateService</td>
<td>ClipboardService</td>
</tr>
<tr>
<td>TelephonyRegistry</td>
<td>TelecomLoaderService</td>
<td>NsdService</td>
</tr>
<tr>
<td>UpdateLockService</td>
<td>SerialService</td>
<td>SearchManagerService</td>
</tr>
<tr>
<td>CommonTimeManagementService</td>
<td>AssetAtlasService</td>
<td>ConsumerIrService</td>
</tr>
<tr>
<td>MidiServiceCameraService</td>
<td>TwilightService</td>
<td>RestrictionsManagerService</td>
</tr>
<tr>
<td>MmsServiceBroker</td>
<td>RttService</td>
<td>UsbService</td>
</tr>
</tbody></table>
<p>Service类别众多，其中表中加粗项是指博主挑选的较重要或者较常见的Service，并且在本博客中已经展开或者计划展开讲解的Service，当然如果有精力会讲解更多service，后续再更新。</p>
<h1 id="客户端使用服务"><a href="#客户端使用服务" class="headerlink" title="客户端使用服务"></a>客户端使用服务</h1><h2 id="一个简单的SystemService"><a href="#一个简单的SystemService" class="headerlink" title="一个简单的SystemService"></a>一个简单的SystemService</h2><p>我们从一个简单的系统服务Vibrator服务来看一下一个系统服务是怎样建立的。<br>Vibrator服务提供的控制手机振动的接口，应用可以调用Vibrator的接口来让手机产生振动，达到提醒用户的目的。<br>从Android的官方文档中可以看到Vibrator只是一个抽象类，只有4个抽象接口：</p>
<ul>
<li>abstract void cancel() 取消振动</li>
<li>abstract boolean hasVibrator() 是否有振动功能</li>
<li>abstract void vibrate(long[] pattern, int repeat) 按节奏重复振动</li>
<li>abstract void vibrate(long milliseconds) 持续振动</li>
</ul>
<p>应用中使用振动服务的方法也很简单，如让手机持续振动500毫秒：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Vibrator mVibrator &#x3D; (Vibrator) getSystemService(Context.VIBRATOR_SERVICE);</span><br><span class="line">mVibrator.vibrate(500);</span><br></pre></td></tr></table></figure>

<p><code>Vibrator</code>使用起来很简单，我们再来看一下实现起来是不是也简单。从文档中可以看到Vibrator只是定义在android.os 包里的一个抽象类，在源码里的位置即<code>frameworks/base/core/java/android/os/Vibrator.java</code>，那么应用中实际使用的是哪个实例呢？应用中使用的Vibrator实例是通过Context的一个方法<code>getSystemService(Context.VIBRATOR_SERVICE)</code>获得的，而Context的实现一般都在<code>ContextImpl</code>中，那我们就看一下ContextImpl是怎么实现getSystemService的：<br><code>frameworks/base/core/java/android/app/ContextImpl.java</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object getSystemService(String name) &#123;</span><br><span class="line">    return SystemServiceRegistry.getSystemService(this, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>frameworks/base/core/java/android/app/SystemServiceRegistry.java</code></p>
<p>(<code>SystemServiceRegistry</code>是 Android 6.0之后才有的，Android 6.0 之前的代码没有该类，下面的代码是直接写在<code>ContextImpl</code>里的)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static Object getSystemService(ContextImpl ctx, String name) &#123;</span><br><span class="line">    ServiceFetcher&lt;?&gt; fetcher &#x3D; SYSTEM_SERVICE_FETCHERS.get(name);</span><br><span class="line">    return fetcher !&#x3D; null ? fetcher.getService(ctx) : null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SYSTEM_SERVICE_MA</code>P是一个HashMap，通过我们服务的名字name字符串，从这个HashMap里取出一个ServiceFetcher，再return这个ServiceFetcher的getService()。ServiceFetcher是什么？它的getService()又是什么？既然他是从SYSTEM_SERVICE_MAP这个HashMap里get出来的，那就找一找这个HashMap都put了什么。<br>通过搜索SystemServiceRegistry可以找到如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private static &lt;T&gt; void registerService(String serviceName, Class&lt;T&gt; serviceClass,</span><br><span class="line">        ServiceFetcher&lt;T&gt; serviceFetcher) &#123;</span><br><span class="line">    SYSTEM_SERVICE_NAMES.put(serviceClass, serviceName);</span><br><span class="line">    SYSTEM_SERVICE_FETCHERS.put(serviceName, serviceFetcher);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里往<code>SYSTEM_SERVICE_MAP</code>里<code>put</code>了一对<code>String</code>与<code>ServiceFetcher</code>组成的key/value对，<code>registerService()</code>又是从哪里调用的？继续搜索可以发现很多类似下面的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">static &#123;</span><br><span class="line">    registerService(Context.ACCESSIBILITY_SERVICE, AccessibilityManager.class,</span><br><span class="line">            new CachedServiceFetcher&lt;AccessibilityManager&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public AccessibilityManager createService(ContextImpl ctx) &#123;</span><br><span class="line">            return AccessibilityManager.getInstance(ctx);</span><br><span class="line">        &#125;&#125;);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    registerService(Context.VIBRATOR_SERVICE, Vibrator.class,</span><br><span class="line">            new CachedServiceFetcher&lt;Vibrator&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public Vibrator createService(ContextImpl ctx) &#123;</span><br><span class="line">            return new SystemVibrator(ctx);</span><br><span class="line">        &#125;&#125;);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SystemServiceRegistry</code>的static代码块里通过<code>registerService</code>注册了很多的系统服务，其中就包括我们正在调查的<code>VIBRATOR_SERVICE</code>，通过结合上面的分析代码可以可以知道<code>getSystemService(Context.VIBRATOR_SERVICE)</code>得到的是一个<code>SystemVibrator</code>的实例，通过查看<code>SystemVibrator</code>的代码也可以发现<code>SystemVibrator</code>确实是继承自Vibrator：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public class SystemVibrator extends Vibrator &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们再从<code>SystemVibrator</code>看一下系统的振动控制是怎么实现的。以<code>hasVibrator()</code>为例，这个是查询当前系统是否能够振动，在<code>SystemVibrator</code>中它的实现如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public boolean hasVibrator() &#123;</span><br><span class="line">    ...</span><br><span class="line">    try &#123;</span><br><span class="line">        return mService.hasVibrator();</span><br><span class="line">    &#125; catch (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里直接调用了一个<code>mService.hasVibrator()</code>。<code>mService</code>是什么？哪来的？搜索一下可以发现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private final IVibratorService mService;</span><br><span class="line">public SystemVibrator() &#123;</span><br><span class="line">    ...</span><br><span class="line">    mService &#x3D; IVibratorService.Stub.asInterface(</span><br><span class="line">            ServiceManager.getService(&quot;vibrator&quot;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>mService</code> 是一个<code>IVibratorService</code>，我们先不去管<code>IVibratorService.Stub.asInterface</code>是怎么回事，先看一下<code>IVibratorService</code>是什么。搜索一下代码发现这并不是一个java文件，而是一个aidl文件：<code>frameworks/base/core/java/android/os/IVibratorService.aidl</code><br>AIDL (Android Interface Definition Language) 是Android中的接口定义文件，为系统提供了一种简单跨进程通信方法。<br>IVibratorService 中定义了几个接口，SystemVibrator中使用的也是这几个接口，包括我们刚才使用的hasVibrator()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">interface IVibratorService</span><br><span class="line">&#123;</span><br><span class="line">    boolean hasVibrator();</span><br><span class="line">    void vibrate(...);</span><br><span class="line">    void vibratePattern(...);</span><br><span class="line">    void cancelVibrate(IBinder token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里又只是接口定义，接口实现在哪呢？通过在<code>frameworks/base</code>目录下进行grep搜索，或者在AndroidXRef搜索，可以发现IVibratorService接口的实现在<code>frameworks/base/services/java/com/android/server/VibratorService.java</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public class VibratorService extends IVibratorService.Stub</span><br></pre></td></tr></table></figure>

<p>可以看到 VibratorService实现了IVibratorService定义的所有接口，并通过JNI调用到native层，进行更底层的实现。更底层的实现不是这篇文档讨论的内容，我们需要分析的是VibratorService怎么成为系统服务的。那么VibratorService是怎么注册为系统服务的呢？在SystemServer里面：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">VibratorService vibrator &#x3D; null;</span><br><span class="line">...</span><br><span class="line">&#x2F;&#x2F;实例化VibratorService并添加到ServiceManager</span><br><span class="line">traceBeginAndSlog(&quot;StartVibratorService&quot;);</span><br><span class="line">vibrator &#x3D; new VibratorService(context);</span><br><span class="line">ServiceManager.addService(&quot;vibrator&quot;, vibrator);</span><br><span class="line">Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">...</span><br><span class="line">&#x2F;&#x2F;通知服务系统启动完成</span><br><span class="line">Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, &quot;MakeVibratorServiceReady&quot;);</span><br><span class="line">try &#123;</span><br><span class="line">    vibrator.systemReady();</span><br><span class="line">&#125; catch (Throwable e) &#123;</span><br><span class="line">    reportWtf(&quot;making Vibrator Service ready&quot;, e);</span><br><span class="line">&#125;</span><br><span class="line">Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br></pre></td></tr></table></figure>

<p>这样在<code>SystemVibrator</code>里就可以通过下面的代码连接到<code>VibratorService</code>，与底层的系统服务进行通信了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IVibratorService.Stub.asInterface(ServiceManager.getService(&quot;vibrator&quot;));</span><br></pre></td></tr></table></figure>

<p><code>mService</code>相当于<code>IVibratorService</code>在应用层的一个代理，所有的实现还是在<code>SystemServer</code>的<code>VibratorService</code>里。</p>
<p>看代码时可以发现<code>registerService</code>是在static代码块里静态调用的，所以<code>getSystemServcr</code>获得的各个Manager也都是单例的。</p>
<p><strong>从上面的分析，我们可以总结出Vibrator服务的整个实现流程：</strong></p>
<ol>
<li><p>定义一个抽象类<code>Vibrator</code>，定义了应用中可以访问的一些抽象方法(抽象)<br><code>frameworks/base/core/java/android/os/Vibrator.java</code></p>
</li>
<li><p>定义具体的类<code>SystemVibrator</code>继承<code>Vibrator</code>，实现抽象方法（客户端调用）</p>
<p><code>frameworks/base/core/java/android/os/SystemVibrator.java</code></p>
</li>
<li><p>定义一个AIDL接口文件<code>IVibratorService</code>，定义系统服务接口（服务端接口）<br>frameworks/base/core/java/android/os/IVibratorService.aidl</p>
</li>
<li><p>定义服务VibratorService，实现IVibratorService定义的接口(服务端实现)<br><code>frameworks/base/services/java/com/android/server/VibratorService.java</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public class VibratorService extends IVibratorService.Stub</span><br></pre></td></tr></table></figure>
</li>
<li><p>将<code>VibratorServicey</code>添加到系统服务<br><code>frameworks/base/services/java/com/android/server/SystemServer.java</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">VibratorService vibrator &#x3D; null;</span><br><span class="line">...</span><br><span class="line">&#x2F;&#x2F;实例化VibratorService并添加到ServiceManager</span><br><span class="line">Slog.i(TAG, &quot;Vibrator Service&quot;);</span><br><span class="line">vibrator &#x3D; new VibratorService(context);</span><br><span class="line">ServiceManager.addService(&quot;vibrator&quot;, vibrator);</span><br><span class="line">...</span><br><span class="line">&#x2F;&#x2F;通知服务系统启动完成</span><br><span class="line">try &#123;</span><br><span class="line">    vibrator.systemReady();</span><br><span class="line">&#125; catch (Throwable e) &#123;</span><br><span class="line">    reportWtf(&quot;making Vibrator Service ready&quot;, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>SystemVibrator</code>中通过<code>IVibratorService</code>的代理连接到<code>VibratorService</code>，这样<code>SystemVibrator</code>的接口实现里就可以调用<code>IVibratorService</code>的接口：</p>
<p><code>frameworks/base/core/java/android/os/SystemVibrator.java</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private final IVibratorService mService;</span><br><span class="line">...</span><br><span class="line">public SystemVibrator() &#123;</span><br><span class="line">    ...</span><br><span class="line">    mService &#x3D; IVibratorService.Stub.asInterface(</span><br><span class="line">            ServiceManager.getService(&quot;vibrator&quot;));</span><br><span class="line">    ...</span><br><span class="line">    public boolean hasVibrator() &#123;</span><br><span class="line">        ...</span><br><span class="line">        try &#123;</span><br><span class="line">            return mService.hasVibrator();</span><br><span class="line">        &#125; catch (RemoteException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>Context</code>里定义一个代表<code>Vibrator</code>服务的字符串</p>
<p><code>frameworks/base/core/java/android/content/Context.java</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public static final String VIBRATOR_SERVICE &#x3D; &quot;vibrator&quot;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在ContextImpl里添加SystemVibrator的实例化过程<br><code>frameworks/base/core/java/android/app/ContextImpl.java</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">registerService(VIBRATOR_SERVICE, new ServiceFetcher() &#123;</span><br><span class="line">public Object createService(ContextImpl ctx) &#123;</span><br><span class="line">    return new SystemVibrator(ctx);</span><br><span class="line">&#125;&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>在应用中使用<code>Vibrator</code>的接口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Vibrator mVibrator &#x3D; (Vibrator) getSystemService(Context.VIBRATOR_SERVICE);</span><br><span class="line">mVibrator.vibrate(500);</span><br></pre></td></tr></table></figure>
</li>
<li><p>为保证编译正常，还需要将AIDL文件添加到编译配置里<br><code>frameworks/base/Android.mk</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_SRC_FILES +&#x3D; \</span><br><span class="line">...</span><br><span class="line">core&#x2F;java&#x2F;android&#x2F;os&#x2F;IVibratorService.aidl \</span><br></pre></td></tr></table></figure>

</li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8-SystemServer/" rel="tag"># Android系统启动-SystemServer</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/05/29/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8-Zygote/" rel="next" title="Android系统启动-Zygote">
                <i class="fa fa-chevron-left"></i> Android系统启动-Zygote
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/05/29/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8-SystemServer%20(2)/" rel="prev" title="Android系统启动-SystemServer(2)">
                Android系统启动-SystemServer(2) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="SOHUCS"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">冯星</p>
              <p class="site-description motion-element" itemprop="description">人生就像是一个马尔可夫链，你的未来取决于你当下正在做的事，而无关于过去做完的事</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7Carchive">
              
                  <span class="site-state-item-count">134</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">36</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">60</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#启动流程"><span class="nav-number">1.</span> <span class="nav-text">启动流程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ZygoteInit"><span class="nav-number">1.1.</span> <span class="nav-text">ZygoteInit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#main"><span class="nav-number">1.1.1.</span> <span class="nav-text">main()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#forkSystemServer"><span class="nav-number">1.1.2.</span> <span class="nav-text">forkSystemServer()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#如何创建system-server进程"><span class="nav-number">2.</span> <span class="nav-text">如何创建system_server进程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Zygote"><span class="nav-number">2.1.</span> <span class="nav-text">Zygote</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#forkSystemServer-1"><span class="nav-number">2.1.1.</span> <span class="nav-text">forkSystemServer()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nativeForkSystemServer"><span class="nav-number">2.1.2.</span> <span class="nav-text">nativeForkSystemServer()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#com-android-internal-os-Zygote"><span class="nav-number">2.2.</span> <span class="nav-text">com_android_internal_os_Zygote</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#com-android-internal-os-Zygote-nativeForkSystemServer"><span class="nav-number">2.2.1.</span> <span class="nav-text">com_android_internal_os_Zygote_nativeForkSystemServer()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ForkAndSpecializeCommon"><span class="nav-number">2.2.2.</span> <span class="nav-text">ForkAndSpecializeCommon()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#system-server进程已创建看看如何做后续处理"><span class="nav-number">3.</span> <span class="nav-text">system_server进程已创建看看如何做后续处理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ZygoteInit-1"><span class="nav-number">3.1.</span> <span class="nav-text">ZygoteInit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#handleSystemServerProcess"><span class="nav-number">3.1.1.</span> <span class="nav-text">handleSystemServerProcess()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zygoteInit"><span class="nav-number">3.1.2.</span> <span class="nav-text">zygoteInit()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nativeZygoteInit"><span class="nav-number">3.1.3.</span> <span class="nav-text">nativeZygoteInit()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AndroidRuntime-cpp"><span class="nav-number">3.2.</span> <span class="nav-text">AndroidRuntime.cpp</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#com-android-internal-os-RuntimeInit-nativeZygoteInit"><span class="nav-number">3.2.1.</span> <span class="nav-text">com_android_internal_os_RuntimeInit_nativeZygoteInit()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RuntimeInit"><span class="nav-number">3.3.</span> <span class="nav-text">RuntimeInit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#applicationInit"><span class="nav-number">3.3.1.</span> <span class="nav-text">applicationInit()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#findStaticMain"><span class="nav-number">3.3.2.</span> <span class="nav-text">findStaticMain()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MethodAndArgsCaller"><span class="nav-number">3.4.</span> <span class="nav-text">MethodAndArgsCaller</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#进入SystemServer中"><span class="nav-number">4.</span> <span class="nav-text">进入SystemServer中</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SystemServer"><span class="nav-number">4.1.</span> <span class="nav-text">SystemServer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#main-1"><span class="nav-number">4.1.1.</span> <span class="nav-text">main()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#run"><span class="nav-number">4.1.2.</span> <span class="nav-text">run()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#performPendingShutdown"><span class="nav-number">4.1.3.</span> <span class="nav-text">performPendingShutdown()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#createSystemContext"><span class="nav-number">4.1.4.</span> <span class="nav-text">createSystemContext()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#startBootstrapServices"><span class="nav-number">4.1.5.</span> <span class="nav-text">startBootstrapServices()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#startCoreServices"><span class="nav-number">4.1.6.</span> <span class="nav-text">startCoreServices()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#startOtherServices"><span class="nav-number">4.1.7.</span> <span class="nav-text">startOtherServices()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#至此System-Server启动完成"><span class="nav-number">5.</span> <span class="nav-text">至此System_Server启动完成</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#服务启动阶段"><span class="nav-number">6.</span> <span class="nav-text">服务启动阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Phase0"><span class="nav-number">6.1.</span> <span class="nav-text">Phase0</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Phase100"><span class="nav-number">6.2.</span> <span class="nav-text">Phase100</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Phase480"><span class="nav-number">6.3.</span> <span class="nav-text">Phase480</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Phase500"><span class="nav-number">6.4.</span> <span class="nav-text">Phase500</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Phase550"><span class="nav-number">6.5.</span> <span class="nav-text">Phase550</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Phase600"><span class="nav-number">6.6.</span> <span class="nav-text">Phase600</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Phase1000"><span class="nav-number">6.7.</span> <span class="nav-text">Phase1000</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#服务类别"><span class="nav-number">7.</span> <span class="nav-text">服务类别</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#客户端使用服务"><span class="nav-number">8.</span> <span class="nav-text">客户端使用服务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#一个简单的SystemService"><span class="nav-number">8.1.</span> <span class="nav-text">一个简单的SystemService</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">冯星</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'bbc85MrQ0qhACWJxhCKrJoAj-gzGzoHsz',
        appKey: 'fWH5REKFSsGT4TKe1lWt1ke4',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
