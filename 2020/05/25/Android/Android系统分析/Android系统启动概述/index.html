<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Android系统启动概述," />










<meta name="description" content="https:&#x2F;&#x2F;android.googlesource.com&#x2F;platform&#x2F;system&#x2F;core&#x2F;+&#x2F;refs&#x2F;tags&#x2F;android-cts-6.0_r32&#x2F;init&#x2F;init.cpp  Android系统启动流程按下电源之后，首先加载引导程序 BootLoader 到 RAM（运行内存）；然后，执行引导程序 BootLoader 以把系统 OS 拉起来；Android系统底层基于L">
<meta property="og:type" content="article">
<meta property="og:title" content="Android系统启动概述">
<meta property="og:url" content="http://yoursite.com/2020/05/25/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%A6%82%E8%BF%B0/index.html">
<meta property="og:site_name" content="冯星的博客">
<meta property="og:description" content="https:&#x2F;&#x2F;android.googlesource.com&#x2F;platform&#x2F;system&#x2F;core&#x2F;+&#x2F;refs&#x2F;tags&#x2F;android-cts-6.0_r32&#x2F;init&#x2F;init.cpp  Android系统启动流程按下电源之后，首先加载引导程序 BootLoader 到 RAM（运行内存）；然后，执行引导程序 BootLoader 以把系统 OS 拉起来；Android系统底层基于L">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/4118241-292fb596c9a68b24.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://gityuan.com/images/android-arch/android-booting.jpg">
<meta property="og:image" content="http://gityuan.com/images/boot/init/init_oneshot.jpg">
<meta property="article:published_time" content="2020-05-25T15:48:17.000Z">
<meta property="article:modified_time" content="2020-05-26T05:54:37.741Z">
<meta property="article:author" content="冯星">
<meta property="article:tag" content="Android系统启动概述">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/4118241-292fb596c9a68b24.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/05/25/Android/Android系统分析/Android系统启动概述/"/>





  <title>Android系统启动概述 | 冯星的博客</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">冯星的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Life is like a Markov chain, your future only depends on what you are doing now, and independent of your past.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/25/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%A6%82%E8%BF%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="冯星">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冯星的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android系统启动概述</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-25T23:48:17+08:00">
                2020-05-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/" itemprop="url" rel="index">
                    <span itemprop="name">Android系统分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/05/25/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%A6%82%E8%BF%B0/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/05/25/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%A6%82%E8%BF%B0/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><a href="https://android.googlesource.com/platform/system/core/+/refs/tags/android-cts-6.0_r32/init/init.cpp" target="_blank" rel="noopener">https://android.googlesource.com/platform/system/core/+/refs/tags/android-cts-6.0_r32/init/init.cpp</a></p>
<p><img src="https://upload-images.jianshu.io/upload_images/4118241-292fb596c9a68b24.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h1 id="Android系统启动流程"><a href="#Android系统启动流程" class="headerlink" title="Android系统启动流程"></a>Android系统启动流程</h1><p>按下电源之后，首先加载引导程序 BootLoader 到 RAM（运行内存）；然后，执行引导程序 BootLoader 以把系统 OS 拉起来；Android系统底层基于Linux Kernel, 当Kernel启动过程会创建init进程，该进程是所有用户空间的鼻祖,init进程会启动servicemanager(binder服务管家), Zygote进程(Java进程的鼻祖). Zygote进程会创建 system_server进程以及各种app进程，下图是这几个系统重量级进程之间的层级关系。</p>
<p><img src="http://gityuan.com/images/android-arch/android-booting.jpg" alt="android-booting"></p>
<h2 id="init进程"><a href="#init进程" class="headerlink" title="init进程"></a>init进程</h2><p><a href="http://gityuan.com/2016/02/05/android-init/" target="_blank" rel="noopener">init</a>是Linux系统中用户空间的第一个进程(pid=1), Kerner启动后会调用/system/core/init/Init.cpp的main()方法.</p>
<h3 id="init-main"><a href="#init-main" class="headerlink" title="init.main()"></a>init.main()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, char** argv) &#123;</span><br><span class="line">    ...</span><br><span class="line">    klog_init();  &#x2F;&#x2F;初始化kernel log</span><br><span class="line">    property_init(); &#x2F;&#x2F;创建一块共享的内存空间，用于属性服务</span><br><span class="line">    signal_handler_init();  &#x2F;&#x2F;初始化子进程退出的信号处理过程</span><br><span class="line"></span><br><span class="line">    property_load_boot_defaults(); &#x2F;&#x2F;加载&#x2F;default.prop文件</span><br><span class="line">    start_property_service();   &#x2F;&#x2F;启动属性服务器(通过socket通信)</span><br><span class="line">    init_parse_config_file(&quot;&#x2F;init.rc&quot;); &#x2F;&#x2F;解析init.rc文件</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;执行rc文件中触发器为 on early-init的语句</span><br><span class="line">    action_for_each_trigger(&quot;early-init&quot;, action_add_queue_tail);</span><br><span class="line">    &#x2F;&#x2F;执行rc文件中触发器为 on init的语句</span><br><span class="line">    action_for_each_trigger(&quot;init&quot;, action_add_queue_tail);</span><br><span class="line">    &#x2F;&#x2F;执行rc文件中触发器为 on late-init的语句</span><br><span class="line">    action_for_each_trigger(&quot;late-init&quot;, action_add_queue_tail);</span><br><span class="line"></span><br><span class="line">    while (true) &#123;</span><br><span class="line">        if (!waiting_for_exec) &#123;</span><br><span class="line">            execute_one_command();</span><br><span class="line">            restart_processes();</span><br><span class="line">        &#125;</span><br><span class="line">        int timeout &#x3D; -1;</span><br><span class="line">        if (process_needs_restart) &#123;</span><br><span class="line">            timeout &#x3D; (process_needs_restart - gettime()) * 1000;</span><br><span class="line">            if (timeout &lt; 0)</span><br><span class="line">                timeout &#x3D; 0;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!action_queue_empty() || cur_action) &#123;</span><br><span class="line">            timeout &#x3D; 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        epoll_event ev;</span><br><span class="line">        &#x2F;&#x2F;循环 等待事件发生</span><br><span class="line">        int nr &#x3D; TEMP_FAILURE_RETRY(epoll_wait(epoll_fd, &amp;ev, 1, timeout));</span><br><span class="line">        if (nr &#x3D;&#x3D; -1) &#123;</span><br><span class="line">            ERROR(&quot;epoll_wait failed: %s\n&quot;, strerror(errno));</span><br><span class="line">        &#125; else if (nr &#x3D;&#x3D; 1) &#123;</span><br><span class="line">            ((void (*)()) ev.data.ptr)();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>init进程的主要功能点:</p>
<ul>
<li>分析和运行所有的init.rc文件;</li>
<li>生成设备驱动节点; （通过rc文件创建）</li>
<li>处理子进程的终止(signal方式);</li>
<li>提供属性服务property service。</li>
</ul>
<h3 id="Zygote自动重启机制"><a href="#Zygote自动重启机制" class="headerlink" title="Zygote自动重启机制"></a>Zygote自动重启机制</h3><p>当init解析到下面这条语句,便会启动Zygote进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">service zygote &#x2F;system&#x2F;bin&#x2F;app_process -Xzygote &#x2F;system&#x2F;bin --zygote --start-system-server</span><br><span class="line">    class main                             &#x2F;&#x2F;伴随着main class的启动而启动</span><br><span class="line">    socket zygote stream 660 root system   &#x2F;&#x2F;创建socket</span><br><span class="line">    onrestart write &#x2F;sys&#x2F;android_power&#x2F;request_state wake</span><br><span class="line">    onrestart write &#x2F;sys&#x2F;power&#x2F;state on</span><br><span class="line">    onrestart restart media              &#x2F;&#x2F;当zygote重启时,则会重启media</span><br><span class="line">    onrestart restart netd               &#x2F;&#x2F; 当zygote重启时,则会重启netd</span><br></pre></td></tr></table></figure>

<p>当init子进程(Zygote)退出时，会产生SIGCHLD信号，并发送给init进程，通过socket套接字传递数据，调用到wait_for_one_process()方法，根据是否是oneshot，来决定是重启子进程，还是放弃启动。由于缺省模式oneshot=false,因此Zygote一旦被杀便会再次由init进程拉起.</p>
<p><img src="http://gityuan.com/images/boot/init/init_oneshot.jpg" alt="init_oneshot"></p>
<h2 id="Zygote进程"><a href="#Zygote进程" class="headerlink" title="Zygote进程"></a>Zygote进程</h2><p><a href="https://android.googlesource.com/platform/frameworks/base/+/refs/tags/android-6.0.0_r5/cmds/app_process/app_main.cpp" target="_blank" rel="noopener">https://android.googlesource.com/platform/frameworks/base/+/refs/tags/android-6.0.0_r5/cmds/app_process/app_main.cpp</a></p>
<p>当<a href="http://gityuan.com/2016/02/13/android-zygote/" target="_blank" rel="noopener">Zygote</a>进程启动后, 便会执行到frameworks/base/cmds/app_process/App_main.cpp文件的main()方法. 整个调用流程:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">App_main.main</span><br><span class="line">    AndroidRuntime.start</span><br><span class="line">        AndroidRuntime.startVm</span><br><span class="line">        AndroidRuntime.startReg</span><br><span class="line">        ZygoteInit.main (首次进入Java世界)</span><br><span class="line">            registerZygoteSocket</span><br><span class="line">            preload</span><br><span class="line">            startSystemServer</span><br><span class="line">            runSelectLoop</span><br></pre></td></tr></table></figure>

<h3 id="App-main-main"><a href="#App-main-main" class="headerlink" title="App_main.main"></a>App_main.main</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, char* const argv[])</span><br><span class="line">&#123;</span><br><span class="line">    AppRuntime runtime(argv[0], computeArgBlockSize(argc, argv));</span><br><span class="line">    while (i &lt; argc) &#123;</span><br><span class="line">        ...&#x2F;&#x2F;参数解析</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;设置进程名</span><br><span class="line">    if (!niceName.isEmpty()) &#123;</span><br><span class="line">        runtime.setArgv0(niceName.string());</span><br><span class="line">        set_process_name(niceName.string());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (zygote) &#123;</span><br><span class="line">        &#x2F;&#x2F; 启动AppRuntime，见小节[3.2]</span><br><span class="line">        runtime.start(&quot;com.android.internal.os.ZygoteInit&quot;, args, zygote);</span><br><span class="line">    &#125; else if (className) &#123;</span><br><span class="line">        runtime.start(&quot;com.android.internal.os.RuntimeInit&quot;, args, zygote);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在app_process进程启动过程，有两个分支：</p>
<ul>
<li>当zygote为true时，则执行ZygoteInit.main()</li>
<li>当zygote为false时，则执行RuntimeInit.main()</li>
</ul>
<h3 id="AndroidRuntime-start"><a href="#AndroidRuntime-start" class="headerlink" title="AndroidRuntime::start"></a>AndroidRuntime::start</h3><p>[-&gt; AndroidRuntime.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">void AndroidRuntime::start(const char* className, const Vector&lt;String8&gt;&amp; options)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    &#x2F;&#x2F; 虚拟机创建</span><br><span class="line">    if (startVm(&amp;mJavaVM, &amp;env, zygote) !&#x3D; 0) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    onVmCreated(env);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; JNI方法注册</span><br><span class="line">    if (startReg(env) &lt; 0) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    &#x2F;&#x2F; 调用ZygoteInit.main()方法[见小节3.3]</span><br><span class="line">    env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);</span><br></pre></td></tr></table></figure>

<h3 id="ZygoteInit-main–Java"><a href="#ZygoteInit-main–Java" class="headerlink" title="ZygoteInit.main–Java"></a>ZygoteInit.main–Java</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String argv[]) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        ...</span><br><span class="line">        registerZygoteSocket(socketName); &#x2F;&#x2F;为Zygote注册socket</span><br><span class="line">        preload(); &#x2F;&#x2F; 预加载类和资源[见小节3.4]</span><br><span class="line">        ...</span><br><span class="line">        if (startSystemServer) &#123;</span><br><span class="line">            startSystemServer(abiList, socketName);&#x2F;&#x2F;启动system_server[见小节3.5]</span><br><span class="line">        &#125;</span><br><span class="line">        Log.i(TAG, &quot;Accepting command socket connections&quot;);</span><br><span class="line">        runSelectLoop(abiList); &#x2F;&#x2F;进入循环模式[见小节3.6]</span><br><span class="line">        ...</span><br><span class="line">    &#125; catch (MethodAndArgsCaller caller) &#123;</span><br><span class="line">        caller.run(); &#x2F;&#x2F;启动system_server中会讲到。</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ZygoteInit-preload"><a href="#ZygoteInit-preload" class="headerlink" title="ZygoteInit.preload"></a>ZygoteInit.preload</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">static void preload() &#123;</span><br><span class="line">    Log.d(TAG, &quot;begin preload&quot;);</span><br><span class="line">    preloadClasses();</span><br><span class="line">    preloadResources();</span><br><span class="line">    preloadOpenGL();</span><br><span class="line">    preloadSharedLibraries();</span><br><span class="line">    WebViewFactory.prepareWebViewInZygote();</span><br><span class="line">    Log.d(TAG, &quot;end preload&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ZygoteInit-startSystemServer"><a href="#ZygoteInit-startSystemServer" class="headerlink" title="ZygoteInit.startSystemServer"></a>ZygoteInit.startSystemServer</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">private static boolean startSystemServer(String abiList, String socketName)</span><br><span class="line">        throws MethodAndArgsCaller, RuntimeException &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; fork子进程system_server</span><br><span class="line">    pid &#x3D; Zygote.forkSystemServer(</span><br><span class="line">            parsedArgs.uid, parsedArgs.gid,</span><br><span class="line">            parsedArgs.gids,</span><br><span class="line">            parsedArgs.debugFlags,</span><br><span class="line">            null,</span><br><span class="line">            parsedArgs.permittedCapabilities,</span><br><span class="line">            parsedArgs.effectiveCapabilities);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    if (pid &#x3D;&#x3D; 0) &#123;</span><br><span class="line">        if (hasSecondZygote(abiList)) &#123;</span><br><span class="line">            waitForSecondaryZygote(socketName);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;进入system_server进程[见小节4.1]</span><br><span class="line">        handleSystemServerProcess(parsedArgs);</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ZygoteInit-runSelectLoop"><a href="#ZygoteInit-runSelectLoop" class="headerlink" title="ZygoteInit.runSelectLoop"></a>ZygoteInit.runSelectLoop</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">private static void runSelectLoop(String abiList) throws MethodAndArgsCaller &#123;</span><br><span class="line">    ArrayList&lt;FileDescriptor&gt; fds &#x3D; new ArrayList&lt;FileDescriptor&gt;();</span><br><span class="line">    ArrayList&lt;ZygoteConnection&gt; peers &#x3D; new ArrayList&lt;ZygoteConnection&gt;();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;sServerSocket是socket通信中的服务端，即zygote进程</span><br><span class="line">    fds.add(sServerSocket.getFileDescriptor());</span><br><span class="line">    peers.add(null);</span><br><span class="line"></span><br><span class="line">    while (true) &#123;</span><br><span class="line">        StructPollfd[] pollFds &#x3D; new StructPollfd[fds.size()];</span><br><span class="line">        for (int i &#x3D; 0; i &lt; pollFds.length; ++i) &#123;</span><br><span class="line">            pollFds[i] &#x3D; new StructPollfd();</span><br><span class="line">            pollFds[i].fd &#x3D; fds.get(i);</span><br><span class="line">            pollFds[i].events &#x3D; (short) POLLIN;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        Os.poll(pollFds, -1);</span><br><span class="line"></span><br><span class="line">        for (int i &#x3D; pollFds.length - 1; i &gt;&#x3D; 0; --i) &#123;</span><br><span class="line">            &#x2F;&#x2F;采用I&#x2F;O多路复用机制，当客户端发出 连接请求或者数据处理请求时，则执行continue</span><br><span class="line">            if ((pollFds[i].revents &amp; POLLIN) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            if (i &#x3D;&#x3D; 0) &#123;</span><br><span class="line">                &#x2F;&#x2F;创建客户端连接</span><br><span class="line">                ZygoteConnection newPeer &#x3D; acceptCommandPeer(abiList);</span><br><span class="line">                peers.add(newPeer);</span><br><span class="line">                fds.add(newPeer.getFileDesciptor());</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                &#x2F;&#x2F;处理客户端数据事务</span><br><span class="line">                boolean done &#x3D; peers.get(i).runOnce();</span><br><span class="line">                if (done) &#123;</span><br><span class="line">                    peers.remove(i);</span><br><span class="line">                    fds.remove(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Zygote进程创建Java虚拟机,并注册JNI方法， 真正成为Java进程的母体，用于孵化Java进程. 在创建完system_server进程后,zygote功成身退，调用runSelectLoop()，随时待命，当接收到请求创建新进程请求时立即唤醒并执行相应工作。</p>
<h2 id="system-server"><a href="#system-server" class="headerlink" title="system_server"></a>system_server</h2><p>Zygote通过fork后创建system_server进程，在小节[3.5]执行完startSystemServer()方法后，进入到了handleSystemServerProcess()方法，如下所示。</p>
<h3 id="handleSystemServerProcess"><a href="#handleSystemServerProcess" class="headerlink" title="handleSystemServerProcess"></a>handleSystemServerProcess</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">private static void handleSystemServerProcess( ZygoteConnection.Arguments parsedArgs) throws ZygoteInit.MethodAndArgsCaller &#123;</span><br><span class="line">    ...</span><br><span class="line">    if (parsedArgs.niceName !&#x3D; null) &#123;</span><br><span class="line">         &#x2F;&#x2F;设置当前进程名为&quot;system_server&quot;</span><br><span class="line">        Process.setArgV0(parsedArgs.niceName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final String systemServerClasspath &#x3D; Os.getenv(&quot;SYSTEMSERVERCLASSPATH&quot;);</span><br><span class="line">    if (systemServerClasspath !&#x3D; null) &#123;</span><br><span class="line">        &#x2F;&#x2F;执行dex优化操作,比如services.jar</span><br><span class="line">        performSystemServerDexOpt(systemServerClasspath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (parsedArgs.invokeWith !&#x3D; null) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        ClassLoader cl &#x3D; null;</span><br><span class="line">        if (systemServerClasspath !&#x3D; null) &#123;</span><br><span class="line">            cl &#x3D; new PathClassLoader(systemServerClasspath, ClassLoader.getSystemClassLoader());</span><br><span class="line">            Thread.currentThread().setContextClassLoader(cl);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;[见小节4.2]</span><br><span class="line">        RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, cl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>system_server进程创建PathClassLoader类加载器.</p>
<h3 id="RuntimeInit-zygoteInit"><a href="#RuntimeInit-zygoteInit" class="headerlink" title="RuntimeInit.zygoteInit"></a>RuntimeInit.zygoteInit</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static final void zygoteInit(int targetSdkVersion, String[] argv, ClassLoader classLoader) throws ZygoteInit.MethodAndArgsCaller &#123;</span><br><span class="line"></span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;RuntimeInit&quot;);</span><br><span class="line">    redirectLogStreams(); &#x2F;&#x2F;重定向log输出</span><br><span class="line"></span><br><span class="line">    commonInit(); &#x2F;&#x2F; 通用的一些初始化</span><br><span class="line">    nativeZygoteInit(); &#x2F;&#x2F; zygote初始化</span><br><span class="line">    applicationInit(targetSdkVersion, argv, classLoader); &#x2F;&#x2F; [见小节3.4]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Binder线程池启动"><a href="#Binder线程池启动" class="headerlink" title="Binder线程池启动"></a>Binder线程池启动</h2><p>nativeZygoteInit()方法经过层层调用,会进入app_main.cpp中的onZygoteInit()方法, Binder线程池的创建也是在这个过程,如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">virtual void onZygoteInit() &#123;</span><br><span class="line">    sp&lt;ProcessState&gt; proc &#x3D; ProcessState::self();</span><br><span class="line">    proc-&gt;startThreadPool(); &#x2F;&#x2F;启动新binder线程池</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="捕获特殊异常"><a href="#捕获特殊异常" class="headerlink" title="捕获特殊异常"></a>捕获特殊异常</h2><p>applicationInit()方法经过层层调用,会抛出异常ZygoteInit.MethodAndArgsCaller(m, argv), 具体过程如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">protected static Runnable applicationInit(int targetSdkVersion, String[] argv,</span><br><span class="line">        ClassLoader classLoader) &#123;</span><br><span class="line">    ...</span><br><span class="line">    VMRuntime.getRuntime().setTargetHeapUtilization(0.75f);</span><br><span class="line">    VMRuntime.getRuntime().setTargetSdkVersion(targetSdkVersion);</span><br><span class="line">    final Arguments args &#x3D; new Arguments(argv);</span><br><span class="line">    &#x2F;&#x2F;找到目标类的静态main()方法</span><br><span class="line">    invokeStaticMain(args.startClass, args.startArgs, classLoader);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private static void invokeStaticMain(String className, String[] argv, ClassLoader classLoader)</span><br><span class="line">            throws ZygoteInit.MethodAndArgsCaller &#123;</span><br><span class="line">    &#x2F;&#x2F;此处的className等于SystemServer</span><br><span class="line">    Class&lt;?&gt; cl &#x3D; Class.forName(className, true, classLoader);</span><br><span class="line">    Method  m &#x3D; cl.getMethod(&quot;main&quot;, new Class[] &#123; String[].class &#125;);</span><br><span class="line">    &#x2F;&#x2F;抛出异常Runnable对象</span><br><span class="line">    throw new ZygoteInit.MethodAndArgsCaller(m, argv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ZygoteInit-main"><a href="#ZygoteInit-main" class="headerlink" title="ZygoteInit.main"></a>ZygoteInit.main</h3><p>[–&gt;ZygoteInit.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String argv[]) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        startSystemServer(abiList, socketName); &#x2F;&#x2F;抛出MethodAndArgsCaller异常</span><br><span class="line">        ....</span><br><span class="line">    &#125; catch (MethodAndArgsCaller caller) &#123;</span><br><span class="line">        caller.run(); &#x2F;&#x2F;此处通过反射,会调用SystemServer.main()方法 [见小节4.4]</span><br><span class="line">    &#125; catch (RuntimeException ex) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static class MethodAndArgsCaller implements Runnable &#123;</span><br><span class="line">    private final Method mMethod;</span><br><span class="line">    private final String[] mArgs;</span><br><span class="line"></span><br><span class="line">    public MethodAndArgsCaller(Method method, String[] args) &#123;</span><br><span class="line">        mMethod &#x3D; method;</span><br><span class="line">        mArgs &#x3D; args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void run() &#123;</span><br><span class="line">        &#x2F;&#x2F;执行SystemServer.main()</span><br><span class="line">        mMethod.invoke(null, new Object[] &#123; mArgs &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>采用抛出异常的方式,用于栈帧清空,提供利用率, 以至于现在大家看到的每个Java进程的调用栈如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">at com.android.server.SystemServer.main(SystemServer.java:175)</span><br><span class="line">at java.lang.reflect.Method.invoke!(Native method)</span><br><span class="line">at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:738)</span><br><span class="line">at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:628)</span><br></pre></td></tr></table></figure>

<h3 id="SystemServer-main"><a href="#SystemServer-main" class="headerlink" title="SystemServer.main"></a>SystemServer.main</h3><p>[–&gt;SystemServer.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public final class SystemServer &#123;</span><br><span class="line">    ...</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        &#x2F;&#x2F;先初始化SystemServer对象，再调用对象的run()方法</span><br><span class="line">        new SystemServer().run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SystemServer-run"><a href="#SystemServer-run" class="headerlink" title="SystemServer.run"></a>SystemServer.run</h3><p>[–&gt;SystemServer.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">private void run() &#123;</span><br><span class="line">    if (System.currentTimeMillis() &lt; EARLIEST_SUPPORTED_TIME) &#123;</span><br><span class="line">        Slog.w(TAG, &quot;System clock is before 1970; setting to 1970.&quot;);</span><br><span class="line">        SystemClock.setCurrentTimeMillis(EARLIEST_SUPPORTED_TIME);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    Slog.i(TAG, &quot;Entered the Android system server!&quot;);</span><br><span class="line">    EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_SYSTEM_RUN, SystemClock.uptimeMillis());</span><br><span class="line">    Looper.prepareMainLooper();&#x2F;&#x2F; 准备主线程looper</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;加载android_servers.so库，该库包含的源码在frameworks&#x2F;base&#x2F;services&#x2F;目录下</span><br><span class="line">    System.loadLibrary(&quot;android_servers&quot;);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;检测上次关机过程是否失败，该方法可能不会返回</span><br><span class="line">    performPendingShutdown();</span><br><span class="line">    createSystemContext(); &#x2F;&#x2F;初始化系统上下文</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;创建系统服务管理</span><br><span class="line">    mSystemServiceManager &#x3D; new SystemServiceManager(mSystemContext);</span><br><span class="line">    LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;启动各种系统服务</span><br><span class="line">    try &#123;</span><br><span class="line">        startBootstrapServices(); &#x2F;&#x2F; 启动引导服务</span><br><span class="line">        startCoreServices();      &#x2F;&#x2F; 启动核心服务</span><br><span class="line">        startOtherServices();     &#x2F;&#x2F; 启动其他服务[见小节4.6]</span><br><span class="line">    &#125; catch (Throwable ex) &#123;</span><br><span class="line">        Slog.e(&quot;System&quot;, &quot;************ Failure starting system services&quot;, ex);</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;一直循环执行</span><br><span class="line">    Looper.loop();</span><br><span class="line">    throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="服务启动"><a href="#服务启动" class="headerlink" title="服务启动"></a>服务启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public final class SystemServer &#123;</span><br><span class="line">    private void startBootstrapServices() &#123;</span><br><span class="line">      ...</span><br><span class="line">      &#x2F;&#x2F;phase100</span><br><span class="line">      mSystemServiceManager.startBootPhase(SystemService.PHASE_WAIT_FOR_DEFAULT_DISPLAY);</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void startOtherServices() &#123;</span><br><span class="line">        ...</span><br><span class="line">        &#x2F;&#x2F;phase480 和phase500</span><br><span class="line">        mSystemServiceManager.startBootPhase(SystemService.PHASE_LOCK_SETTINGS_READY);</span><br><span class="line">        mSystemServiceManager.startBootPhase(SystemService.PHASE_SYSTEM_SERVICES_READY);</span><br><span class="line">        ...</span><br><span class="line">        &#x2F;&#x2F;[见小节4.7]</span><br><span class="line">        mActivityManagerService.systemReady(new Runnable() &#123;</span><br><span class="line">           @Override</span><br><span class="line">           public void run() &#123;</span><br><span class="line">               &#x2F;&#x2F;phase550</span><br><span class="line">               mSystemServiceManager.startBootPhase(</span><br><span class="line">                       SystemService.PHASE_ACTIVITY_MANAGER_READY);</span><br><span class="line">               ...</span><br><span class="line">               &#x2F;&#x2F;phase600</span><br><span class="line">               mSystemServiceManager.startBootPhase(</span><br><span class="line">                       SystemService.PHASE_THIRD_PARTY_APPS_CAN_START);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>start: 创建AMS, PMS, LightsService, DMS.</li>
<li>phase100: 进入Phase100, 创建PKMS, WMS, IMS, DBMS, LockSettingsService, JobSchedulerService, MmsService等服务;</li>
<li>phase480 &amp;&amp; 500: 进入Phase480, 调用WMS, PMS, PKMS, DisplayManagerService这4个服务的systemReady();</li>
<li>Phase550: 进入phase550, 执行AMS.systemReady(), 启动SystemUI, WebViewFactory, Watchdog.</li>
<li>Phase600: 进入phase600, 执行AMS.systemReady(), 执行各种服务的systemRunning().</li>
<li>Phase1000: 进入1000, 执行finishBooting, 启动启动on-hold进程.</li>
</ul>
<h3 id="AMS-systemReady"><a href="#AMS-systemReady" class="headerlink" title="AMS.systemReady"></a>AMS.systemReady</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public final class ActivityManagerService extends ActivityManagerNative implements Watchdog.Monitor, BatteryStatsImpl.BatteryCallback &#123;</span><br><span class="line"></span><br><span class="line">    public void systemReady(final Runnable goingCallback) &#123;</span><br><span class="line">        ... &#x2F;&#x2F;update相关</span><br><span class="line">        mSystemReady &#x3D; true;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;杀掉所有非persistent进程</span><br><span class="line">        removeProcessLocked(proc, true, false, &quot;system update done&quot;);</span><br><span class="line">        mProcessesReady &#x3D; true;</span><br><span class="line"></span><br><span class="line">        goingCallback.run();  &#x2F;&#x2F;[见小节1.6.2]</span><br><span class="line"></span><br><span class="line">        addAppLocked(info, false, null); &#x2F;&#x2F;启动所有的persistent进程</span><br><span class="line">        mBooting &#x3D; true;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;启动home</span><br><span class="line">        startHomeActivityLocked(mCurrentUserId, &quot;systemReady&quot;);</span><br><span class="line">        &#x2F;&#x2F;恢复栈顶的Activity</span><br><span class="line">        mStackSupervisor.resumeTopActivitiesLocked();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>System_server主线程的启动工作,总算完成, 进入Looper.loop()状态,等待其他线程通过handler发送消息再处理.</p>
<h2 id="app"><a href="#app" class="headerlink" title="app"></a>app</h2><p>对于普通的app进程,跟system_server进程的启动过程有些类似.不同的是app进程是向发消息给system_server进程, 由system_server向zygote发出创建进程的请求.</p>
<p><a href="http://gityuan.com/2016/03/26/app-process-create/" target="_blank" rel="noopener">理解Android进程创建流程</a>, 可知进程创建后 接下来会进入ActivityThread.main()过程。</p>
<h3 id="ActivityThread-main"><a href="#ActivityThread-main" class="headerlink" title="ActivityThread.main"></a>ActivityThread.main</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    ...</span><br><span class="line">    Environment.initForCurrentUser();</span><br><span class="line">    ...</span><br><span class="line">    Process.setArgV0(&quot;&lt;pre-initialized&gt;&quot;);</span><br><span class="line">    &#x2F;&#x2F;创建主线程looper</span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">    ActivityThread thread &#x3D; new ActivityThread();</span><br><span class="line">    thread.attach(false); &#x2F;&#x2F;attach到系统进程</span><br><span class="line"></span><br><span class="line">    if (sMainThreadHandler &#x3D;&#x3D; null) &#123;</span><br><span class="line">        sMainThreadHandler &#x3D; thread.getHandler();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;主线程进入循环状态</span><br><span class="line">    Looper.loop();</span><br><span class="line">    throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="调用栈对比"><a href="#调用栈对比" class="headerlink" title="调用栈对比"></a>调用栈对比</h3><p>App进程的主线程调用栈的栈底如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    at android.app.ActivityThread.main(ActivityThread.java:5442)</span><br><span class="line">    at java.lang.reflect.Method.invoke!(Native method)</span><br><span class="line">    at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:738)</span><br><span class="line">    at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:628)</span><br></pre></td></tr></table></figure>

<p>跟前面介绍的system_server进程调用栈对比:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">at com.android.server.SystemServer.main(SystemServer.java:175)</span><br><span class="line">at java.lang.reflect.Method.invoke!(Native method)</span><br><span class="line">at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:738)</span><br><span class="line">at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:628)</span><br></pre></td></tr></table></figure>

<h2 id="启动日志分析"><a href="#启动日志分析" class="headerlink" title="启动日志分析"></a>启动日志分析</h2><p>以下列举启动部分重要进程以及关键节点会打印出的log</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;system&#x2F;bin&#x2F;vold: 383</span><br><span class="line">&#x2F;system&#x2F;bin&#x2F;lmkd: 432</span><br><span class="line">&#x2F;system&#x2F;bin&#x2F;surfaceflinger: 434</span><br><span class="line">&#x2F;system&#x2F;bin&#x2F;debuggerd64: 537</span><br><span class="line">&#x2F;system&#x2F;bin&#x2F;mediaserver: 540</span><br><span class="line">&#x2F;system&#x2F;bin&#x2F;installd: 541</span><br><span class="line">&#x2F;system&#x2F;vendor&#x2F;bin&#x2F;thermal-engine: 552</span><br><span class="line"></span><br><span class="line">zygote64: 557</span><br><span class="line">zygote: 558</span><br><span class="line">system_server: 1274</span><br></pre></td></tr></table></figure>

<h3 id="before-zygote日志"><a href="#before-zygote日志" class="headerlink" title="before zygote日志"></a>before zygote日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;启动vold, 再列举当前系统所支持的文件系统.  执行到system&#x2F;vold&#x2F;main.cpp的main()</span><br><span class="line">11-23 14:36:47.474   383   383 I vold    : Vold 3.0 (the awakening) firing up  </span><br><span class="line">11-23 14:36:47.475   383   383 V vold    : Detected support for: ext4 vfat   </span><br><span class="line">&#x2F;&#x2F;使用内核的lmk策略</span><br><span class="line">11-23 14:36:47.927   432   432 I lowmemorykiller: Using in-kernel low memory killer interface</span><br><span class="line">&#x2F;&#x2F;启动SurfaceFlinger</span><br><span class="line">11-23 14:36:48.041   434   434 I SurfaceFlinger: SurfaceFlinger is starting</span><br><span class="line">11-23 14:36:48.042   434   434 I SurfaceFlinger: SurfaceFlinger&#39;s main thread ready to run. Initializing graphics H&#x2F;W...</span><br><span class="line">&#x2F;&#x2F; 开机动画</span><br><span class="line">11-23 14:36:48.583   508   508 I BootAnimation: bootanimation launching ...</span><br><span class="line">&#x2F;&#x2F; debuggerd</span><br><span class="line">11-23 14:36:50.306   537   537 I         : debuggerd: starting</span><br><span class="line">&#x2F;&#x2F; installd启动</span><br><span class="line">11-23 14:36:50.311   541   541 I installd: installd firing up</span><br><span class="line">&#x2F;&#x2F; thermal守护进程</span><br><span class="line">11-23 14:36:50.369   552   552 I ThermalEngine: Thermal daemon started</span><br></pre></td></tr></table></figure>

<h3 id="zygote日志"><a href="#zygote日志" class="headerlink" title="zygote日志"></a>zygote日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Zygote64进程(Zygote):  AndroidRuntime::start</span><br><span class="line">11-23 14:36:51.260   557   557 D AndroidRuntime: &gt;&gt;&gt;&gt;&gt;&gt; START com.android.internal.os.ZygoteInit uid 0 &lt;&lt;&lt;&lt;&lt;&lt;</span><br><span class="line">&#x2F;&#x2F; Zygote64进程:  AndroidRuntime::startVm</span><br><span class="line">11-23 14:36:51.304   557   557 D AndroidRuntime: CheckJNI is OFF</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 执行ZygoteInit.preload()</span><br><span class="line">11-23 14:36:52.134   557   557 D Zygote  : begin preload</span><br><span class="line">&#x2F;&#x2F; 执行ZygoteInit.preloadClasses(), 预加载3860个classes, 花费时长746ms</span><br><span class="line">11-23 14:36:52.134   557   557 I Zygote  : Preloading classes...</span><br><span class="line">11-23 14:36:52.881   557   557 I Zygote  : ...preloaded 3860 classes in 746ms.</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 执行ZygoteInit.preloadClasses(), 预加载86组资源, 花费时长179ms</span><br><span class="line">11-23 14:36:53.114   557   557 I Zygote  : Preloading resources...</span><br><span class="line">11-23 14:36:53.293   557   557 I Zygote  : ...preloaded 86 resources in 179ms.</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 执行ZygoteInit.preloadSharedLibraries()</span><br><span class="line">11-23 14:36:53.494   557   557 I Zygote  : Preloading shared libraries...</span><br><span class="line">11-23 14:36:53.503   557   557 D Zygote  : end preload</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 执行com_android_internal_os_Zygote_nativeForkSystemServer(),成功fork出system_server进程</span><br><span class="line">11-23 14:36:53.544   557   557 I Zygote  : System server process 1274 has been created</span><br><span class="line">&#x2F;&#x2F; Zygote开始进入runSelectLoop()</span><br><span class="line">11-23 14:36:53.546   557   557 I Zygote  : Accepting command socket connections</span><br></pre></td></tr></table></figure>

<h3 id="system-server日志"><a href="#system-server日志" class="headerlink" title="system_server日志"></a>system_server日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;进入system_server, 建立跟Zygote进程的socket通道</span><br><span class="line">11-23 14:36:53.586  1274  1274 I Zygote  : Process: zygote socket opened, supported ABIS: armeabi-v7a,armeabi</span><br><span class="line">&#x2F;&#x2F; 执行SystemServer.run()</span><br><span class="line">11-23 14:36:53.618  1274  1274 I SystemServer: Entered the Android system server!   &lt;&#x3D;&#x3D;&#x3D;&gt; boot_progress_system_run</span><br><span class="line">&#x2F;&#x2F; 等待installd准备就绪</span><br><span class="line">11-23 14:36:53.707  1274  1274 I Installer: Waiting for installd to be ready.</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;服务启动</span><br><span class="line">11-23 14:36:53.732  1274  1274 I ActivityManager: Memory class: 192</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;phase100</span><br><span class="line">11-23 14:36:53.883  1274  1274 I SystemServiceManager: Starting phase 100</span><br><span class="line">11-23 14:36:53.902  1274  1274 I SystemServer: Package Manager</span><br><span class="line">11-23 14:37:03.816  1274  1274 I SystemServer: User Service</span><br><span class="line">...</span><br><span class="line">11-23 14:37:03.940  1274  1274 I SystemServer: Init Watchdog</span><br><span class="line">11-23 14:37:03.941  1274  1274 I SystemServer: Input Manager</span><br><span class="line">11-23 14:37:03.946  1274  1274 I SystemServer: Window Manager</span><br><span class="line">...</span><br><span class="line">11-23 14:37:04.081  1274  1274 I SystemServiceManager: Starting com.android.server.MountService$Lifecycle</span><br><span class="line">11-23 14:37:04.088  1274  2717 D MountService: Thinking about reset, mSystemReady&#x3D;false, mDaemonConnected&#x3D;true</span><br><span class="line">11-23 14:37:04.088  1274  1274 I SystemServiceManager: Starting com.android.server.UiModeManagerService</span><br><span class="line">11-23 14:37:04.520  1274  1274 I SystemServer: NetworkTimeUpdateService</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;phase480 &amp;&amp; 500</span><br><span class="line">11-23 14:37:05.056  1274  1274 I SystemServiceManager: Starting phase 480</span><br><span class="line">11-23 14:37:05.061  1274  1274 I SystemServiceManager: Starting phase 500</span><br><span class="line">11-23 14:37:05.231  1274  1274 I ActivityManager: System now ready  &lt;&#x3D;&#x3D;&gt; boot_progress_ams_ready</span><br><span class="line">11-23 14:37:05.234  1274  1274 I SystemServer: Making services ready</span><br><span class="line">11-23 14:37:05.243  1274  1274 I SystemServer: WebViewFactory preparation</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;phase550</span><br><span class="line">11-23 14:37:05.234  1274  1274 I SystemServiceManager: Starting phase 550</span><br><span class="line">11-23 14:37:05.237  1274  1288 I ActivityManager: Force stopping com.android.providers.media appid&#x3D;10010 user&#x3D;-1: vold reset</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;Phase600</span><br><span class="line">11-23 14:37:06.066  1274  1274 I SystemServiceManager: Starting phase 600</span><br><span class="line">11-23 14:37:06.236  1274  1274 D MountService: onStartUser 0</span><br></pre></td></tr></table></figure>

<h3 id="logcat小技巧"><a href="#logcat小技巧" class="headerlink" title="logcat小技巧"></a>logcat小技巧</h3><p>通过adb bugreport抓取log信息.先看zygote是否起来, 再看system_server主线程的运行情况,再看ActivityManager情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">adb logcat -s Zygote</span><br><span class="line">adb logcat -s SystemServer</span><br><span class="line">adb logcat -s SystemServiceManager</span><br><span class="line">adb logcat | grep &quot;1359 1359&quot; &#x2F;&#x2F;system_server情况</span><br><span class="line">adb logcat -s ActivityManager</span><br></pre></td></tr></table></figure>

<p>现场调试命令</p>
<ol>
<li>cat proc/[pid]/stack ==&gt; 查看kernel调用栈</li>
<li>debuggerd -b [pid] ==&gt; 也不可以不带参数-b, 则直接输出到/data/tombstones/目录</li>
<li>kill -3 [pid] ==&gt; 生成/data/anr/traces.txt文件</li>
<li>lsof [pid] ==&gt; 查看进程所打开的文件</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>各大核心进程启动后，都会进入各种对象所相应的main()方法，如下</p>
<h3 id="进程main方法"><a href="#进程main方法" class="headerlink" title="进程main方法"></a>进程main方法</h3><table>
<thead>
<tr>
<th align="left">进程</th>
<th align="left">主方法</th>
</tr>
</thead>
<tbody><tr>
<td align="left">init进程</td>
<td align="left">Init.main()</td>
</tr>
<tr>
<td align="left">zygote进程</td>
<td align="left">ZygoteInit.main()</td>
</tr>
<tr>
<td align="left">app_process进程</td>
<td align="left">RuntimeInit.main()</td>
</tr>
<tr>
<td align="left">system_server进程</td>
<td align="left">SystemServer.main()</td>
</tr>
<tr>
<td align="left">app进程</td>
<td align="left">ActivityThread.main()</td>
</tr>
</tbody></table>
<p>注意app_process进程是指通过/system/bin/app_process启动的进程，且后面跟的参数不带–zygote，即并非启动zygote进程。 比如常见的有通过adb shell方式来执行am,pm等命令，便是这种方式。</p>
<h3 id="重启相关进程"><a href="#重启相关进程" class="headerlink" title="重启相关进程"></a>重启相关进程</h3><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>关于重要进程重启的过程，会触发哪些关联进程重启名单：</p>
<ul>
<li>zygote：触发media、netd以及子进程(包括system_server进程)重启；</li>
<li>system_server: 触发zygote重启;</li>
<li>surfaceflinger：触发zygote重启;</li>
<li>servicemanager: 触发zygote、healthd、media、surfaceflinger、drm重启</li>
</ul>
<p>所以，surfaceflinger,servicemanager,zygote自身以及system_server进程被杀都会触发Zygote重启。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%A6%82%E8%BF%B0/" rel="tag"># Android系统启动概述</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/05/25/Android/Binder/%E4%B8%BA%E4%BB%80%E4%B9%88Android%E8%A6%81%E9%87%87%E7%94%A8Binder%E4%BD%9C%E4%B8%BAIPC%E6%9C%BA%E5%88%B6%EF%BC%9F/" rel="next" title="为什么Android要采用Binder作为IPC机制？">
                <i class="fa fa-chevron-left"></i> 为什么Android要采用Binder作为IPC机制？
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/05/26/Android/Android%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/Activity/startActivity/Android%E8%BF%9B%E7%A8%8B%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B(2)/" rel="prev" title="Android进程创建流程(2)">
                Android进程创建流程(2) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="SOHUCS"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">冯星</p>
              <p class="site-description motion-element" itemprop="description">人生就像是一个马尔可夫链，你的未来取决于你当下正在做的事，而无关于过去做完的事</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7Carchive">
              
                  <span class="site-state-item-count">134</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">36</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">60</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Android系统启动流程"><span class="nav-number">1.</span> <span class="nav-text">Android系统启动流程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#init进程"><span class="nav-number">1.1.</span> <span class="nav-text">init进程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#init-main"><span class="nav-number">1.1.1.</span> <span class="nav-text">init.main()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Zygote自动重启机制"><span class="nav-number">1.1.2.</span> <span class="nav-text">Zygote自动重启机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zygote进程"><span class="nav-number">1.2.</span> <span class="nav-text">Zygote进程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#App-main-main"><span class="nav-number">1.2.1.</span> <span class="nav-text">App_main.main</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AndroidRuntime-start"><span class="nav-number">1.2.2.</span> <span class="nav-text">AndroidRuntime::start</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ZygoteInit-main–Java"><span class="nav-number">1.2.3.</span> <span class="nav-text">ZygoteInit.main–Java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ZygoteInit-preload"><span class="nav-number">1.2.4.</span> <span class="nav-text">ZygoteInit.preload</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ZygoteInit-startSystemServer"><span class="nav-number">1.2.5.</span> <span class="nav-text">ZygoteInit.startSystemServer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ZygoteInit-runSelectLoop"><span class="nav-number">1.2.6.</span> <span class="nav-text">ZygoteInit.runSelectLoop</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#system-server"><span class="nav-number">1.3.</span> <span class="nav-text">system_server</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#handleSystemServerProcess"><span class="nav-number">1.3.1.</span> <span class="nav-text">handleSystemServerProcess</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RuntimeInit-zygoteInit"><span class="nav-number">1.3.2.</span> <span class="nav-text">RuntimeInit.zygoteInit</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Binder线程池启动"><span class="nav-number">1.4.</span> <span class="nav-text">Binder线程池启动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#捕获特殊异常"><span class="nav-number">1.5.</span> <span class="nav-text">捕获特殊异常</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ZygoteInit-main"><span class="nav-number">1.5.1.</span> <span class="nav-text">ZygoteInit.main</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SystemServer-main"><span class="nav-number">1.5.2.</span> <span class="nav-text">SystemServer.main</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SystemServer-run"><span class="nav-number">1.5.3.</span> <span class="nav-text">SystemServer.run</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务启动"><span class="nav-number">1.5.4.</span> <span class="nav-text">服务启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AMS-systemReady"><span class="nav-number">1.5.5.</span> <span class="nav-text">AMS.systemReady</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#app"><span class="nav-number">1.6.</span> <span class="nav-text">app</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ActivityThread-main"><span class="nav-number">1.6.1.</span> <span class="nav-text">ActivityThread.main</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调用栈对比"><span class="nav-number">1.6.2.</span> <span class="nav-text">调用栈对比</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动日志分析"><span class="nav-number">1.7.</span> <span class="nav-text">启动日志分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#before-zygote日志"><span class="nav-number">1.7.1.</span> <span class="nav-text">before zygote日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zygote日志"><span class="nav-number">1.7.2.</span> <span class="nav-text">zygote日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#system-server日志"><span class="nav-number">1.7.3.</span> <span class="nav-text">system_server日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#logcat小技巧"><span class="nav-number">1.7.4.</span> <span class="nav-text">logcat小技巧</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">1.8.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#进程main方法"><span class="nav-number">1.8.1.</span> <span class="nav-text">进程main方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重启相关进程"><span class="nav-number">1.8.2.</span> <span class="nav-text">重启相关进程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#"><span class="nav-number">1.8.2.1.</span> <span class="nav-text"></span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">冯星</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'bbc85MrQ0qhACWJxhCKrJoAj-gzGzoHsz',
        appKey: 'fWH5REKFSsGT4TKe1lWt1ke4',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
